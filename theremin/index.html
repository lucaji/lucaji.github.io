<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>Theremin - Milletgrain</title><meta name="Description" content="indie music artist and producer"><meta property="og:url" content="https://lucaji.github.io/theremin/">
  <meta property="og:site_name" content="Milletgrain">
  <meta property="og:title" content="Theremin">
  <meta property="og:description" content="A mighty Theremin build from an open source project powered by an Arduino UNO.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2013-10-13T00:00:00+00:00">
    <meta property="article:modified_time" content="2013-10-13T00:00:00+00:00">
    <meta property="article:tag" content="Arduino">
    <meta property="article:tag" content="Audio">
    <meta property="og:image" content="https://lucaji.github.io/theremin/theremin-01.jpg">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://lucaji.github.io/theremin/theremin-01.jpg">
  <meta name="twitter:title" content="Theremin">
  <meta name="twitter:description" content="A mighty Theremin build from an open source project powered by an Arduino UNO.">
<meta name="application-name" content="My cool site">
<meta name="apple-mobile-web-app-title" content="My cool site"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://lucaji.github.io/theremin/" /><link rel="prev" href="https://lucaji.github.io/lorena-fontana-a-vision/" /><link rel="next" href="https://lucaji.github.io/back-to-the-future-clock-replica/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.2/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.2/css/all.min.css"></noscript><link rel="preload" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Theremin",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/lucaji.github.io\/theremin\/"
        },"image": [{
                            "@type": "ImageObject",
                            "url": "https:\/\/lucaji.github.io\/theremin\/theremin-01.jpg",
                            "width":  968 ,
                            "height":  644 
                        }],"genre": "posts","keywords": "Arduino, Audio","wordcount":  15396 ,
        "url": "https:\/\/lucaji.github.io\/theremin\/","datePublished": "2013-10-13T00:00:00+00:00","dateModified": "2013-10-13T00:00:00+00:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
            "@type": "Organization",
            "name": "Luca","logo": "https:\/\/lucaji.github.io\/avatar.png"},"author": {
                "@type": "Person",
                "name": "Luca Cipressi"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script>(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Milletgrain"><span class="header-title-pre"><i class='fa-solid fa-pepper-hot' aria-hidden='true'></i></span>milletgrain</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> Posts </a><a class="menu-item" href="/tags/"> Tags </a><a class="menu-item" href="/categories/"> Categories </a><a class="menu-item" href="/dev/" title="Software and Hardware projects"> Dev </a><a class="menu-item" href="https://github.com/lucaji" title="GitHub" rel="noopener noreferrer" target="_blank"><i class='fab fa-github fa-fw' aria-hidden='true'></i>  </a><a class="menu-item" href="https://stackoverflow.com/users/4111774" title="StackOverflow" rel="noopener noreferrer" target="_blank"><i class='fab fa-stack-overflow fa-fw' aria-hidden='true'></i>  </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Search..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Milletgrain"><span class="header-title-pre"><i class='fa-solid fa-pepper-hot' aria-hidden='true'></i></span>milletgrain</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Search..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="/posts/">Posts</a><a class="menu-item" href="/tags/">Tags</a><a class="menu-item" href="/categories/">Categories</a><a class="menu-item" href="/dev/" title="Software and Hardware projects">DevSoftware and Hardware projects</a><a class="menu-item" href="https://github.com/lucaji" title="GitHub" rel="noopener noreferrer" target="_blank"><i class='fab fa-github fa-fw' aria-hidden='true'></i>GitHub</a><a class="menu-item" href="https://stackoverflow.com/users/4111774" title="StackOverflow" rel="noopener noreferrer" target="_blank"><i class='fab fa-stack-overflow fa-fw' aria-hidden='true'></i>StackOverflow</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>Switch Theme</a></div>
    </div>
</header><div class="search-dropdown desktop">
        <div id="search-dropdown-desktop"></div>
    </div>
    <div class="search-dropdown mobile">
        <div id="search-dropdown-mobile"></div>
    </div><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content always-active" id="toc-content-auto"></div>
        </div><article class="page single"><div class="featured-image"><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/theremin/theremin-01.jpg"
        data-srcset="/theremin/theremin-01.jpg, /theremin/theremin-01.jpg 1.5x, /theremin/theremin-01.jpg 2x"
        data-sizes="auto"
        alt="/theremin/theremin-01.jpg"
        title="/theremin/theremin-01.jpg" /></div><div class="single-card" data-image="true"><h1 class="single-title animate__animated animate__flipInX">Theremin</h1><div class="post-meta">
                <div class="post-meta-line"><span class="post-author"><a href="https://lucaji.github.io" title="Author" target="_blank" rel="noopener noreferrer author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>Luca Cipressi</a></span><span class="post-category">included in <a href="/categories/hardware-builds/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>Hardware Builds</a>&nbsp;<a href="/categories/software/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>Software</a>&nbsp;<a href="/categories/electronics/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>Electronics</a></span></div>
                <div class="post-meta-line"><span class="post-publish">
                            <i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i><time datetime="2013-10-13">2013-10-13</time>
                        </span><span class="post-word-count">
                            <i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>15396 words
                        </span><span class="post-reading-time">
                            <i class="far fa-clock fa-fw" aria-hidden="true"></i>73 minutes
                        </span></div>
            </div><div class="details toc" id="toc-static"  data-kept="">
                    <div class="details-summary toc-title">
                        <span>Contents</span>
                        <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                    </div>
                    <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#leon-theremin">Leon Theremin</a>
      <ul>
        <li><a href="#the-sound-of-theremin">The Sound of Theremin</a></li>
        <li><a href="#analog-vs-digital">Analog vs Digital</a></li>
      </ul>
    </li>
    <li><a href="#build-the-em-theremin">Build the EM Theremin</a>
      <ul>
        <li><a href="#this-classic-electronic-instrument-gives-good-vibrations-and-excitations"><em>This classic electronic instrument gives good vibrations and excitations.</em></a>
          <ul>
            <li><a href="#by-robert-moog">By Robert Moog</a></li>
            <li><a href="#overview">OVERVIEW</a></li>
            <li><a href="#antennas">ANTENNAS</a></li>
          </ul>
        </li>
        <li><a href="#cabinet">CABINET</a></li>
        <li><a href="#front-panel">FRONT PANEL</a></li>
        <li><a href="#main-circuit-board">MAIN CIRCUIT BOARD</a></li>
        <li><a href="#antennacircuitboards">ANTENNACIRCUITBOARDS</a></li>
        <li><a href="#checking-it-out">CHECKING IT OUT</a></li>
        <li><a href="#tuning">TUNING</a></li>
        <li><a href="#playing-the-theremin">PLAYING THE THEREMIN</a></li>
      </ul>
    </li>
    <li><a href="#sinewave-look-up-table">Sinewave look-up table</a>
      <ul>
        <li><a href="#using-polinomials">Using polinomials</a></li>
      </ul>
    </li>
    <li><a href="#fun-with-sinusoids">Fun with sinusoids</a>
      <ul>
        <li><a href="#an-optimized-lut-implementation">An Optimized LUT Implementation</a></li>
        <li><a href="#an-optimised-lut-in-c">An Optimised LUT in C</a></li>
        <li><a href="#piecewise-polynomial-approximation">Piecewise Polynomial Approximation</a></li>
        <li><a href="#almost-branch-free-integer-implementation">(Almost) Branch-Free Integer Implementation</a></li>
        <li><a href="#i86-assembly-version">i86 Assembly Version</a></li>
        <li><a href="#16-bit-branch-free-implementation">16 bit Branch Free Implementation</a></li>
        <li><a href="#floating-point-implementation">Floating-Point Implementation</a></li>
        <li><a href="#another-branch-free-integer-approximation">Another Branch Free Integer Approximation</a></li>
        <li><a href="#a-6th-order-piecewise-polynomial-approximation">A 6th Order Piecewise Polynomial Approximation</a></li>
        <li><a href="#iterative-methods">Iterative Methods</a></li>
        <li><a href="#recursive-fm">Recursive FM</a></li>
        <li><a href="#related-resources">Related Resources</a></li>
        <li><a href="#acknowledgments">acknowledgments</a></li>
        <li><a href="#simple-sse-and-sse2-and-now-neon-optimized-sin-cos-log-and-exp">Simple SSE and SSE2 (and now NEON) optimized sin, cos, log and exp</a>
          <ul>
            <li><a href="#the-story">The story</a></li>
          </ul>
        </li>
        <li><a href="#sse-test">sse test</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
                </div><div class="content" id="content"><p>A mighty Theremin build from an open source project powered by an Arduino UNO.</p>
<h1 id="leon-theremin">Leon Theremin</h1>
<p>The theremin is an electronic musical instrument controlled without physical contact by the performer. It is named after its inventor, <a href="https://en.wikipedia.org/wiki/Leon_Theremin" target="_blank" rel="noopener noreferrer ">Leon Theremin</a>, who patented the device in 1928.</p>
<p>It was the first electric musical instrument ever made. Like all the greatest invention, it was born while proximity sensors research gone wild :)</p>
<p>One morning I stumbled across the <a href="https://www.gaudi.ch/OpenTheremin/" target="_blank" rel="noopener noreferrer ">OpenTheremin</a> project and I ordered immediately one.</p>
<p>They design and produce Arduino compatible theremin shields with two oscillators as you can control both tone and volume.
I entered the theremin’s world and found it fashinating. And made my first attempt at it:</p>
<figure><img src="/theremin/theremin-01.jpg"><figcaption>
      <h4>Theremin</h4>
    </figcaption>
</figure>

<h2 id="the-sound-of-theremin">The Sound of Theremin</h2>
<blockquote>
<p>Schonberg described the sound of the theremin as
&ldquo;a cello lost in a dense fog, crying because it does not know how to get home.&rdquo;</p></blockquote>
<p>The sound of the Theremin is indeed <strong>eerie</strong> and ethereal. It has been used in movies such as:</p>
<ul>
<li>Miklós Rózsa&rsquo;s Spellbound and The Lost Weekend</li>
<li>Bernard Herrmann&rsquo;s The Day the Earth Stood Still</li>
<li>Justin Hurwitz&rsquo;s First Man</li>
</ul>
<p>as well as in theme songs for television shows such as the ITV drama Midsomer Murders and the Disney+ series Loki, the latter composed by Natalie Holt.
The theremin is also used in concert music (especially avant-garde and 20th- and 21st-century new music) and in popular music genres such as rock.</p>
<ul>
<li><a href="https://www.youtube.com/watch?v=apBWI6xrbLY" target="_blank" rel="noopener noreferrer ">Beach Boys - Good Vibrations</a></li>
<li><a href="https://www.youtube.com/watch?v=ZnTLZtZzrWU" target="_blank" rel="noopener noreferrer ">The Big Bang Theory - Sheldon Playing the Theremin</a></li>
<li><a href="https://www.youtube.com/watch?v=HNJKKVpj7Fc" target="_blank" rel="noopener noreferrer ">Theremin - An Electronic Odissey</a> Documentary</li>
</ul>
<h2 id="analog-vs-digital">Analog vs Digital</h2>
<p>The original Theremin was a completely analog apparatus. Being built in the late 1920s, it was very heavy, bulky and used vacuum tubes and very archaic components to generate its two carriers for pitch and volume that were transferred to metal antennas. Probably the latter are the only same component stayed since the original prototypes: the antennas.</p>
<p>It generates two carrier frequencies around 300kHz, slightly displaced each other to avoid cross-modulation and interference. By waving the hands in thin air just near the antennas, the oscillator frequencies are being altered, due to capacitive effects of the body. The internal circuitry then, derives a voltage proportional to the distance from each antennas which, in turn, drives a VCO and a VCA.
These two acronyms, still existing today in modern synths stand for:</p>
<ul>
<li>Voltage Controlled Oscillator - able to change its generated frequency via a control voltage.</li>
<li>Voltage Controlled Amplifier - able to change its gain via a control voltage.</li>
</ul>
<p>This consistent duality permits the executor to change pitch and amplitude indipendently, giving maximum expressiveness to the execution.
The timbre, given by the VCO waveform directly by its shape, can be customized. But usually a sine-wave-like has always been used due to its &ldquo;ethereal&rdquo; appeal.</p>
<p>The most famous</p>
<p>I went through this paper from Robert Moog:</p>
<h1 id="build-the-em-theremin">Build the EM Theremin</h1>
<h2 id="this-classic-electronic-instrument-gives-good-vibrations-and-excitations"><em>This classic electronic instrument gives good vibrations and excitations.</em></h2>
<h3 id="by-robert-moog">By Robert Moog</h3>
<p>Most electronic musical instruments are sonic chameleons that try to sound like a wide variety of other things. However, there is one electronic instrument that makes no apologies for its single, immediately recognizable sound: the theremin. This monophonic instrument has added its distinctive, melodic character to the scores of many horror and suspense movies and made its pop debut on the Beach Boys&rsquo; &ldquo;Good Vibrations.&rdquo; It has also appeared on many concert stages, including Carnegie Hall.
The theremin was named after its inventor, Russian physicist and musician <em>Leon Theremin</em>, who developed the instrument in the 1920s. Unlike most musical instruments, the theremin is played with absolutely no physical contact. Players wave their hands in the air near two antennas. As one hand gets closer to the straight vertical tube (called the <em>pitch antenna</em>), the pitch rises; as the other hand gets closer to the horizontal tubular loop (called the volume antenna), the volume decreases. Because the theremin&rsquo;s pitch and volume are intimately tied to the player&rsquo;s hand motions, the tone has a vibrant, wavering quality, not unlike a human voice or a violin.
Among the requests for DIY projects that EM receives, by far the most common is a do-it-yourself theremin. The instrument presented here is an authentic theremin, with antenna response characteristics, pitch range, and tone color that closely emulate Leon Theremin&rsquo;s original designs. However, it is reasonably easy to build. It uses currently available components and materials that you can buy at your local hardware store or from mail-order electronic-parts distributors. If you know how to read a schematic diagram, solder, and use a voltmeter, and if you&rsquo;re comfortable with basic home tools, you should be able to build and adjust this theremin.</p>
<h3 id="overview">OVERVIEW</h3>
<p>When you bring your hand near a theremin antenna, you are actually forming a variable capacitor: the antenna is one &ldquo;plate&rdquo; and your hand is the other. With the high frequencies and very low currents used by the instrument, your hand is effectively grounded by being attached to your body, so the antenna and your hand form a variable capacitor to ground. This variable capacitance is called <em>hand capacitance</em>. You increase the hand capacitance by bringing your hand nearer to the antenna. During normal operation, the hand capacitance is less than one picofarad, which is a very small capacitance indeed!
Each antenna forms a resonant circuit with a group of inductors collectively called an antenna coil. In this design, the resonant frequencies are about 260 kHz for the pitch antenna and about 450 kHz for the volume antenna. At or near the resonant frequency, a tiny change in hand capacitance results in a larger change in the impedance of the antenna circuit as a whole.
Refer to Figure 1, the functional block diagram</p>
<figure><img src="/theremin/theremin-fig01.jpg"><figcaption>
      <h4>Block Diagram</h4>
    </figcaption>
</figure>

<p>and Figure 2, the schematic diagram of the entire circuit:</p>
<figure><img src="/theremin/theremin-fig02.jpg"><figcaption>
      <h4>Schematic</h4>
    </figcaption>
</figure>

<p>The <em>variable-pitch oscillator</em> (VPO), <em>fixed-pitch oscillator</em> (FPO), and <em>detector</em> sections form a <em>beat-frequency oscillator</em>. Q1, Q2, and their associated components constitute the VPO, the frequency of which is set slightly higher than the resonant frequency of the pitch-antenna circuit (established by adjusting L5). As a player brings a hand near the pitch antenna, the changing impedance of the pitch antenna circuit lowers the VPO frequency by about 3 kHz.
Q3, Q4, and their associated components form the FPO, the frequency of which is set equal to the VPO frequency (by adjusting L6) when the player&rsquo;s hand is away from the pitch antenna. The difference, or beat, frequency is extracted by the detector and appears as an audio waveform at the junction of R23 and R24. As the player brings a hand near the pitch antenna, the frequency of the audio waveform goes from 0 to about 3 kHz (31⁄2 octaves above middle C).
Q5 and its associated components constitute the <em>pitch-tuning circuit</em>. This circuit presents a variable active impedance that is used to make fine adjustments to the FPO frequency while the instrument is being played. Front panel potentiometer P1 adjusts the current through Q5, thereby changing its active impedance.
Q6, Q7, and their associated components form the volume oscillator. Its frequency is set slightly higher than the resonant frequency of the <em>volume-antenna circuit</em> by adjusting L11. As the player brings a hand near the volume antenna, the resonant frequency of the volume-antenna circuit is lowered, and the DC voltage appearing at the junction of D1 and C12 is reduced. The resulting current flowing through R14 is amplified and level-shifted by the VCA processor section (U3-B and associated components) and then fed through R30 to control the gain of the voltage-controlled amplifier (U3-A and associated components). The amplitude-controlled audio output is then fed to front-panel jack J1. The maximum level is about 0 dBm (0.8V RMS).
Q8 and its associated components constitute the volume-tuning circuit, which is nearly identical to the pitchtuning circuit. Potentiometer P2 is used to make fine adjustments to the volume-oscillator frequency during performance.
The audio waveform is applied to pin 3 of U3-A at a level high enough to clip it. This has the effect of reshaping the waveform from a skewed sine to a quasi-rectangular wave, which is very similar to
the waveform of Professor Theremin&rsquo;s original instruments. P3 varies the input resistance of U3-A, which influences the amount by which the audio waveform is clipped. P4 shifts the bias at the input of U3-A, which changes the waveform width and therefore the output&rsquo;s harmonic spectrum. C24 and C26 roll off the high-frequency harmonics to produce a pleasant, cello-like tonal balance.</p>
<h3 id="antennas">ANTENNAS</h3>
<p>Making the antennas can be tricky. They should be metallic, rugged, attractively finished, capable of being rigidly mounted, and easy to fabricate by a home hobbyist. I have found that 3/8-inch soft copper tubing of the sort that plumbers use with bathroom sinks works well. You can buy preplated, straight, short pieces at your local builders&rsquo; supply or hardware store. You can also purchase a simple tubing bender that will allow you to bend the volume antenna by hand without collapsing the tubing. You&rsquo;ll also need a tubing cutter or hacksaw to cut the tubing to length.
The finished pitch antenna is a straight, vertical tube eighteen inches long and 3/8 inch in diameter, and the finished volume antenna is a horizontal, hairpin loop with a total length of nine inches. The ends of the volume antenna should be separated by 31⁄4
inches, center to center.
I suggest you make the antennas longer than necessary and then cut them to length after they&rsquo;re formed and stiffened (discussed shortly). Start with a straight, 24- or 36-inch length of tubing for each antenna. To form the volume antenna, slip the tubing bender over the tube. Then, starting ,at the midpoint of the tube, bend it into a semicircular curve. Hold the tube in both hands and push into the curve with your thumbs while pulling down with your other fingers. Doublecheck to make sure that the two ends of the volume antenna are parallel and are the correct distance apart.
Copper tubing has one drawback: because copper is soft enough to bend by hand, it is easy to put unwanted kinks in the tubing after it has been formed. You can stiffen the antennas by filling them with polyester resin (the liquid plus-hardener type used to repair car bodies) after you&rsquo;ve formed them. This is not particularly difficult, but the potential for making a mess is significant, so be sure you have plenty of time and you&rsquo;re at peace with the world.
The pitch antenna is straight because this configuration is more sensitive to changing hand position when the hand is farther away and less sensitive when the hand is close. The change in hand capacitance is extremely small when the hand is far away, and the change in pitch as a function of distance must be as uniform as possible.
The volume antenna is looped because this configuration is less sensitive when the hand is far away and more sensitive when the hand is close. This gives you greater control over the low end of the dynamic range and lets you articulate notes by quickly dipping your left hand into the loop (more in a moment)
The two antennas are perpendicular to each other to minimize the interaction between them. For example, as you move your left hand tip and down above the volume antenna, its motion is parallel to the pitch antenna, which causes little or no change in pitch.</p>
<h2 id="cabinet">CABINET</h2>
<p>The entire cabinet is made of wood. Except for the front panel, large metal cabinet parts should not be used, as they may add unnecessary capacitance to the antennas. My materials of choice are hardwood plywood for the top and solid hardwood for the rest of the cabinet because they are rugged, easy to shape accurately, and can be attractively finished.
The enclosure consists of a base and cover (see Fig. 3). The cover should fit snugly over the base. You may fasten the pieces together with any combination of nails, wood screws, and wood glue, depending on how you like to put cabinets together. After the cabinet parts have been assembled, sand them down well and finish them with the wood finish of your choice, except metallic paint.
The antenna sockets are regular tube-to-pipe connectors that you can get when you buy the copper tubing for the antennas. The volume-antenna sockets are straight 3/8-inch-tube-to-3/8- inch-male-pipe connectors, whereas the pitch-antenna socket is a right-angle, 3/8-inch-tube-to-3/8-inch-male-pipe elbow. Drill 3/8-inch holes for these fittings; then screw them in by hand. If you can&rsquo;t screw the 3/8-inch pipe threads into the wood by hand, don&rsquo;t force it by using a pipe wrench: you may split the wood. Instead, enlarge the hole slightly with a large round file or a 3/8-inch pipe tap.
Once you&rsquo;re sure you can screw in the pipe fittings by hand, unscrew them, put a small amount of epoxy on the threads, and reinsert them by hand. Before the epoxy hardens, verify that the pitch-antenna socket is vertical by inserting the pitch antenna into the socket and adjusting the position of the socket as necessary.
Two 4/4-inch X 3/4-inch blocks and one microphone-stand mounting flange are attached to the bottom of the enclosure. This lets you set the finished unit on a microphone stand (preferred) or on a wood (not metal) table when you play it.</p>
<h2 id="front-panel">FRONT PANEL</h2>
<p>The front panel should be made of 1/16-inch sheet aluminum. It should be about nine inches long and should have bends at the top and bottom for mounting and stiffening. You can either cut and bend the panel yourself or have your local sheet-metal shop do it for you. Alternatively, you can buy a blank, single-space (1U) rack panel, which is 13⁄4 inches high by nineteen inches wide, cut it to length with a hacksaw, and attach the panel to the base from the front instead of from the bottom. However, that will leave a 1/4-inch gap between the top of the panel and the enclosure cover.
Four rotary potentiometers, one 1/4-inch phone jack, one 1/8-inch mini-jack, and one toggle switch are mounted on the front panel. The two tuning pots should be located in the left part of the panel so your hand is as far from the pitch antenna as possible when You tune the antennas. Use high-quality, full-size rotary pots and large-diameter knobs for PI and P2, P3 and P4 are less critical; these pots can be miniature, and the knobs can be small. I suggest you use an insulated, 1/4-inch jack for J1 to avoid a ground loop between the audio and power grounds.
Eight single-conductor wires and one shielded wire connect the front-panel components to the main circuit board, I suggest you use a connector for these wires so Von can unplug the panel if you need to work on the main circuit board. Prototyping boards often have provisions for mounting a DB15 or DB25 connector.</p>
<h2 id="main-circuit-board">MAIN CIRCUIT BOARD</h2>
<p>All circuitry (except the antenna circuits and front-panel components) is mounted on one circuit board (see Fig. 4). A plug-in prototyping board of the sort used to assemble computer I/O circuits provides the space, connection provisions, and solidity you need. Radio Shack&rsquo;s prototyping board (catalog #276-1598) provides ample space for all the circuitry with extra room to try your own modifications.
The theremin&rsquo;s power is supplied by a ±12 VAC wall wart, which is widely available (see sidebar &ldquo;Where to Get Parts and Materials&rdquo;). The AC voltage is converted into DC by two voltage regulators (UT, U2, and associated components). Keep the power-supply circuit components as close together as possible, and keep connections as short as you can. Be really sure that that C20 and C22 are very close to U2. The negative side of C19 and the positive side of C20 should be connected together with a very short lead, and the grounded side of J2 should also be connected to this lead. The voltage regulators are less likely to oscillate if the connections are kept as short as possible.
Be sure to separate the VPO from the FPO by a couple of inches. These oscillators are already lightly coupled through C2 and C6, so they tend to synchronize at low beat frequencies (which is desirable). Placing the oscillator circuits close together increases the coupling, which may result in an excessive tendency to synchronize. In addition, place C4, C8, and C13 very close to the oscillator circuits with which they are associated to maximize the decoupling.
After the main board is assembled and checked, brush the solder side with a small wire brush and inspect for unwanted solder bridges, wiring mistakes, and weak solder joints. Then set the board in the middle of the cabinet base in preparation for final test and tuning.</p>
<h2 id="antennacircuitboards">ANTENNACIRCUITBOARDS</h2>
<p>The inductors and other antenna-circuit components are mounted on two separate, small circuit boards with little or no copper circuit pattern. LI through L4 are mounted on the pitch-antenna circuit board (see Fig. 4). Position the inductors so they are parallel to one another and about one inch apart, center to center. The inductors are not polarized per se, but each terminal is distinct: one emerges from the center of the coil and the other emerges from the outer layer of the coil. Arbitrarily select one terminal as the beginning and the other as the end, and connect the inductors in series so the end of one inductor is connected to the beginning of the next.
Position the board on the base next to the pitch antenna. The free end of L4 should be close to the main circuit board, and the free end of Ll should be close to the pitch-antenna socket.
Connect a short wire from the free end
of LI to the pitch-antenna socket using a heavy soldering iron or by drilling and tapping a hole for a 4-40 thread and then mounting a solder lug.
L7 through L10, DI, C12, and R14 are mounted on the volume-antenna circuit board (see Fig. 4). As with the pitch-antenna circuit, position the inductors so they are parallel to one another, about an inch apart, and connected so the windings are end to beginning. Position the board near the volume antenna, and install wires to connect the free end of L10 to the volume-antenna socket. In addition, connect the junction of L7 and C12 to the junction of C14 and C15, and connect the free end of R14 to pin 13 of U3.</p>
<h2 id="checking-it-out">CHECKING IT OUT</h2>
<p>After you&rsquo;ve assembled and cleaned the main board, take a deep breath and check all your connections again. Look for shorts, mistakes, missing connec-
tions, etc. Then connect the front panel to the main board, plug in the power supply, and turn the power switch on.
Use a voltmeter to check the voltages at the inputs and outputs of U1 and U2 (see Fig. 2). Then check the DC voltages at the collectors of Q1 through Q8 (they should all be about +12V); the emitters of Q1 through Q4, Q6, and Q7 (about 0.6V); and the emitters of Q5 and Q8 (about -2.6V). If you don&rsquo;t observe all these readings, check everything until you find the problem.
Next, verify that all three oscillators are working. Read the AC voltages across L5, L6, and L1 I. If you read about 10 VAC, then the corresponding oscillator is producing a waveform. If you don&rsquo;t read any voltage at all, the oscillator is not working. To check the detector, measure the DC voltage across R24. If it&rsquo;s -0.5V or so, the detector is working.
Temporarily connect a pair of headphones or a small powered speaker across R24. Turn the tuning slugs in L5 and L6 counterclockwise until the tops of the slugs hit the shield cans. Be careful. Do not force the slugs farther than they want to go! Turn L5 exactly two turns clockwise. Then turn L6 clockwise slowly until you hear a high-pitched whistle. Keep turning until the tone is in the mid range (about I kHz). Now, turn P1 in either direction. You should hear the pitch change markedly. If you observe all these things, then the entire beat-frequency oscillator circuit is in good shape.
To check the VCA, temporarily connect pin 12 of U3 to ground. (This should turn on the VCA.) Connect your headphones or monitor amp across R34. You should hear a somewhat louder tone. Now, disconnect the temporary ground connection to pin 12 of U3, and connect that pin to -12V. The audio across R34 should disappear. If it does, the VCA is working properly.
While pin 12 of U3 is connected to ground, you can also check the Brightness and Waveform controls (P3 and P4). Use the Pitch Tuning control (PI) to set the tone&rsquo;s pitch to approximately middle C. Then turn the Brightness and Waveform controls. The Brightness control should change the sound from muted to bright, and the Waveform control should change the sound from “reedy” (narrow waveform) to “full” (wider waveform). After you have checked all of these controls, remove the temporary connection to pin 12 of U3.</p>
<h2 id="tuning">TUNING</h2>
<p>Before tuning, clean off your workbench and move aside any large, conductive objects such as desk lamps and test gear. Leave a clear space of two or three feet around your work area. Place the cabinet base in the middle of the cleared space, put the pitch antenna in place, and connect the pitch-antenna circuit board between the antenna and the main board. On the main board, temporarily connect pin 12 of U3 to ground and connect the instrument&rsquo;s audio output to headphones or a monitor amplifier. Now follow these steps to adjust L5 and L6:</p>
<ol>
<li>Set PI (the Pitch Tuning control) to its middle position.</li>
<li>Grasp and hold the pitch antenna with one hand. With the other hand, adjust L6 until the beat frequency is zero, Then carefully turn L6 counter-clockwise until you hear a pitch of about 3 kHz (3 1⁄2 octaves above middle C). 3. Let go of the pitch antenna. Slowly
retract your hand from the vicinity of the antenna. You should hear the pitch go down.</li>
<li>If the pitch does not go down to zero when you&rsquo;ve retracted your hand completely and stepped back, the inductance of L5 is set too high. Advance the slug in L5 clockwise by a small amount, perhaps 1/10 turn or so, and repeat steps 2 and 3.</li>
<li>If the pitch goes to zero and then begins to ascend as you retract your hand, the inductance of L5 is set too low. Turn the slug in L5 counterclock-wise by a small amount, and repeat steps 2 and 3.</li>
<li>If the pitch jumps abruptly as you retract your hand, the inductance of L5 is set far too low. Turn the slug in L5 counterclockwise approximately a quarter-turn and repeat steps 2 and 3.
Eventually, you will converge on the proper settings for L5 and L6. The idea is to find the settings at which the frequency (a) is zero when you&rsquo;ve stepped away from the theremin, (b) begins to ascend when your body is about two feet from the pitch antenna, and (c) reaches about 3 kHz when your hand touches the pitch antenna. Tap lightly on L5 and L6 as you converge on the proper settings, which will stabilize the tuning-slug positions.
This completes the tuning of the pitch oscillators. In performance, the exact tuning is established by adjusting the pitch-tuning control (P1).
Now, remove the temporary ground connection to pin 12 of U3. Connect a voltmeter from pin 12 of U3 to ground, install the volume antenna, and connect the volume-antenna circuit card between the antenna and the main board. Follow these steps to adjust L11:</li>
<li>Set P2 to its mid position.</li>
<li>Carefully turn the slug in L11 counterclockwise until it is out as far as it will go. The meter should read about -12V.</li>
<li>Slowly turn the slug clockwise. At some point, you will see the voltage begin to rise from -12V. Stop when the voltage passes through 0 and becomes positive, At this point, bringing your hand near the volume antenna lowers the voltage; the meter should read about -12V when your hand is two or three inches from the volume antenna.
This completes the tuning of the volume oscillator. In performance, the exact volume is established by adjusting the volume-tuning control (P2).</li>
</ol>
<h2 id="playing-the-theremin">PLAYING THE THEREMIN</h2>
<p>You are now ready to try your theremin. Place the instrument (with antennas installed) on a microphone stand that is set about 40 inches high. Connect a small monitor amplifier and speaker to J I and the 12 VAC wall-wart power adapter to J2. Turn on SW1 and touch the pitch antenna. Set P2 so the tone is loud when your left hand is well away from the volume antenna and the volume begins to decrease noticeably when your left hand is brought within ten to twelve inches of the volume antenna. Then set PI so the frequency is zero when your right hand is well away from the pitch antenna and the tone becomes apparent when you bring your right hand within 18 to 24 inches of the pitch antenna. Your instrument is now ready to play.
As with any expressive musical instrument, playing the theremin takes some practice. You can start by follow-ing these simple exercises:</p>
<ol>
<li>Stand slightly left of the center of
the instrument with your right shoulder about 24 inches from the pitch antenna. Relax your wrists. Think of a note and hum it to yourself. Then move your right hand toward the pitch antenna until the theremin pitch coincides with the pitch you&rsquo;re humming. Now hold the note. This is not as easy as it sounds, but it&rsquo;s an important technique to learn. At first, you will find it difficult to stand still, but a few hours of practice will work wonders.</li>
<li>Hum two different notes, one after the other. Find the first note on the theremin, hold it, and then slowly glide to the second note.</li>
<li>Repeat the above exercise, but bring your left hand near the volume antenna while your right hand glides from one note to the next. Move the left hand slowly at first and then more rapidly as you learn to move your left hand independently of your right hand. This exercise teaches you to &ldquo;feel&rdquo; where the notes are and to impart expressive dynamics.</li>
<li>While playing a note, introduce vibrato by moving your right hand back and forth from your wrist several times a second. Concentrate on making the vibrato even and steady.
These exercises address the basic skills of theremin playing: finding notes, playing intervals, articulating notes, and introducing vibrato. With these basic skills, you can play slow melodies. Practicing regular scales and arpeggios will increase your proficiency. Focus on accuracy of pitch and precise control of dynamics.
Once you&rsquo;ve mastered the basic moves, it&rsquo;s time to develop your own style. Pay particular attention to shaping envelopes and dynamics with your left hand. The left hand can also be used to articulate discrete notes by momentarily dipping into the volume antenna as the right hand quickly moves from one pitch to another. Try combining audible glides and discrete pitch changes within a musical phrase. In addition, avoid constant vibrato in the right hand. Instead, impart expressive nuance by shaping the amount and rate of vibrato. These considerations are important components of theremin musicianship.
The theremin presented here is designed to meet the needs of musicians who wish to explore the artistic resources of this unique instrument. Build your instrument carefully, and it will provide many years of reliable service. Practice with diligence, and you will provide enjoyable music for yourself and your audiences. Finally, be sure to give an occasional thought to the spirit of Leon Theremin, to whom we owe so much.</li>
</ol>
<p>Robert Moog was a pioneer in the early development of commercial synthesizers and currently serves as Grand Poobah of Big Briar, Inc.</p>
<h1 id="sinewave-look-up-table">Sinewave look-up table</h1>
<p>The following section quotes talks about generating a sine-wave by look-up table.
This is useful for the OpenTheremin version, where the wave is defined by a generated LUT.</p>
<p>by Olli Niemitalo Posted on 2010-03-05</p>
<p>Here is a method for generating a sine look-up table in case you have little (a few kilobytes of) program memory. The idea goes like this: Let&rsquo;s say you have a sine wave lookup table of length 1024 with a 24-bit amplitude range. If you take the difference between successive samples, the range of the numbers is reduced. If you repeat the process a total of 3 times, the data will be dominated by the 3rd differential of the quantization noise and will have a range of -4 to 3, which can be conveniently stored in 3 bits only. This program below does the reverse, it generates the sine table from the 3-bit values, and also takes advantage of the symmetry properties of sine. So, instead of wasting 1024 program memory words for storing the original sine table, in the c-language implementation below, the compressed data takes only 35 24-bit words and the decompression code hopefully not too much more.</p>
<div class="code-block code-line-numbers" style="counter-reset: code-block 0">
    <div class="code-header language-">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">/*</span> <span class="n">Multiplierless</span> <span class="mi">1024</span><span class="o">-</span><span class="n">sample</span><span class="p">,</span> <span class="mi">24</span><span class="o">-</span><span class="n">bit</span> <span class="n">sine</span> <span class="n">table</span> <span class="n">generator</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">by</span> <span class="n">Olli</span> <span class="n">Niemitalo</span> <span class="ow">in</span> <span class="mi">2010</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mf">07.</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">This</span> <span class="n">work</span> <span class="n">is</span> <span class="n">placed</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">public</span> <span class="n">domain</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"> <span class="o">*/</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1">#include &lt;stdio.h&gt;;</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="o">/*</span> <span class="n">Sine</span> <span class="n">table</span> <span class="n">with</span> <span class="n">one</span> <span class="n">extra</span> <span class="n">sample</span> <span class="n">to</span> <span class="n">enable</span> <span class="n">interpolation</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">Sine</span> <span class="n">with</span> <span class="n">amplitude</span> <span class="o">-</span><span class="mh">0x800000</span> <span class="o">..</span> <span class="mh">0x800000</span> <span class="n">was</span> <span class="n">rounded</span> <span class="n">to</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">nearest</span> <span class="n">integer</span> <span class="ow">and</span> <span class="n">truncated</span> <span class="n">to</span> <span class="o">-</span><span class="mh">0x800000</span> <span class="o">..</span> <span class="mh">0x7fffff</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="ne">int</span> <span class="n">data</span> <span class="n">type</span> <span class="n">must</span> <span class="n">be</span> <span class="n">at</span> <span class="n">least</span> <span class="mi">24</span><span class="o">-</span><span class="n">bit</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"> <span class="o">*/</span>
</span></span><span class="line"><span class="cl"><span class="ne">int</span> <span class="n">sineTable</span><span class="p">[</span><span class="mi">1025</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="n">void</span> <span class="n">generateTable</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="ne">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="ne">int</span> <span class="n">magic</span><span class="p">[</span><span class="mi">33</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x691864</span><span class="p">,</span> <span class="mh">0x622299</span><span class="p">,</span> <span class="mh">0x2CB61A</span><span class="p">,</span> <span class="mh">0x461622</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x62165A</span><span class="p">,</span> <span class="mh">0x85965A</span><span class="p">,</span> <span class="mh">0x0D3459</span><span class="p">,</span> <span class="mh">0x65B10C</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x50B2D2</span><span class="p">,</span> <span class="mh">0x4622D9</span><span class="p">,</span> <span class="mh">0x88C45B</span><span class="p">,</span> <span class="mh">0x461828</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x6616CC</span><span class="p">,</span> <span class="mh">0x6CC2DA</span><span class="p">,</span> <span class="mh">0x512543</span><span class="p">,</span> <span class="mh">0x65B69A</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x6D98CC</span><span class="p">,</span> <span class="mh">0x4DB50B</span><span class="p">,</span> <span class="mh">0x86350C</span><span class="p">,</span> <span class="mh">0x7136A2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x6A974B</span><span class="p">,</span> <span class="mh">0x6D531B</span><span class="p">,</span> <span class="mh">0x70D514</span><span class="p">,</span> <span class="mh">0x4EA714</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x5156A4</span><span class="p">,</span> <span class="mh">0x393A9D</span><span class="p">,</span> <span class="mh">0x714A6C</span><span class="p">,</span> <span class="mh">0x755555</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x5246EB</span><span class="p">,</span> <span class="mh">0x916556</span><span class="p">,</span> <span class="mh">0x7245CD</span><span class="p">,</span> <span class="mh">0xB4F3CE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x6DBC7A</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">33</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">24</span><span class="p">;</span> <span class="n">j</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">sineTable</span><span class="p">[</span><span class="n">k</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">magic</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">j</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">sineTable</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">51472</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="mi">256</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">k</span> <span class="o">=</span> <span class="n">sineTable</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">      <span class="n">sineTable</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span> <span class="o">+</span> <span class="n">sineTable</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">      <span class="n">sineTable</span><span class="p">[</span><span class="mi">513</span><span class="o">-</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">sineTable</span><span class="p">[</span><span class="mi">511</span><span class="o">+</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">k</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">sineTable</span><span class="p">[</span><span class="mi">1025</span><span class="o">-</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">k</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">sineTable</span><span class="p">[</span><span class="mi">768</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mh">0x800000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="ne">int</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="ne">int</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">  <span class="n">generateTable</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">  <span class="o">/*</span> <span class="n">Printout</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1025</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%d</span><span class="se">\t</span><span class="si">%d</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">sineTable</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div></div>
<p>Here is a spreadsheet that illustrates the algorithm: sinetable.xls. [T.B.D.]</p>
<p>The above implementation additionally embeds the seeds 0 and -3 in the magic data</p>
<h2 id="using-polinomials">Using polinomials</h2>
<p>(a comment to the above article)</p>
<p>Michel Rouzic says:
2014-11-15 at 18:34</p>
<p>I have another solution. You know how you can approximate the cosine/sine using polynomials? And how every time you halve the range your polynomial covers you multiply the precision by 2^(degree of the polynomial + 1)? So you got your x = [0, 2^32-1] input that represents the angle in turns, do the symmetry thing to turn it into a value in the first quadrant, take the top N bits, use them as the index for your array of polynomial coefficients, compute the polynomial by doing (((c2 * xl &raquo; fmt) + c1) * xl &raquo; fmt) + c0; (for quadratic approximations), change the sign depending on the input quadrant, and there’s your result!</p>
<p>If you go with quadratic approximations and 32 segments then you only need a 384 byte pre-computed table (32 segments, 3 coefficients per segment, coefficients are 32 bits) and you get max error of 1/1,450,000 (-123 dB), and on a modern computer it runs in about 15 cycles (I don’t use symmetry so it goes even faster). You can save more memory using a smaller table (at the cost of a max of 8x precision for each 2x decrement) or using higher degree polynomials (at the expense of CPU time).</p>
<p>Olli Niemitalo says:
2015-02-20 at 15:30</p>
<p>Michel, I believe your performance figures, they sound very plausible. Here’s more on using polynomials for sin cos generation: <a href="http://www.rossbencina.com/code/sinusoids" target="_blank" rel="noopener noreferrer ">http://www.rossbencina.com/code/sinusoids</a></p>
<h1 id="fun-with-sinusoids">Fun with sinusoids</h1>
<blockquote>
<p><a href="http://www.rossbencina.com/code/sinusoids" target="_blank" rel="noopener noreferrer ">http://www.rossbencina.com/code/sinusoids</a></p></blockquote>
<p>Introduction</p>
<p>I’ve liked sinusoids for a long time. This is a place where I’m going to write about them.</p>
<p>This page initially came about while investigating efficient implementations of Ollie Niemitalo’s parabolic sin(x) approximation (see below.) At the moment it’s a bit disorganised, but perhaps you will find something of interest here.
Performance Measurement Methodology</p>
<p>The perfomance measurements shown below were conducted under strict unscientific conditions with no third-party validation at our secret labs in Tierra Del Fuego. The measurements are stated in machine cycles and were performed with MSVC on a PIII/550.
Approximations</p>
<p>There are quite a few ways to approximate sinusoids: Taylor polynomials, CORDIC, iterative methods, lookup tables, just to name a few. I’m building up a catalog of some of these below. It’s not finished yet.</p>
<p>Joakim Dahlström has kindly contributed a Java applet which allows you to visually explore various sinusoidal approximations and their parameters.
Look Up Tables (LUTs)</p>
<p>Look-up tables are commonly used for generating all sorts of functions which are expensive to calculate on the fly. The general idea is that values are pre-calculated and stored in an array so they can be “looked up” later. In this case we are concerned with storing values of sin(x) in a lookup table.</p>
<p>Variants on the look up table use interpolation to approximate values “in the gaps” between the values stored in the table. The simplest form of interpolation is linear interpolation, which interpolates along a line between adjacent points.</p>
<p>Both the size of the lookup table, and the method of interpolation effect the quality of the approximation. Below are the spectra of sine waves generated using look up tables of different table sizes with no interpolation and with linear interpolation.</p>
<p><figure><a class="lightgallery" href="/theremin/sin_128_float32_no_interp.gif" title="/theremin/sin_128_float32_no_interp.gif" data-thumbnail="/theremin/sin_128_float32_no_interp.gif" data-sub-html="<h2>128 point lookup table, no interpolation</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/theremin/sin_128_float32_no_interp.gif"
            data-srcset="/theremin/sin_128_float32_no_interp.gif, /theremin/sin_128_float32_no_interp.gif 1.5x, /theremin/sin_128_float32_no_interp.gif 2x"
            data-sizes="auto"
            alt="/theremin/sin_128_float32_no_interp.gif" width="594" height="269" />
    </a><figcaption class="image-caption">128 point lookup table, no interpolation</figcaption>
    </figure></p>
<p><figure><a class="lightgallery" href="/theremin/sin_128_float32_lin_interp.gif" title="/theremin/sin_128_float32_lin_interp.gif" data-thumbnail="/theremin/sin_128_float32_lin_interp.gif" data-sub-html="<h2>128 point lookup table, linear interpolation</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/theremin/sin_128_float32_lin_interp.gif"
            data-srcset="/theremin/sin_128_float32_lin_interp.gif, /theremin/sin_128_float32_lin_interp.gif 1.5x, /theremin/sin_128_float32_lin_interp.gif 2x"
            data-sizes="auto"
            alt="/theremin/sin_128_float32_lin_interp.gif" width="595" height="269" />
    </a><figcaption class="image-caption">128 point lookup table, linear interpolation</figcaption>
    </figure></p>
<p><figure><a class="lightgallery" href="/theremin/sin_2048_float32_lut_no_interp.gif" title="/theremin/sin_2048_float32_lut_no_interp.gif" data-thumbnail="/theremin/sin_2048_float32_lut_no_interp.gif" data-sub-html="<h2>2048 point lookup table, no interpolation</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/theremin/sin_2048_float32_lut_no_interp.gif"
            data-srcset="/theremin/sin_2048_float32_lut_no_interp.gif, /theremin/sin_2048_float32_lut_no_interp.gif 1.5x, /theremin/sin_2048_float32_lut_no_interp.gif 2x"
            data-sizes="auto"
            alt="/theremin/sin_2048_float32_lut_no_interp.gif" width="594" height="269" />
    </a><figcaption class="image-caption">2048 point lookup table, no interpolation</figcaption>
    </figure></p>
<p><figure><a class="lightgallery" href="/theremin/sin_2048_float32_linear_interp.gif" title="/theremin/sin_2048_float32_linear_interp.gif" data-thumbnail="/theremin/sin_2048_float32_linear_interp.gif" data-sub-html="<h2>2048 point lookup table, linear interpolation</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/theremin/sin_2048_float32_linear_interp.gif"
            data-srcset="/theremin/sin_2048_float32_linear_interp.gif, /theremin/sin_2048_float32_linear_interp.gif 1.5x, /theremin/sin_2048_float32_linear_interp.gif 2x"
            data-sizes="auto"
            alt="/theremin/sin_2048_float32_linear_interp.gif" width="594" height="270" />
    </a><figcaption class="image-caption">2048 point lookup table, linear interpolation</figcaption>
    </figure></p>
<p><figure><a class="lightgallery" href="/theremin/sin_64k_float32_lut_no_interp.gif" title="/theremin/sin_64k_float32_lut_no_interp.gif" data-thumbnail="/theremin/sin_64k_float32_lut_no_interp.gif" data-sub-html="<h2>64k loopup table, no interpolation</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/theremin/sin_64k_float32_lut_no_interp.gif"
            data-srcset="/theremin/sin_64k_float32_lut_no_interp.gif, /theremin/sin_64k_float32_lut_no_interp.gif 1.5x, /theremin/sin_64k_float32_lut_no_interp.gif 2x"
            data-sizes="auto"
            alt="/theremin/sin_64k_float32_lut_no_interp.gif" width="593" height="269" />
    </a><figcaption class="image-caption">64k loopup table, no interpolation</figcaption>
    </figure></p>
<p><figure><a class="lightgallery" href="/theremin/sin_64k_float32_lut_linear_interp.gif" title="/theremin/sin_64k_float32_lut_linear_interp.gif" data-thumbnail="/theremin/sin_64k_float32_lut_linear_interp.gif" data-sub-html="<h2>64k lookup table, linear interpolation</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/theremin/sin_64k_float32_lut_linear_interp.gif"
            data-srcset="/theremin/sin_64k_float32_lut_linear_interp.gif, /theremin/sin_64k_float32_lut_linear_interp.gif 1.5x, /theremin/sin_64k_float32_lut_linear_interp.gif 2x"
            data-sizes="auto"
            alt="/theremin/sin_64k_float32_lut_linear_interp.gif" width="595" height="270" />
    </a><figcaption class="image-caption">64k lookup table, linear interpolation</figcaption>
    </figure></p>
<p>Below are some wave files of sine waves generated using very short lookup tables, each file is 45k. You might find it interesting to look at them in a wave editor.</p>
<p><a href="/theremin/04-ni.wav" rel="">4 point LUT, no interpolation</a></p>
<p><a href="/theremin/04-li.wav" rel="">4 point LUT, linear interpolation</a></p>
<p><a href="/theremin/08-ni.wav" rel="">8 point LUT, no interpolation</a></p>
<p><a href="/theremin/08-li.wav" rel="">8 point LUT, linear interpolation</a></p>
<p><a href="/theremin/16-ni.wav" rel="">16 point LUT, no interpolation</a></p>
<p><a href="/theremin/16-li.wav" rel="">16 point LUT, linear interpolation</a></p>
<p><a href="/theremin/32-ni.wav" rel="">32 point LUT, no interpolation</a></p>
<p><a href="/theremin/32-li.wav" rel="">32 point LUT, linear interpolation</a></p>
<p>An implementation of approximate_sin(x) using a non-interpolated 64k lookup table took 90 cycles.</p>
<h2 id="an-optimized-lut-implementation">An Optimized LUT Implementation</h2>
<p>Oskari Tammelin contributed the following i86 assembley optimised LUT implementation which can be used for synthesizing sine waves, or any other waveform.</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">looppi:
</span></span><span class="line"><span class="cl">    mov edi, esi
</span></span><span class="line"><span class="cl">    shr edi, (32 - LUT_BITS)
</span></span><span class="line"><span class="cl">    mov edx, esi
</span></span><span class="line"><span class="cl">    and edx, (1 &lt;&lt; (32 - LUT_BITS)) - 1;
</span></span><span class="line"><span class="cl">    mov eax, Lut[edi*8+4]
</span></span><span class="line"><span class="cl">    imul edx
</span></span><span class="line"><span class="cl">    add esi, ecx
</span></span><span class="line"><span class="cl">    add edx, Lut[edi*8]
</span></span><span class="line"><span class="cl">    mov edi, esi
</span></span><span class="line"><span class="cl">    mov [ebp], edx
</span></span><span class="line"><span class="cl">    shr edi, (32 - LUT_BITS)
</span></span><span class="line"><span class="cl">    mov edx, esi
</span></span><span class="line"><span class="cl">    and edx, (1 &lt;&lt; (32 - LUT_BITS)) - 1;
</span></span><span class="line"><span class="cl">    mov eax, Lut[edi*8+4]
</span></span><span class="line"><span class="cl">    imul edx
</span></span><span class="line"><span class="cl">    add ebp, 8
</span></span><span class="line"><span class="cl">    add edx, Lut[edi*8]
</span></span><span class="line"><span class="cl">    add esi, ecx
</span></span><span class="line"><span class="cl">    mov [ebp-4], edx
</span></span><span class="line"><span class="cl">    cmp ebp, [esp]
</span></span><span class="line"><span class="cl">    jnz looppi
</span></span><span class="line"><span class="cl">    </span></span></code></pre></div></div>
<p>Oskari provided the following explanation (slightly edited):</p>
<blockquote>
<p>esi is the phase, ebp the output pointer
The LUT should contain one cycle of a sinewave, interleaved with the delta between adjacent points ([x+1] – x[i]) to make linear interpolation easier. The deltas in the table must be scaled by number of samples in the LUT because edx for the imul is taken from the lower part of the phase in order to save one shl.
It calculates two samples per iteration and executes in approximately 7.8 cycles / sample.</p></blockquote>
<h2 id="an-optimised-lut-in-c">An Optimised LUT in C</h2>
<p>Magnus Jonsson contributed the following code:</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">#define PI 3.1415926535897932384626433832795
</span></span><span class="line"><span class="cl">#define TABLE_BITS 8
</span></span><span class="line"><span class="cl">#define TABLE_SIZE (1&lt;&lt;TABLE_BITS)
</span></span><span class="line"><span class="cl">#define TABLE_SIZE2 (2&lt;&lt;TABLE_BITS)
</span></span><span class="line"><span class="cl">float table[TABLE_SIZE+1];
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">void init_table()
</span></span><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">    for(int i=0;i&lt;TABLE_SIZE;i++){
</span></span><span class="line"><span class="cl">        double x=(double)i/(TABLE_SIZE-1);
</span></span><span class="line"><span class="cl">        double y=PI/2;
</span></span><span class="line"><span class="cl">        if(i!=0)
</span></span><span class="line"><span class="cl">            y=sin(x*y)/x;
</span></span><span class="line"><span class="cl">        table[i]=y*1.0/65536.0/65536.0;
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">}			
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">float zael_sin4(unsigned x)
</span></span><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">    unsigned a=-((unsigned)x&gt;&gt;31);
</span></span><span class="line"><span class="cl">    x+=x;
</span></span><span class="line"><span class="cl">    unsigned b=-((unsigned)x&gt;&gt;31);
</span></span><span class="line"><span class="cl">    x^=b;
</span></span><span class="line"><span class="cl">    float scale=table[x&gt;&gt;31-TABLE_BITS];
</span></span><span class="line"><span class="cl">    x^=a;
</span></span><span class="line"><span class="cl">    return (int)x*scale;
</span></span><span class="line"><span class="cl">}</span></span></code></pre></div></div>
<h2 id="piecewise-polynomial-approximation">Piecewise Polynomial Approximation</h2>
<p>A method of approximating sinusoids using piecewise parabolic approximations of sin(x) <a href="https://dspguru.com/dsp/tricks/parabolic-approximation-of-sin-and-cos/" target="_blank" rel="noopener noreferrer ">here</a>.</p>
<p>Olli’s algorithm using C=0.75 provides a continuous first order derivative resulting in harmonics which decay at a rate of -18dB per octave.</p>
<p><figure><a class="lightgallery" href="/theremin/sine_niemitalo_piecewise_parabolic_approx_c0.75.gif" title="/theremin/sine_niemitalo_piecewise_parabolic_approx_c0.75.gif" data-thumbnail="/theremin/sine_niemitalo_piecewise_parabolic_approx_c0.75.gif" data-sub-html="<h2>This is the spectrum of a signal generated using Olli’s approximation with C=0.75. 
</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/theremin/sine_niemitalo_piecewise_parabolic_approx_c0.75.gif"
            data-srcset="/theremin/sine_niemitalo_piecewise_parabolic_approx_c0.75.gif, /theremin/sine_niemitalo_piecewise_parabolic_approx_c0.75.gif 1.5x, /theremin/sine_niemitalo_piecewise_parabolic_approx_c0.75.gif 2x"
            data-sizes="auto"
            alt="/theremin/sine_niemitalo_piecewise_parabolic_approx_c0.75.gif" width="593" height="268" />
    </a><figcaption class="image-caption">This is the spectrum of a signal generated using Olli’s approximation with C=0.75. 
</figcaption>
    </figure></p>
<p><figure><a class="lightgallery" href="/theremin/q1_sine_niemitalo_approx_c0.75_upper_is_approx.gif" title="/theremin/q1_sine_niemitalo_approx_c0.75_upper_is_approx.gif" data-thumbnail="/theremin/q1_sine_niemitalo_approx_c0.75_upper_is_approx.gif" data-sub-html="<h2>This graph shows the first quadrant of sin(x) and Ollie’s approximation with C=0.75. The upper curve is the approximation the lower curve is sin(x).</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/theremin/q1_sine_niemitalo_approx_c0.75_upper_is_approx.gif"
            data-srcset="/theremin/q1_sine_niemitalo_approx_c0.75_upper_is_approx.gif, /theremin/q1_sine_niemitalo_approx_c0.75_upper_is_approx.gif 1.5x, /theremin/q1_sine_niemitalo_approx_c0.75_upper_is_approx.gif 2x"
            data-sizes="auto"
            alt="/theremin/q1_sine_niemitalo_approx_c0.75_upper_is_approx.gif" width="652" height="402" />
    </a><figcaption class="image-caption">This graph shows the first quadrant of sin(x) and Ollie’s approximation with C=0.75. The upper curve is the approximation the lower curve is sin(x).</figcaption>
    </figure></p>
<h2 id="almost-branch-free-integer-implementation">(Almost) Branch-Free Integer Implementation</h2>
<p>Below is my (almost) branch-free integer implementation based on Ollie’s. It’s worth noting that Ollie’s can produce sin(x)/cos(x) at the same time – I havn’t got around to implementing that yet. For some reason this implementation has a much higher noise floor that the other contributions below, you would probably be better off using one of them.</p>
<p>This version takes 37 cycles not including the if( x == 0 ) conditional.</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="o">/*</span>
</span></span><span class="line"><span class="cl"><span class="n">approximate_cos</span><span class="p">()</span> <span class="n">by</span> <span class="n">Ross</span> <span class="n">Bencina</span> <span class="o">&lt;</span><span class="n">rossb</span><span class="err">@</span><span class="n">audiomulch</span><span class="o">.</span><span class="n">com</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="n">based</span> <span class="n">on</span> <span class="n">Olli</span> <span class="n">Niemitalo</span><span class="s1">&#39;s &lt;oniemita@mail.student.oulu.fi&gt;</span>
</span></span><span class="line"><span class="cl"><span class="n">parabolic</span> <span class="nb">sin</span> <span class="ow">and</span> <span class="nb">cos</span> <span class="n">implementation</span><span class="p">,</span> <span class="n">available</span> <span class="n">here</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">www</span><span class="o">.</span><span class="n">dspguru</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">comp</span><span class="o">.</span><span class="n">dsp</span><span class="o">/</span><span class="n">tricks</span><span class="o">/</span><span class="n">alg</span><span class="o">/</span><span class="n">sincos</span><span class="o">.</span><span class="n">htm</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">this</span> <span class="n">version</span> <span class="n">is</span> <span class="n">a</span> <span class="n">variation</span> <span class="n">on</span> <span class="n">Olli</span><span class="s1">&#39;s which uses no branches and</span>
</span></span><span class="line"><span class="cl"><span class="n">hence</span> <span class="n">may</span> <span class="n">be</span> <span class="n">able</span> <span class="n">to</span> <span class="n">run</span> <span class="n">faster</span> <span class="n">on</span> <span class="n">some</span> <span class="n">pipelined</span> <span class="n">architectures</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">input</span> <span class="nb">range</span><span class="p">:</span> <span class="n">a</span> <span class="mi">32</span> <span class="n">bit</span> <span class="n">unsigned</span> <span class="n">long</span><span class="p">,</span> <span class="mi">0</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0xFFFFFFFF</span> <span class="o">=&gt;</span> <span class="mi">2</span> <span class="n">Pi</span>
</span></span><span class="line"><span class="cl"><span class="n">output</span> <span class="nb">range</span><span class="p">:</span> <span class="n">a</span> <span class="mi">32</span> <span class="n">bit</span> <span class="n">unsigned</span> <span class="n">long</span> <span class="o">-</span><span class="mi">1</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="o">=&gt;</span> <span class="mh">0xFFFFFFFF</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">this</span> <span class="n">version</span> <span class="n">currently</span> <span class="n">generates</span> <span class="n">the</span> <span class="n">incorrect</span> <span class="n">value</span> <span class="k">for</span> <span class="n">x</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="n">you</span> <span class="n">work</span> <span class="n">out</span> <span class="n">how</span> <span class="n">to</span> <span class="n">fix</span> <span class="n">it</span> <span class="n">without</span> <span class="n">slowing</span> <span class="n">the</span> <span class="n">code</span> <span class="n">down</span>
</span></span><span class="line"><span class="cl"><span class="n">please</span> <span class="n">let</span> <span class="n">me</span> <span class="n">know</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"><span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">unsigned</span> <span class="n">long</span> <span class="n">approximate_cos</span><span class="p">(</span> <span class="n">unsigned</span> <span class="n">long</span> <span class="n">x</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">unsigned</span> <span class="n">long</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">=</span> <span class="n">x</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>                                 <span class="o">//</span> <span class="mi">2</span><span class="n">f</span> <span class="n">phasor</span> <span class="p">(</span><span class="n">full</span> <span class="n">unsigned</span> <span class="n">amp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">k</span> <span class="o">=</span> <span class="p">((</span><span class="n">x</span> <span class="o">+</span> <span class="mh">0xBFFFFFFD</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80000000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">30</span><span class="p">;</span>  <span class="o">//</span> <span class="mi">1</span><span class="n">f</span> <span class="n">square</span> <span class="mi">270</span> <span class="n">degrees</span> <span class="n">out</span> <span class="n">of</span> <span class="n">phase</span><span class="p">,</span> <span class="mi">0</span> <span class="n">to</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">j</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="n">i</span> <span class="o">*</span> <span class="p">((</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x80000000</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">30</span><span class="p">);</span>         <span class="o">//</span> <span class="mi">2</span><span class="n">f</span> <span class="n">triangle</span>
</span></span><span class="line"><span class="cl">	<span class="n">j</span> <span class="o">=</span> <span class="n">j</span> <span class="o">&gt;&gt;</span> <span class="mi">15</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="n">j</span> <span class="o">*</span> <span class="n">j</span> <span class="o">+</span> <span class="n">j</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>                          <span class="o">//</span> <span class="n">polynomial</span> <span class="n">shaping</span> <span class="n">into</span> <span class="o">|</span><span class="nb">sin</span><span class="o">|</span>
</span></span><span class="line"><span class="cl">	<span class="n">j</span> <span class="o">=</span> <span class="n">j</span> <span class="o">-</span> <span class="n">j</span> <span class="o">*</span> <span class="n">k</span><span class="p">;</span>                              <span class="o">//</span> <span class="k">switch</span> <span class="n">phase</span> <span class="n">of</span> <span class="n">second</span> <span class="n">half</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">j</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div></div>
<h2 id="i86-assembly-version">i86 Assembly Version</h2>
<p>Ollie contributed this i86 assembler version which executes in 14 cycles.</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">	mov  EAX, phase            //EAX = 32-bit phase
</span></span><span class="line"><span class="cl">	add  EAX, EAX              //Carry = the half bit, EAX = phase within half
</span></span><span class="line"><span class="cl">	sbb  EBX, EBX              //EBX = 0 if left half, -1 if right half
</span></span><span class="line"><span class="cl">	sub  EAX, 80000000h        //Shift phase by a quarter
</span></span><span class="line"><span class="cl">	imul EAX                   //EDX = 0..40000000h
</span></span><span class="line"><span class="cl">	sub  EBX, 80000000h        //EBX = -80000000h if left half, +7fffffffh if right
</span></span><span class="line"><span class="cl">	lea  EAX, [0c0000000h+EDX] //Add bias to the parabola
</span></span><span class="line"><span class="cl">	imul EBX                   //Change sign if necessary
</span></span><span class="line"><span class="cl">	mov  result, EDX           //Result = sine approximation -20000000h..+1fffffffh</span></span></code></pre></div></div>
<p>And the shortest assembler version so far, 5 instructions:</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">	mov  EBX, phase             //EBX = 32-bit phase
</span></span><span class="line"><span class="cl">	lea  EAX, [80000000h+EBX*2] //Take phase within half, shift by 1/4
</span></span><span class="line"><span class="cl">	sar  EBX, 31                //Get sign
</span></span><span class="line"><span class="cl">	imul EAX                    //EDX = 0..40000000h
</span></span><span class="line"><span class="cl">	lea  EAX, [80000000h+EDX*2] //Add bias to the parabola
</span></span><span class="line"><span class="cl">	xor  EAX, EBX               //Change sign if necessary
</span></span><span class="line"><span class="cl">	mov  result, EAX            //Result = -80000000h..7fffffffh</span></span></code></pre></div></div>
<h2 id="16-bit-branch-free-implementation">16 bit Branch Free Implementation</h2>
<p>Lauri Viitanen has provided a C language 16 bit branch free version of Ollie’s algorithm that computes sine and cosine terms simultaneously. Written in C (GPLed), it’s here: <a href="www.rossbencina.com/static/code/sinusoids/fastSinCos16.c" rel="">fastSinCos16.c</a></p>
<div class="code-block code-line-numbers" style="counter-reset: code-block 0">
    <div class="code-header language-">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm"> *  fastSinCos16, a fast 16 bit sine and cosine approximator.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *  Copyright (C) 2011 Lauri Viitanen
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> *  This program is free software: you can redistribute it and/or modify
</span></span></span><span class="line"><span class="cl"><span class="cm"> *  it under the terms of the GNU General Public License as published by
</span></span></span><span class="line"><span class="cl"><span class="cm"> *  the Free Software Foundation, either version 3 of the License, or
</span></span></span><span class="line"><span class="cl"><span class="cm"> *  (at your option) any later version.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> *  This program is distributed in the hope that it will be useful,
</span></span></span><span class="line"><span class="cl"><span class="cm"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of
</span></span></span><span class="line"><span class="cl"><span class="cm"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
</span></span></span><span class="line"><span class="cl"><span class="cm"> *  GNU General Public License for more details.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> *  You should have received a copy of the GNU General Public License
</span></span></span><span class="line"><span class="cl"><span class="cm"> *  along with this program.  If not, see http://www.gnu.org/licenses/ .
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* Average and maximum relative and absolute deviations of this
</span></span></span><span class="line"><span class="cl"><span class="cm">   algorithm from libc&#39;s sin() and cos() values:
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">One multiplication, no extra accuracy:
</span></span></span><span class="line"><span class="cl"><span class="cm">fastSinCos16            ****************************************
</span></span></span><span class="line"><span class="cl"><span class="cm">        Max rel         Avg rel         Max abs         Avg abs
</span></span></span><span class="line"><span class="cl"><span class="cm">SINE  : 1.546518        0.085854        0.056234        0.030120
</span></span></span><span class="line"><span class="cl"><span class="cm">COSINE: 1.546518        0.085852        0.056173        0.030118
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">One multiplication with extra accuracy:
</span></span></span><span class="line"><span class="cl"><span class="cm">fastSinCos16            ****************************************
</span></span></span><span class="line"><span class="cl"><span class="cm">        Max rel         Avg rel         Max abs         Avg abs
</span></span></span><span class="line"><span class="cl"><span class="cm">SINE  : 0.273291        0.085637        0.056112        0.030089
</span></span></span><span class="line"><span class="cl"><span class="cm">COSINE: 0.273291        0.085635        0.056112        0.030088
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">Two multiplications, no extra accuracy:
</span></span></span><span class="line"><span class="cl"><span class="cm">fastSinCos16            ****************************************
</span></span></span><span class="line"><span class="cl"><span class="cm">        Max rel         Avg rel         Max abs         Avg abs
</span></span></span><span class="line"><span class="cl"><span class="cm">SINE  : 1.546518        0.040205        0.023725        0.013693
</span></span></span><span class="line"><span class="cl"><span class="cm">COSINE: 0.909888        0.040191        0.023664        0.013693
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">Two multiplications with extra accuracy:
</span></span></span><span class="line"><span class="cl"><span class="cm">fastSinCos16            ****************************************
</span></span></span><span class="line"><span class="cl"><span class="cm">        Max rel         Avg rel         Max abs         Avg abs
</span></span></span><span class="line"><span class="cl"><span class="cm">SINE  : 0.363371        0.040009        0.023603        0.013693
</span></span></span><span class="line"><span class="cl"><span class="cm">COSINE: 0.363371        0.040008        0.023603        0.013693 */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define DOUBLE_ACCURACY
</span></span></span><span class="line"><span class="cl"><span class="cp">#define EXTRA_ACCURACY
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cm">/* @fn  	fastSinCos16
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @brief	A fast 16 bit sine and cosine approximator.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * This is a direct 16 bit branch free fixed point implementation of Olli
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Niemitalo&#39;s simultaneous parabolic approximation of sin and cos. A detailed
</span></span></span><span class="line"><span class="cl"><span class="cm"> * description of the algoritm can be seen (at least up to Jan 2011) in
</span></span></span><span class="line"><span class="cl"><span class="cm"> * http://www.dspguru.com/dsp/tricks/parabolic-approximation-of-sin-and-cos .
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * The number presentation used in results is as follows:
</span></span></span><span class="line"><span class="cl"><span class="cm"> *     bit 15: sign
</span></span></span><span class="line"><span class="cl"><span class="cm"> *     bit 14: integer part
</span></span></span><span class="line"><span class="cl"><span class="cm"> *     13 - 0: decimal part
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param	ux      Input angle: 0x0000 = 0, 0xffff ~= pi/2
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param	sin_out Address that will contain sin(x).
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param	cos_out Address that will contain cos(x).
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">fastSinCos16</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ux</span><span class="p">,</span> <span class="kt">short</span><span class="o">*</span> <span class="n">sin_out</span><span class="p">,</span> <span class="kt">short</span><span class="o">*</span> <span class="n">cos_out</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">short</span> <span class="n">cos_b</span><span class="p">,</span> <span class="n">sin_b</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">short</span> <span class="n">cos_axxc</span><span class="p">,</span> <span class="n">sin_axxc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">short</span> <span class="n">halfMask</span> <span class="o">=</span> <span class="p">(</span><span class="kt">short</span><span class="p">)</span><span class="n">ux</span> <span class="o">&gt;&gt;</span> <span class="mi">15</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">short</span> <span class="n">quarterMask</span> <span class="o">=</span> <span class="o">-</span><span class="p">((</span><span class="n">ux</span> <span class="o">&gt;&gt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">ux</span> <span class="o">&amp;=</span> <span class="mh">0x3fff</span><span class="p">;</span> <span class="cm">/* Convert to fixed point range 1 ... 0. */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">short</span> <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="kt">short</span><span class="p">)</span><span class="n">ux</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">x</span> <span class="o">-=</span> <span class="mh">0x1fff</span><span class="p">;</span> <span class="cm">/* Convert to range -0.5 ... 0.5. */</span>
</span></span><span class="line"><span class="cl">	<span class="n">sin_b</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">cos_b</span> <span class="o">=</span> <span class="o">-</span><span class="n">x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">lx</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="mh">0x2</span><span class="p">;</span> <span class="cm">/* A tiny offset adjustment... */</span>
</span></span><span class="line"><span class="cl">	<span class="n">lx</span> <span class="o">*=</span> <span class="n">lx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">lx</span> <span class="o">=</span> <span class="p">(</span><span class="n">lx</span> <span class="o">&gt;&gt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cp">#ifdef DOUBLE_ACCURACY
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>		<span class="cm">/* A = 2 - 4sin(pi/4) = 2 - 4*0.70710678118654752440 */</span>
</span></span><span class="line"><span class="cl">		<span class="n">lx</span> <span class="o">*=</span> <span class="mh">0x8000</span> <span class="o">-</span> <span class="mi">4</span><span class="o">*</span><span class="mh">0x2d41</span><span class="p">;</span> <span class="cm">/* x = Ax^2 */</span>
</span></span><span class="line"><span class="cl">		<span class="n">lx</span> <span class="o">&gt;&gt;=</span> <span class="mi">14</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="kt">short</span><span class="p">)(</span><span class="n">lx</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">cos_axxc</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="mh">0x2d41</span><span class="p">;</span> <span class="cm">/* = Ax^2 + C */</span>
</span></span><span class="line"><span class="cl">	<span class="cp">#else
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>		<span class="cm">/* A = 3/4 = 0.75 */</span>
</span></span><span class="line"><span class="cl">		<span class="n">lx</span> <span class="o">=</span> <span class="o">-</span><span class="n">lx</span><span class="p">;</span> <span class="cm">/* x = -x^2 */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="kt">short</span><span class="p">)(</span><span class="n">lx</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">cos_axxc</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="mh">0x3000</span><span class="p">;</span> <span class="cm">/* = Ax^2 + C */</span>
</span></span><span class="line"><span class="cl">	<span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">	<span class="n">sin_axxc</span> <span class="o">=</span> <span class="n">cos_axxc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">cos_axxc</span> <span class="o">^=</span> <span class="n">quarterMask</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">sin_b</span> <span class="o">^=</span> <span class="n">quarterMask</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cp">#ifdef EXTRA_ACCURACY
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>		<span class="n">quarterMask</span> <span class="o">&amp;=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">cos_b</span> <span class="o">+=</span> <span class="n">quarterMask</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">sin_b</span> <span class="o">+=</span> <span class="n">quarterMask</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">	<span class="n">cos_axxc</span> <span class="o">^=</span> <span class="n">halfMask</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">cos_b</span> <span class="o">^=</span> <span class="n">halfMask</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">sin_axxc</span> <span class="o">^=</span> <span class="n">halfMask</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">sin_b</span> <span class="o">^=</span> <span class="n">halfMask</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cp">#ifdef EXTRA_ACCURACY
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>		<span class="n">halfMask</span> <span class="o">&amp;=</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">cos_b</span> <span class="o">+=</span> <span class="n">halfMask</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">sin_b</span> <span class="o">+=</span> <span class="n">halfMask</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">	<span class="n">cos_axxc</span> <span class="o">+=</span> <span class="n">cos_b</span><span class="p">;</span> <span class="cm">/* sin(x) ~= (2 - 4C)x^2 + Bx + C */</span>
</span></span><span class="line"><span class="cl">	<span class="n">sin_axxc</span> <span class="o">+=</span> <span class="n">sin_b</span><span class="p">;</span> <span class="cm">/* cos(x) ~= (2 - 4C)x^2 - Bx + C */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="o">*</span><span class="n">cos_out</span> <span class="o">=</span> <span class="n">cos_axxc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="o">*</span><span class="n">sin_out</span> <span class="o">=</span> <span class="n">sin_axxc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div></div>
<h2 id="floating-point-implementation">Floating-Point Implementation</h2>
<p>René Ceballos contributed the following pure floating point implementation of Olli’s approximation with C=0.75.</p>
<p>This version takes 62 cycles.</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="o">/*</span>
</span></span><span class="line"><span class="cl">    <span class="n">approximate_sin</span><span class="p">()</span> <span class="n">by</span> <span class="n">René</span> <span class="n">G</span><span class="o">.</span> <span class="n">Ceballos</span> <span class="o">&lt;</span><span class="n">rene</span><span class="err">@</span><span class="n">rgcaudio</span><span class="o">.</span><span class="n">com</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="n">input</span> <span class="nb">range</span><span class="p">:</span> <span class="mf">0.0</span> <span class="n">to</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">Pi</span>
</span></span><span class="line"><span class="cl">    <span class="n">output</span> <span class="nb">range</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.0</span> <span class="n">to</span> <span class="mf">1.0</span>
</span></span><span class="line"><span class="cl"><span class="o">*/</span>
</span></span><span class="line"><span class="cl"><span class="ne">float</span> <span class="n">approximate_sin</span><span class="p">(</span> <span class="ne">float</span> <span class="n">angle</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="ne">float</span> <span class="n">k2_oPi</span> <span class="o">=</span> <span class="mf">2.</span><span class="n">f</span> <span class="o">/</span> <span class="n">Pi</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="ne">float</span> <span class="n">k2Pi</span> <span class="o">=</span> <span class="n">Pi2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="ne">float</span> <span class="n">kPi_2</span> <span class="o">=</span> <span class="n">Pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="ne">float</span> <span class="n">kPi</span> <span class="o">=</span> <span class="n">Pi</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="ne">float</span> <span class="n">kPi_32</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">Pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="ne">float</span> <span class="n">x</span><span class="p">,</span><span class="n">j</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="n">angle</span> <span class="o">&lt;</span> <span class="n">kPi_2</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">x</span> <span class="o">=</span> <span class="n">angle</span> <span class="o">*</span> <span class="n">k2_oPi</span> <span class="o">-</span> <span class="mf">0.5</span><span class="n">f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">j</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.75</span><span class="n">f</span> <span class="o">+</span> <span class="n">x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">angle</span> <span class="o">&lt;</span> <span class="n">kPi</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">angle</span> <span class="o">=</span> <span class="n">kPi</span> <span class="o">-</span> <span class="n">angle</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">x</span> <span class="o">=</span> <span class="n">angle</span> <span class="o">*</span> <span class="n">k2_oPi</span> <span class="o">-</span> <span class="mf">0.5</span><span class="n">f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">j</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.75</span><span class="n">f</span> <span class="o">+</span> <span class="n">x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">angle</span> <span class="o">&lt;</span> <span class="n">kPi_32</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">angle</span> <span class="o">-=</span> <span class="n">Pi</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">x</span> <span class="o">=</span> <span class="n">angle</span> <span class="o">*</span> <span class="n">k2_oPi</span> <span class="o">-</span> <span class="mf">0.5</span><span class="n">f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">j</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">x</span> <span class="o">-</span> <span class="mf">0.75</span><span class="n">f</span> <span class="o">-</span> <span class="n">x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">angle</span> <span class="o">=</span> <span class="n">k2Pi</span> <span class="o">-</span> <span class="n">angle</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">x</span> <span class="o">=</span> <span class="n">angle</span> <span class="o">*</span> <span class="n">k2_oPi</span> <span class="o">-</span> <span class="mf">0.5</span><span class="n">f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">j</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">x</span> <span class="o">-</span> <span class="mf">0.75</span><span class="n">f</span> <span class="o">-</span> <span class="n">x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">j</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div></div>
<h2 id="another-branch-free-integer-approximation">Another Branch Free Integer Approximation</h2>
<p>The following four sinusoidal approximation implementations were contributed by Magnus Jonsson. They are based on the same parabolic approximation as Olli’s but were derived independently.</p>
<p>The first C version takes 42 cycles.</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">/*
</span></span><span class="line"><span class="cl">    approximate_sin() by Magnus Jonsson &lt;zeal@snuttis.com&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    input range: full unsigned 32 bit( 0x00000000 to 0xFFFFFFFF )
</span></span><span class="line"><span class="cl">    output range: full signed 32 bit ( -0x7FFFFFFF to +0x80000000 )
</span></span><span class="line"><span class="cl">*/
</span></span><span class="line"><span class="cl">int approximate_sin1(unsigned x)
</span></span><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">    unsigned s=-int(x&gt;&gt;31);
</span></span><span class="line"><span class="cl">    x+=x;
</span></span><span class="line"><span class="cl">    unsigned t=-int(x&gt;&gt;31);
</span></span><span class="line"><span class="cl">    x+=x;
</span></span><span class="line"><span class="cl">    x^=t;
</span></span><span class="line"><span class="cl">    unsigned h=(x&gt;&gt;17);
</span></span><span class="line"><span class="cl">    h++;
</span></span><span class="line"><span class="cl">    h*=h;
</span></span><span class="line"><span class="cl">    h+=h;
</span></span><span class="line"><span class="cl">    x-=h;
</span></span><span class="line"><span class="cl">    x^=s;
</span></span><span class="line"><span class="cl">    return x;
</span></span><span class="line"><span class="cl">}						
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">int approximate_sin2(unsigned x)
</span></span><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">	unsigned s=-int(x&gt;&gt;31);
</span></span><span class="line"><span class="cl">	x+=x;
</span></span><span class="line"><span class="cl">	x^=s;          //x=0..0xffffffff
</span></span><span class="line"><span class="cl">	x&gt;&gt;=16;        //x=0..1
</span></span><span class="line"><span class="cl">	x*=0xffff^x;   // x=x*(2-x)
</span></span><span class="line"><span class="cl">	x+=x;
</span></span><span class="line"><span class="cl">	return x^s;
</span></span><span class="line"><span class="cl">}</span></span></code></pre></div></div>
<p>The following C version executres in 32 cycles:</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">int approximate_sin3(unsigned x)
</span></span><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">	unsigned s=-int(x&gt;&gt;31);
</span></span><span class="line"><span class="cl">	x+=x;
</span></span><span class="line"><span class="cl">	x=x&gt;&gt;16;
</span></span><span class="line"><span class="cl">	x*=x^0xffff;            // x=x*(2-x)
</span></span><span class="line"><span class="cl">	x+=x;                   // optional
</span></span><span class="line"><span class="cl">	return x^s;
</span></span><span class="line"><span class="cl">}</span></span></code></pre></div></div>
<p>The following i86 assembler version executes in 11 cycles:</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">	add eax,eax     // eax=phase
</span></span><span class="line"><span class="cl">	sbb ebx,ebx
</span></span><span class="line"><span class="cl">	mov ecx,eax
</span></span><span class="line"><span class="cl">	xor eax,-1      // not eax
</span></span><span class="line"><span class="cl">	mul ecx
</span></span><span class="line"><span class="cl">	//add edx,edx   // optional, use if you want output 32bit instead of 31 bit
</span></span><span class="line"><span class="cl">	xor edx,ebx     // edx=sin(phase)</span></span></code></pre></div></div>
<p>Note that the assembly versions use the full 32 bits of input phase whereas the C versions only use 16 bits of input phase.</p>
<h2 id="a-6th-order-piecewise-polynomial-approximation">A 6th Order Piecewise Polynomial Approximation</h2>
<p>Olli contributed the following 6th order approximation, which he measured as taking 16 clock cycles on Athlon 700MHz. His calculations indicate that the spectrum has a 3rd harmonic at -66db, and that the remaining harmonics are too low to be noticed.</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">lea  EAX, [EBX*2+80000000h]       //EAX = 1.31 : x = -1..1
</span></span><span class="line"><span class="cl">	sar  EAX, 2                       //EAX = 3.29 : x = -1..1
</span></span><span class="line"><span class="cl">	imul EAX                          //EDX = 6.26 : x^2 = 0..1
</span></span><span class="line"><span class="cl">	sar  EBX, 31                      //EBX = sign
</span></span><span class="line"><span class="cl">	lea  EAX, [EDX*2-14*8000000h]     //EAX = 5.29 : x^2-14 = 0..1
</span></span><span class="line"><span class="cl">	lea  ECX, [EDX*8+EDX-24000000h]   //ECX = 3.29 : x^2-1 = -1..0
</span></span><span class="line"><span class="cl">	imul EDX                          //EDX = 11.21 : x^4-14x^2
</span></span><span class="line"><span class="cl">	xor  ECX, EBX                     //ECX = 3.29 : sign*(x^2-1) = -1..1
</span></span><span class="line"><span class="cl">	lea  EAX, [EDX*8+EDX+61*1200000h] //EAX = 8.24 : x^4-14x^2+61
</span></span><span class="line"><span class="cl">	imul ECX                          //EDX = 11.21 : (x^2-1)(x^4-14x^2+61)</span></span></code></pre></div></div>
<p><figure><a class="lightgallery" href="/theremin/sine_niemitalo_6thorder_approx.gif" title="/theremin/sine_niemitalo_6thorder_approx.gif" data-thumbnail="/theremin/sine_niemitalo_6thorder_approx.gif" data-sub-html="<h2>Spectrum of Olli’s 6th Order Approximation</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/theremin/sine_niemitalo_6thorder_approx.gif"
            data-srcset="/theremin/sine_niemitalo_6thorder_approx.gif, /theremin/sine_niemitalo_6thorder_approx.gif 1.5x, /theremin/sine_niemitalo_6thorder_approx.gif 2x"
            data-sizes="auto"
            alt="/theremin/sine_niemitalo_6thorder_approx.gif" width="595" height="274" />
    </a><figcaption class="image-caption">Spectrum of Olli’s 6th Order Approximation</figcaption>
    </figure></p>
<p>The following version takes 32-bit x and outputs float y. It is the same 6th-order approximation as above. The output range is -61..61, but can be normalized to -1..1 by uncommenting the three marked instructions. Olli measured the routine as taking around 13 clock cycles (without the normalization) on his Athlon.</p>
<p>By following the instructions in the comments this float-&gt;float approximation can be turned into int-&gt;float.</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl">	<span class="ne">float</span> <span class="n">x</span><span class="p">;</span> <span class="o">//</span> <span class="ne">float</span> <span class="n">input</span> <span class="o">-</span><span class="n">pi</span><span class="o">..</span><span class="n">pi</span><span class="p">,</span> <span class="n">UNCOMMENT</span> <span class="n">IFF</span> <span class="n">FLOAT</span> <span class="n">INPUT</span><span class="o">!</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="ne">int</span> <span class="n">x</span><span class="p">;</span> <span class="o">//</span> <span class="mi">32</span><span class="o">-</span><span class="n">bit</span> <span class="ne">int</span> <span class="n">input</span><span class="p">,</span> <span class="n">UNCOMMENT</span> <span class="n">IFF</span> <span class="n">INT</span> <span class="n">INPUT</span><span class="o">!</span>
</span></span><span class="line"><span class="cl">	<span class="ne">float</span> <span class="n">y</span><span class="p">;</span> <span class="o">//</span> <span class="ne">float</span> <span class="n">output</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">const</span> <span class="ne">float</span> <span class="n">c</span> <span class="o">=</span> <span class="mf">0.63661977236758134307553505349</span><span class="n">f</span><span class="p">;</span> <span class="o">//</span> <span class="n">UNCOMMENT</span> <span class="n">IFF</span> <span class="n">FLOAT</span> <span class="n">INPUT</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="k">const</span> <span class="ne">float</span> <span class="n">c</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="mh">0x40000000</span><span class="p">;</span> <span class="o">//</span> <span class="n">UNCOMMENT</span> <span class="n">IFF</span> <span class="n">INT</span> <span class="n">INPUT</span>
</span></span><span class="line"><span class="cl">	<span class="k">const</span> <span class="ne">float</span> <span class="n">c40</span> <span class="o">=</span> <span class="mi">40</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">const</span> <span class="ne">float</span> <span class="n">c6</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">const</span> <span class="ne">float</span> <span class="n">c96</span> <span class="o">=</span> <span class="mi">96</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">const</span> <span class="ne">float</span> <span class="n">scale</span> <span class="o">=</span> <span class="mf">1.0</span><span class="n">f</span><span class="o">/</span><span class="mi">61</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">fld</span> <span class="n">x</span>              <span class="o">//</span> <span class="n">UNCOMMENT</span> <span class="n">IFF</span> <span class="n">FLOAT</span> <span class="n">INPUT</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="n">fild</span> <span class="n">x</span>           <span class="o">//</span> <span class="n">UNCOMMENT</span> <span class="n">IFF</span> <span class="n">INT</span> <span class="n">INPUT</span>
</span></span><span class="line"><span class="cl">	<span class="n">fmul</span> <span class="n">c</span>             <span class="o">//</span> <span class="o">+-</span><span class="n">x</span>
</span></span><span class="line"><span class="cl">	<span class="n">fld</span> <span class="n">st</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>          <span class="o">//</span> <span class="o">+-</span><span class="n">x</span><span class="p">,</span> <span class="o">+-</span><span class="n">x</span>
</span></span><span class="line"><span class="cl">	<span class="n">fabs</span>               <span class="o">//</span> <span class="n">x</span><span class="p">,</span> <span class="o">+-</span><span class="n">x</span>
</span></span><span class="line"><span class="cl">	<span class="n">fld</span> <span class="n">st</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>          <span class="o">//</span> <span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="o">+-</span><span class="n">x</span>
</span></span><span class="line"><span class="cl">	<span class="n">fmul</span> <span class="n">st</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">st</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="o">//</span> <span class="n">x</span><span class="o">^</span><span class="mi">2</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="o">+-</span><span class="n">x</span>
</span></span><span class="line"><span class="cl">	<span class="n">fxch</span>               <span class="o">//</span> <span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="o">^</span><span class="mi">2</span><span class="p">,</span> <span class="o">+-</span><span class="n">x</span>
</span></span><span class="line"><span class="cl">	<span class="n">fsub</span> <span class="n">c6</span>            <span class="o">//</span> <span class="n">x</span><span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="n">x</span><span class="o">^</span><span class="mi">2</span><span class="p">,</span> <span class="o">+-</span><span class="n">x</span>
</span></span><span class="line"><span class="cl">	<span class="n">fmul</span> <span class="n">st</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">st</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="o">//</span> <span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="mi">6</span><span class="p">)</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">2</span><span class="p">,</span> <span class="n">x</span><span class="o">^</span><span class="mi">2</span><span class="p">,</span> <span class="o">+-</span><span class="n">x</span>
</span></span><span class="line"><span class="cl">	<span class="n">fadd</span> <span class="n">c40</span>           <span class="o">//</span> <span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="mi">6</span><span class="p">)</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">2</span><span class="o">+</span><span class="mi">40</span><span class="p">,</span> <span class="n">x</span><span class="o">^</span><span class="mi">2</span><span class="p">,</span> <span class="o">+-</span><span class="n">x</span>
</span></span><span class="line"><span class="cl">	<span class="n">fmulp</span> <span class="n">st</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">st</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">//</span> <span class="p">((</span><span class="n">x</span><span class="o">-</span><span class="mi">6</span><span class="p">)</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">2</span><span class="o">+</span><span class="mi">40</span><span class="p">)</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">2</span><span class="p">,</span> <span class="o">+-</span><span class="n">x</span>
</span></span><span class="line"><span class="cl">	<span class="n">fsub</span> <span class="n">c96</span>           <span class="o">//</span> <span class="p">((</span><span class="n">x</span><span class="o">-</span><span class="mi">6</span><span class="p">)</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">2</span><span class="o">+</span><span class="mi">40</span><span class="p">)</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">2</span><span class="o">-</span><span class="mi">96</span><span class="p">,</span> <span class="o">+-</span><span class="n">x</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="n">fxch</span>             <span class="o">//</span> <span class="o">************************</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="n">fmul</span> <span class="n">scale</span>       <span class="o">//</span> <span class="o">***</span> <span class="n">Optional</span> <span class="n">scaling</span> <span class="o">***</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="n">fxch</span>             <span class="o">//</span> <span class="o">************************</span>
</span></span><span class="line"><span class="cl">	<span class="n">fmulp</span> <span class="n">st</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">st</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">//</span> <span class="o">+-</span><span class="p">(((</span><span class="n">x</span><span class="o">-</span><span class="mi">6</span><span class="p">)</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">2</span><span class="o">+</span><span class="mi">40</span><span class="p">)</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">2</span><span class="o">-</span><span class="mi">96</span><span class="p">)</span><span class="o">*</span><span class="n">x</span>
</span></span><span class="line"><span class="cl">	<span class="n">fstp</span> <span class="n">y</span></span></span></code></pre></div></div>
<h2 id="iterative-methods">Iterative Methods</h2>
<p>The Don Cross link in the resources section provides a good explanation of iterative techniques. Bram DeJong has suggested that I talk about stability issues, and methods for changing frequency on the fly – I’ll do this later, or someone else is welcome to.</p>
<h2 id="recursive-fm">Recursive FM</h2>
<p>Patrice Tarrabia suggests the following two methods for generating non-bandlimited waveforms. He notes that the brightness parameter (k) needs to be carefully tuned. Using this technique it should be possible to build an oscillator which can morph between square and saw like waves.</p>
<blockquote>
<p>y = sin( x + k<em>y );     //saw-like waveform, k controls brightness
y = sin( x + k * y</em>y ); // square-like waveform</p></blockquote>
<p>Basile Graf sent in this Even Polynomial Sin Approximation C code with a maximal error of one LSB in 16bit audio.</p>
<div class="code-block code-line-numbers" style="counter-reset: code-block 0">
    <div class="code-header language-">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Hello</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="n">I</span> <span class="n">found</span> <span class="n">your</span> <span class="n">webpage</span> <span class="s1">&#39;Fun with sinusoīds&#39;</span><span class="p">,</span> <span class="n">particulary</span> <span class="n">the</span> <span class="n">approximation</span> <span class="n">with</span>
</span></span><span class="line"><span class="cl"><span class="n">parabol</span> <span class="n">segments</span><span class="o">.</span> <span class="n">I</span> <span class="n">made</span> <span class="n">some</span> <span class="n">tests</span> <span class="n">with</span> <span class="n">higer</span> <span class="n">degrees</span><span class="p">,</span> <span class="n">with</span> <span class="n">terms</span> <span class="ow">in</span> <span class="n">x</span><span class="o">^</span><span class="mi">2</span><span class="p">,</span> <span class="n">x</span><span class="o">^</span><span class="mi">4</span>
</span></span><span class="line"><span class="cl"><span class="ow">and</span> <span class="n">x</span><span class="o">^</span><span class="mi">6</span><span class="p">,</span> <span class="n">I</span> <span class="n">optain</span> <span class="n">a</span> <span class="n">maximal</span> <span class="n">error</span> <span class="n">smaller</span> <span class="n">than</span> <span class="mf">1.5</span><span class="o">*</span><span class="mi">10</span><span class="o">^-</span><span class="mi">5</span> <span class="k">for</span> <span class="n">an</span> <span class="n">amplitude</span> <span class="n">of</span> <span class="mf">1.</span>
</span></span><span class="line"><span class="cl"><span class="n">This</span> <span class="n">is</span> <span class="n">a</span> <span class="n">maximal</span> <span class="n">error</span> <span class="n">of</span> <span class="n">one</span> <span class="n">LSB</span> <span class="ow">in</span> <span class="mi">16</span><span class="n">bit</span> <span class="n">audio</span><span class="o">.</span> <span class="n">Adding</span> <span class="n">a</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">x</span><span class="o">^</span><span class="mi">8</span> <span class="n">would</span>
</span></span><span class="line"><span class="cl"><span class="n">make</span> <span class="n">it</span> <span class="n">exact</span> <span class="k">for</span> <span class="mi">16</span><span class="n">bit</span> <span class="n">audio</span> <span class="n">with</span> <span class="n">just</span> <span class="n">two</span> <span class="n">multiplications</span> <span class="n">more</span><span class="o">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Here</span> <span class="n">is</span> <span class="n">my</span> <span class="n">test</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">c</span> <span class="n">I</span> <span class="n">used</span> <span class="ow">in</span> <span class="n">a</span> <span class="n">Pure</span> <span class="n">Data</span> <span class="n">external</span><span class="o">.</span> <span class="n">It</span> <span class="n">compute</span> <span class="n">a</span> <span class="n">sine</span> <span class="ow">or</span> <span class="n">a</span>
</span></span><span class="line"><span class="cl"><span class="n">cosine</span> <span class="n">with</span> <span class="n">a</span> <span class="n">period</span> <span class="n">of</span> <span class="n">one</span><span class="p">,</span> <span class="n">between</span> <span class="mi">0</span> <span class="ow">and</span> <span class="mf">1.</span> <span class="p">(</span><span class="n">Other</span> <span class="n">constants</span> <span class="n">would</span> <span class="n">of</span> <span class="n">course</span>
</span></span><span class="line"><span class="cl"><span class="n">make</span> <span class="n">it</span> <span class="n">possible</span> <span class="n">also</span> <span class="k">for</span> <span class="n">a</span> <span class="n">period</span> <span class="n">of</span> <span class="mi">2</span><span class="o">*</span><span class="n">pi</span> <span class="p">):</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Regards</span>
</span></span><span class="line"><span class="cl"><span class="n">Basile</span> <span class="n">Graf</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">//</span><span class="n">CODE</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="o">//----------------------------------------------------</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#define COEFF0 1                 //POSITIVE!!</span>
</span></span><span class="line"><span class="cl"><span class="c1">#define COEFF2 19.73640067359408 //NEGATIVE!!</span>
</span></span><span class="line"><span class="cl"><span class="c1">#define COEFF4 64.66421708408689 //POSITIVE!!</span>
</span></span><span class="line"><span class="cl"><span class="c1">#define COEFF6 78.10890090530666 //NEGATIVE!!</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="ne">float</span> <span class="n">x2_poly_6</span><span class="p">,</span> <span class="n">x4_poly_6</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="n">__inline</span> <span class="n">t_float</span> <span class="n">sinpoly6</span><span class="p">(</span><span class="n">t_float</span> <span class="n">x</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="o">&lt;=</span><span class="mf">0.5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="n">x</span><span class="o">-=</span><span class="mf">0.25</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">x2_poly_6</span> <span class="o">=</span> <span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">x4_poly_6</span> <span class="o">=</span> <span class="n">x2_poly_6</span><span class="o">*</span><span class="n">x2_poly_6</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">return</span>  <span class="n">COEFF0</span> <span class="o">-</span> <span class="n">COEFF2</span><span class="o">*</span><span class="n">x2_poly_6</span> <span class="o">+</span> <span class="n">COEFF4</span><span class="o">*</span><span class="n">x4_poly_6</span> <span class="o">-</span>
</span></span><span class="line"><span class="cl"><span class="n">COEFF6</span><span class="o">*</span><span class="n">x2_poly_6</span><span class="o">*</span><span class="n">x4_poly_6</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="n">x</span><span class="o">-=.</span><span class="mi">75</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">x2_poly_6</span> <span class="o">=</span> <span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">x4_poly_6</span> <span class="o">=</span> <span class="n">x2_poly_6</span><span class="o">*</span><span class="n">x2_poly_6</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">return</span> <span class="o">-</span><span class="n">COEFF0</span> <span class="o">+</span> <span class="n">COEFF2</span><span class="o">*</span><span class="n">x2_poly_6</span> <span class="o">-</span> <span class="n">COEFF4</span><span class="o">*</span><span class="n">x4_poly_6</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl"><span class="n">COEFF6</span><span class="o">*</span><span class="n">x2_poly_6</span><span class="o">*</span><span class="n">x4_poly_6</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="n">__inline</span> <span class="ne">float</span> <span class="n">cospoly6</span><span class="p">(</span><span class="ne">float</span> <span class="n">x</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="o">&lt;=</span><span class="mf">0.25</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="n">x2_poly_6</span> <span class="o">=</span> <span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">x4_poly_6</span> <span class="o">=</span> <span class="n">x2_poly_6</span><span class="o">*</span><span class="n">x2_poly_6</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">return</span> <span class="n">COEFF0</span> <span class="o">-</span> <span class="n">COEFF2</span><span class="o">*</span><span class="n">x2_poly_6</span> <span class="o">+</span> <span class="n">COEFF4</span><span class="o">*</span><span class="n">x4_poly_6</span> <span class="o">-</span>
</span></span><span class="line"><span class="cl"><span class="n">COEFF6</span><span class="o">*</span><span class="n">x2_poly_6</span><span class="o">*</span><span class="n">x4_poly_6</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="o">&gt;=.</span><span class="mi">75</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="n">x</span><span class="o">-=</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">x2_poly_6</span> <span class="o">=</span> <span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">x4_poly_6</span> <span class="o">=</span> <span class="n">x2_poly_6</span><span class="o">*</span><span class="n">x2_poly_6</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">return</span> <span class="n">COEFF0</span> <span class="o">-</span> <span class="n">COEFF2</span><span class="o">*</span><span class="n">x2_poly_6</span> <span class="o">+</span> <span class="n">COEFF4</span><span class="o">*</span><span class="n">x4_poly_6</span> <span class="o">-</span>
</span></span><span class="line"><span class="cl"><span class="n">COEFF6</span><span class="o">*</span><span class="n">x2_poly_6</span><span class="o">*</span><span class="n">x4_poly_6</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="n">x</span><span class="o">-=</span><span class="mf">0.5</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">x2_poly_6</span> <span class="o">=</span> <span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">x4_poly_6</span> <span class="o">=</span> <span class="n">x2_poly_6</span><span class="o">*</span><span class="n">x2_poly_6</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">return</span> <span class="o">-</span><span class="n">COEFF0</span> <span class="o">+</span> <span class="n">COEFF2</span><span class="o">*</span><span class="n">x2_poly_6</span> <span class="o">-</span> <span class="n">COEFF4</span><span class="o">*</span><span class="n">x4_poly_6</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl"><span class="n">COEFF6</span><span class="o">*</span><span class="n">x2_poly_6</span><span class="o">*</span><span class="n">x4_poly_6</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div></div>
<h2 id="related-resources">Related Resources</h2>
<p><a href="https://dspguru.com/dsp/tricks/parabolic-approximation-of-sin-and-cos/" target="_blank" rel="noopener noreferrer ">DSP Trick: Simultaneous Parabolic Approximation of Sin and Cos</a></p>
<p><a href="http://yehar.com/blog/?p=1220" target="_blank" rel="noopener noreferrer ">Sine wave look-up table generation</a></p>
<p><a href="http://groovit.disjunkt.com/analog/time-domain/fasttrig.html" target="_blank" rel="noopener noreferrer "></a> <a href="/theremin/optimizing-trig-calcs-cross.pdf" rel="">&ldquo;pdf&rdquo;</a></p>
<h2 id="acknowledgments">acknowledgments</h2>
<p>Thanks to René G. Ceballos from rgcAudio for doing all the hard work with the performance analysis, and making all the images and sounds so far.</p>
<h2 id="simple-sse-and-sse2-and-now-neon-optimized-sin-cos-log-and-exp">Simple SSE and SSE2 (and now NEON) optimized sin, cos, log and exp</h2>
<p><a href="http://gruntthepeon.free.fr/ssemath/" target="_blank" rel="noopener noreferrer ">source</a></p>
<h3 id="the-story">The story</h3>
<p>I have spent quite a while looking for a simple (but fast) SSE version of some basic transcendental functions (sines and exponential). On the mac, you get the vsinf and friends (in the Accelerate framework) which are nice (there is a ppc version and an intel version, Apple rox) but closed-source, and restricted to macos..</p>
<p>Both Intel and AMD have some sort of vector math library with SIMD sines and cosines, but</p>
<pre><code>Intel MKL is not free (neither as beer, nor as speech)
AMD ACML is free, but no source is available. Morever the vector functions are only available in 64bits OSes !
Would you trust the intel MKL to run at full speed on AMD hardware ?
</code></pre>
<p>Some time ago, I found out the Intel Approximate Math library. This one is completely free and open-source, and it provides SSE and SSE2 versions of many functions. But it has two drawbacks:</p>
<pre><code>It is written as inline assembly, MASM style. The source is very targetted for MSVC/ICC so it is painful to use with gcc
As the name implies, it is approximated. And, well, I had no use for a sine which has garbage in the ten last bits. 
</code></pre>
<p>However, it served as a great source of inspiration for the sin_ps, cos_ps, exp_ps and log_ps provided below.</p>
<p>I chose to write them in pure SSE1+MMX so that they run on the pentium III of your grand mother, and also on my brave athlon-xp, since thoses beast are not SSE2 aware. Intel AMath showed me that the performance gain for using SSE2 for that purpose was not large enough (10%) to consider providing an SSE2 version (but it can be done very quickly). Update: I finally did that SSE2 version &ndash; see below.</p>
<p>The functions use only the <em>mm</em> intrinsics , there is no inline assembly in the code. Advantage: easier to debug, works out of the box on 64 bit setups, let the compiler choose what should be stored in a register, and what is stored in memory. Inconvenient: some versions of gcc 3.x are badly broken with certain intrinsic functions ( _mm_movehl_ps , _mm_cmpeq_ps etc). Mingw&rsquo;s gcc for example &ndash; beware that the brokeness is dependent on the optimization level. A workaround is provided (inline asm replacement for the braindead intrinsics), it is not nice but robust, and broken compilers are detected by the validation program below.</p>
<p>I first tried to improve the AMath functions by using longer minimax polynomial approximations for sine, but of course it failed to achieve full precision because of rounding errors in the polynom, and in the computation of x modulo Pi. So I took a look at the implementation of these functions in the cephes library, noticed that they were simpler than what I imagined and contained very few branches, and just translated them in SSE intrinsics. The sincos_ps is nice because you get magically a free sine for each cosine you compute, so it is almost as fast as the sin_ps and the cos_ps.</p>
<p>Of course it is not IEEE compliant, but the max absolute error on sines is 2^-24 on the range [-8192,8192]. The SSE implementation matches exactly the cephes one if you do not use the x87 fpu when compiling the test program ( -mfpmath=sse with gcc)</p>
<p>The functions below are licensed under the <a href="https://en.wikipedia.org/wiki/Zlib_License" target="_blank" rel="noopener noreferrer ">zlib license</a>, so you can do basically what you want with them. There is nothing smart in them, it&rsquo;s just a straight translation of the cephes functions in SSE1+MMX. However it took some time to debug and validate (more than I expected at first). If you find a bug, or a way to improve their performances, or if you add other functions (tan, log2, exp2, pow, asin, &hellip;) I&rsquo;d be glad to know.</p>
<p>SSE2 version (feature added on 2008/12/15)
Ok, I finally added a pure SSE2 version that does not use any mmx intrinsic. The reason is that the 64 bits MSVC 2008 compiler is not able to generate any MMX intrinsics. This compiler is just stupid. So I had no choice but translate mmx stuff into sse2, which proved to be very easy and boring. The perf improvement is below 10%. In order to use the SSE2 version, just define USE_SSE2 when compiling.</p>
<div class="code-block code-line-numbers" style="counter-reset: code-block 0">
    <div class="code-header language-">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">/*</span> <span class="n">SIMD</span> <span class="p">(</span><span class="n">SSE1</span><span class="o">+</span><span class="n">MMX</span> <span class="ow">or</span> <span class="n">SSE2</span><span class="p">)</span> <span class="n">implementation</span> <span class="n">of</span> <span class="nb">sin</span><span class="p">,</span> <span class="nb">cos</span><span class="p">,</span> <span class="nb">exp</span> <span class="ow">and</span> <span class="nb">log</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="n">Inspired</span> <span class="n">by</span> <span class="n">Intel</span> <span class="n">Approximate</span> <span class="n">Math</span> <span class="n">library</span><span class="p">,</span> <span class="ow">and</span> <span class="n">based</span> <span class="n">on</span> <span class="n">the</span>
</span></span><span class="line"><span class="cl">   <span class="n">corresponding</span> <span class="n">algorithms</span> <span class="n">of</span> <span class="n">the</span> <span class="n">cephes</span> <span class="n">math</span> <span class="n">library</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="n">The</span> <span class="n">default</span> <span class="n">is</span> <span class="n">to</span> <span class="n">use</span> <span class="n">the</span> <span class="n">SSE1</span> <span class="n">version</span><span class="o">.</span> <span class="n">If</span> <span class="n">you</span> <span class="n">define</span> <span class="n">USE_SSE2</span> <span class="n">the</span>
</span></span><span class="line"><span class="cl">   <span class="n">the</span> <span class="n">SSE2</span> <span class="n">intrinsics</span> <span class="n">will</span> <span class="n">be</span> <span class="n">used</span> <span class="ow">in</span> <span class="n">place</span> <span class="n">of</span> <span class="n">the</span> <span class="n">MMX</span> <span class="n">intrinsics</span><span class="o">.</span> <span class="n">Do</span>
</span></span><span class="line"><span class="cl">   <span class="ow">not</span> <span class="n">expect</span> <span class="n">any</span> <span class="n">significant</span> <span class="n">performance</span> <span class="n">improvement</span> <span class="n">with</span> <span class="n">SSE2</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"><span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">/*</span> <span class="n">Copyright</span> <span class="p">(</span><span class="n">C</span><span class="p">)</span> <span class="mi">2007</span>  <span class="n">Julien</span> <span class="n">Pommier</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">This</span> <span class="n">software</span> <span class="n">is</span> <span class="n">provided</span> <span class="s1">&#39;as-is&#39;</span><span class="p">,</span> <span class="n">without</span> <span class="n">any</span> <span class="n">express</span> <span class="ow">or</span> <span class="n">implied</span>
</span></span><span class="line"><span class="cl">  <span class="n">warranty</span><span class="o">.</span>  <span class="n">In</span> <span class="n">no</span> <span class="n">event</span> <span class="n">will</span> <span class="n">the</span> <span class="n">authors</span> <span class="n">be</span> <span class="n">held</span> <span class="n">liable</span> <span class="k">for</span> <span class="n">any</span> <span class="n">damages</span>
</span></span><span class="line"><span class="cl">  <span class="n">arising</span> <span class="n">from</span> <span class="n">the</span> <span class="n">use</span> <span class="n">of</span> <span class="n">this</span> <span class="n">software</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">Permission</span> <span class="n">is</span> <span class="n">granted</span> <span class="n">to</span> <span class="n">anyone</span> <span class="n">to</span> <span class="n">use</span> <span class="n">this</span> <span class="n">software</span> <span class="k">for</span> <span class="n">any</span> <span class="n">purpose</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">including</span> <span class="n">commercial</span> <span class="n">applications</span><span class="p">,</span> <span class="ow">and</span> <span class="n">to</span> <span class="n">alter</span> <span class="n">it</span> <span class="ow">and</span> <span class="n">redistribute</span> <span class="n">it</span>
</span></span><span class="line"><span class="cl">  <span class="n">freely</span><span class="p">,</span> <span class="n">subject</span> <span class="n">to</span> <span class="n">the</span> <span class="n">following</span> <span class="n">restrictions</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="mf">1.</span> <span class="n">The</span> <span class="n">origin</span> <span class="n">of</span> <span class="n">this</span> <span class="n">software</span> <span class="n">must</span> <span class="ow">not</span> <span class="n">be</span> <span class="n">misrepresented</span><span class="p">;</span> <span class="n">you</span> <span class="n">must</span> <span class="ow">not</span>
</span></span><span class="line"><span class="cl">     <span class="n">claim</span> <span class="n">that</span> <span class="n">you</span> <span class="n">wrote</span> <span class="n">the</span> <span class="n">original</span> <span class="n">software</span><span class="o">.</span> <span class="n">If</span> <span class="n">you</span> <span class="n">use</span> <span class="n">this</span> <span class="n">software</span>
</span></span><span class="line"><span class="cl">     <span class="ow">in</span> <span class="n">a</span> <span class="n">product</span><span class="p">,</span> <span class="n">an</span> <span class="n">acknowledgment</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">product</span> <span class="n">documentation</span> <span class="n">would</span> <span class="n">be</span>
</span></span><span class="line"><span class="cl">     <span class="n">appreciated</span> <span class="n">but</span> <span class="n">is</span> <span class="ow">not</span> <span class="n">required</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">  <span class="mf">2.</span> <span class="n">Altered</span> <span class="n">source</span> <span class="n">versions</span> <span class="n">must</span> <span class="n">be</span> <span class="n">plainly</span> <span class="n">marked</span> <span class="n">as</span> <span class="n">such</span><span class="p">,</span> <span class="ow">and</span> <span class="n">must</span> <span class="ow">not</span> <span class="n">be</span>
</span></span><span class="line"><span class="cl">     <span class="n">misrepresented</span> <span class="n">as</span> <span class="n">being</span> <span class="n">the</span> <span class="n">original</span> <span class="n">software</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">  <span class="mf">3.</span> <span class="n">This</span> <span class="n">notice</span> <span class="n">may</span> <span class="ow">not</span> <span class="n">be</span> <span class="n">removed</span> <span class="ow">or</span> <span class="n">altered</span> <span class="n">from</span> <span class="n">any</span> <span class="n">source</span> <span class="n">distribution</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="n">this</span> <span class="n">is</span> <span class="n">the</span> <span class="n">zlib</span> <span class="n">license</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#include &lt;xmmintrin.h&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">/*</span> <span class="n">yes</span> <span class="n">I</span> <span class="n">know</span><span class="p">,</span> <span class="n">the</span> <span class="n">top</span> <span class="n">of</span> <span class="n">this</span> <span class="n">file</span> <span class="n">is</span> <span class="n">quite</span> <span class="n">ugly</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#ifdef _MSC_VER /* visual c++ */</span>
</span></span><span class="line"><span class="cl"><span class="c1"># define ALIGN16_BEG __declspec(align(16))</span>
</span></span><span class="line"><span class="cl"><span class="c1"># define ALIGN16_END </span>
</span></span><span class="line"><span class="cl"><span class="c1">#else /* gcc or icc */</span>
</span></span><span class="line"><span class="cl"><span class="c1"># define ALIGN16_BEG</span>
</span></span><span class="line"><span class="cl"><span class="c1"># define ALIGN16_END __attribute__((aligned(16)))</span>
</span></span><span class="line"><span class="cl"><span class="c1">#endif</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">/*</span> <span class="n">__m128</span> <span class="n">is</span> <span class="n">ugly</span> <span class="n">to</span> <span class="n">write</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl"><span class="n">typedef</span> <span class="n">__m128</span> <span class="n">v4sf</span><span class="p">;</span>  <span class="o">//</span> <span class="n">vector</span> <span class="n">of</span> <span class="mi">4</span> <span class="ne">float</span> <span class="p">(</span><span class="n">sse1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#ifdef USE_SSE2</span>
</span></span><span class="line"><span class="cl"><span class="c1"># include &lt;emmintrin.h&gt;</span>
</span></span><span class="line"><span class="cl"><span class="n">typedef</span> <span class="n">__m128i</span> <span class="n">v4si</span><span class="p">;</span> <span class="o">//</span> <span class="n">vector</span> <span class="n">of</span> <span class="mi">4</span> <span class="ne">int</span> <span class="p">(</span><span class="n">sse2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#else</span>
</span></span><span class="line"><span class="cl"><span class="n">typedef</span> <span class="n">__m64</span> <span class="n">v2si</span><span class="p">;</span>   <span class="o">//</span> <span class="n">vector</span> <span class="n">of</span> <span class="mi">2</span> <span class="ne">int</span> <span class="p">(</span><span class="n">mmx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#endif</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">/*</span> <span class="n">declare</span> <span class="n">some</span> <span class="n">SSE</span> <span class="n">constants</span> <span class="o">--</span> <span class="n">why</span> <span class="n">can</span><span class="s1">&#39;t I figure a better way to do that? */</span>
</span></span><span class="line"><span class="cl"><span class="c1">#define _PS_CONST(Name, Val)                                            \</span>
</span></span><span class="line"><span class="cl">  <span class="k">static</span> <span class="k">const</span> <span class="n">ALIGN16_BEG</span> <span class="ne">float</span> <span class="n">_ps_</span><span class="c1">##Name[4] ALIGN16_END = { Val, Val, Val, Val }</span>
</span></span><span class="line"><span class="cl"><span class="c1">#define _PI32_CONST(Name, Val)                                            \</span>
</span></span><span class="line"><span class="cl">  <span class="k">static</span> <span class="k">const</span> <span class="n">ALIGN16_BEG</span> <span class="ne">int</span> <span class="n">_pi32_</span><span class="c1">##Name[4] ALIGN16_END = { Val, Val, Val, Val }</span>
</span></span><span class="line"><span class="cl"><span class="c1">#define _PS_CONST_TYPE(Name, Type, Val)                                 \</span>
</span></span><span class="line"><span class="cl">  <span class="k">static</span> <span class="k">const</span> <span class="n">ALIGN16_BEG</span> <span class="n">Type</span> <span class="n">_ps_</span><span class="c1">##Name[4] ALIGN16_END = { Val, Val, Val, Val }</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">_PS_CONST</span><span class="p">(</span><span class="mi">1</span>  <span class="p">,</span> <span class="mf">1.0</span><span class="n">f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">_PS_CONST</span><span class="p">(</span><span class="mi">0</span><span class="n">p5</span><span class="p">,</span> <span class="mf">0.5</span><span class="n">f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="o">/*</span> <span class="n">the</span> <span class="n">smallest</span> <span class="n">non</span> <span class="n">denormalized</span> <span class="ne">float</span> <span class="n">number</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl"><span class="n">_PS_CONST_TYPE</span><span class="p">(</span><span class="n">min_norm_pos</span><span class="p">,</span> <span class="ne">int</span><span class="p">,</span> <span class="mh">0x00800000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">_PS_CONST_TYPE</span><span class="p">(</span><span class="n">mant_mask</span><span class="p">,</span> <span class="ne">int</span><span class="p">,</span> <span class="mh">0x7f800000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">_PS_CONST_TYPE</span><span class="p">(</span><span class="n">inv_mant_mask</span><span class="p">,</span> <span class="ne">int</span><span class="p">,</span> <span class="o">~</span><span class="mh">0x7f800000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">_PS_CONST_TYPE</span><span class="p">(</span><span class="n">sign_mask</span><span class="p">,</span> <span class="ne">int</span><span class="p">,</span> <span class="p">(</span><span class="ne">int</span><span class="p">)</span><span class="mh">0x80000000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">_PS_CONST_TYPE</span><span class="p">(</span><span class="n">inv_sign_mask</span><span class="p">,</span> <span class="ne">int</span><span class="p">,</span> <span class="o">~</span><span class="mh">0x80000000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">_PI32_CONST</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">_PI32_CONST</span><span class="p">(</span><span class="n">inv1</span><span class="p">,</span> <span class="o">~</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">_PI32_CONST</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">_PI32_CONST</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">_PI32_CONST</span><span class="p">(</span><span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">_PS_CONST</span><span class="p">(</span><span class="n">cephes_SQRTHF</span><span class="p">,</span> <span class="mf">0.707106781186547524</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">_PS_CONST</span><span class="p">(</span><span class="n">cephes_log_p0</span><span class="p">,</span> <span class="mf">7.0376836292E-2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">_PS_CONST</span><span class="p">(</span><span class="n">cephes_log_p1</span><span class="p">,</span> <span class="o">-</span> <span class="mf">1.1514610310E-1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">_PS_CONST</span><span class="p">(</span><span class="n">cephes_log_p2</span><span class="p">,</span> <span class="mf">1.1676998740E-1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">_PS_CONST</span><span class="p">(</span><span class="n">cephes_log_p3</span><span class="p">,</span> <span class="o">-</span> <span class="mf">1.2420140846E-1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">_PS_CONST</span><span class="p">(</span><span class="n">cephes_log_p4</span><span class="p">,</span> <span class="o">+</span> <span class="mf">1.4249322787E-1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">_PS_CONST</span><span class="p">(</span><span class="n">cephes_log_p5</span><span class="p">,</span> <span class="o">-</span> <span class="mf">1.6668057665E-1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">_PS_CONST</span><span class="p">(</span><span class="n">cephes_log_p6</span><span class="p">,</span> <span class="o">+</span> <span class="mf">2.0000714765E-1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">_PS_CONST</span><span class="p">(</span><span class="n">cephes_log_p7</span><span class="p">,</span> <span class="o">-</span> <span class="mf">2.4999993993E-1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">_PS_CONST</span><span class="p">(</span><span class="n">cephes_log_p8</span><span class="p">,</span> <span class="o">+</span> <span class="mf">3.3333331174E-1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">_PS_CONST</span><span class="p">(</span><span class="n">cephes_log_q1</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.12194440e-4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">_PS_CONST</span><span class="p">(</span><span class="n">cephes_log_q2</span><span class="p">,</span> <span class="mf">0.693359375</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#ifndef USE_SSE2</span>
</span></span><span class="line"><span class="cl"><span class="n">typedef</span> <span class="n">union</span> <span class="n">xmm_mm_union</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">__m128</span> <span class="n">xmm</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">__m64</span> <span class="n">mm</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">xmm_mm_union</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#define COPY_XMM_TO_MM(xmm_, mm0_, mm1_) {          \</span>
</span></span><span class="line"><span class="cl">    <span class="n">xmm_mm_union</span> <span class="n">u</span><span class="p">;</span> <span class="n">u</span><span class="o">.</span><span class="n">xmm</span> <span class="o">=</span> <span class="n">xmm_</span><span class="p">;</span>                   \
</span></span><span class="line"><span class="cl">    <span class="n">mm0_</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">mm</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>                                 \
</span></span><span class="line"><span class="cl">    <span class="n">mm1_</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">mm</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>                                 \
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#define COPY_MM_TO_XMM(mm0_, mm1_, xmm_) {                         \</span>
</span></span><span class="line"><span class="cl">    <span class="n">xmm_mm_union</span> <span class="n">u</span><span class="p">;</span> <span class="n">u</span><span class="o">.</span><span class="n">mm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">mm0_</span><span class="p">;</span> <span class="n">u</span><span class="o">.</span><span class="n">mm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">mm1_</span><span class="p">;</span> <span class="n">xmm_</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">xmm</span><span class="p">;</span>      \
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#endif // USE_SSE2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">/*</span> <span class="n">natural</span> <span class="n">logarithm</span> <span class="n">computed</span> <span class="k">for</span> <span class="mi">4</span> <span class="n">simultaneous</span> <span class="ne">float</span> 
</span></span><span class="line"><span class="cl">   <span class="k">return</span> <span class="n">NaN</span> <span class="k">for</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="o">*/</span>
</span></span><span class="line"><span class="cl"><span class="n">v4sf</span> <span class="n">log_ps</span><span class="p">(</span><span class="n">v4sf</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="c1">#ifdef USE_SSE2</span>
</span></span><span class="line"><span class="cl">  <span class="n">v4si</span> <span class="n">emm0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#else</span>
</span></span><span class="line"><span class="cl">  <span class="n">v2si</span> <span class="n">mm0</span><span class="p">,</span> <span class="n">mm1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#endif</span>
</span></span><span class="line"><span class="cl">  <span class="n">v4sf</span> <span class="n">one</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">v4sf</span><span class="o">*</span><span class="p">)</span><span class="n">_ps_1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">v4sf</span> <span class="n">invalid_mask</span> <span class="o">=</span> <span class="n">_mm_cmple_ps</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">_mm_setzero_ps</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">x</span> <span class="o">=</span> <span class="n">_mm_max_ps</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v4sf</span><span class="o">*</span><span class="p">)</span><span class="n">_ps_min_norm_pos</span><span class="p">);</span>  <span class="o">/*</span> <span class="n">cut</span> <span class="n">off</span> <span class="n">denormalized</span> <span class="n">stuff</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#ifndef USE_SSE2</span>
</span></span><span class="line"><span class="cl">  <span class="o">/*</span> <span class="n">part</span> <span class="mi">1</span><span class="p">:</span> <span class="n">x</span> <span class="o">=</span> <span class="n">frexpf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e</span><span class="p">);</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">  <span class="n">COPY_XMM_TO_MM</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mm0</span><span class="p">,</span> <span class="n">mm1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">mm0</span> <span class="o">=</span> <span class="n">_mm_srli_pi32</span><span class="p">(</span><span class="n">mm0</span><span class="p">,</span> <span class="mi">23</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">mm1</span> <span class="o">=</span> <span class="n">_mm_srli_pi32</span><span class="p">(</span><span class="n">mm1</span><span class="p">,</span> <span class="mi">23</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">#else</span>
</span></span><span class="line"><span class="cl">  <span class="n">emm0</span> <span class="o">=</span> <span class="n">_mm_srli_epi32</span><span class="p">(</span><span class="n">_mm_castps_si128</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="mi">23</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">#endif</span>
</span></span><span class="line"><span class="cl">  <span class="o">/*</span> <span class="n">keep</span> <span class="n">only</span> <span class="n">the</span> <span class="n">fractional</span> <span class="n">part</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">  <span class="n">x</span> <span class="o">=</span> <span class="n">_mm_and_ps</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v4sf</span><span class="o">*</span><span class="p">)</span><span class="n">_ps_inv_mant_mask</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">x</span> <span class="o">=</span> <span class="n">_mm_or_ps</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v4sf</span><span class="o">*</span><span class="p">)</span><span class="n">_ps_0p5</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#ifndef USE_SSE2</span>
</span></span><span class="line"><span class="cl">  <span class="o">/*</span> <span class="n">now</span> <span class="n">e</span><span class="o">=</span><span class="n">mm0</span><span class="p">:</span><span class="n">mm1</span> <span class="n">contain</span> <span class="n">the</span> <span class="n">really</span> <span class="n">base</span><span class="o">-</span><span class="mi">2</span> <span class="n">exponent</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">  <span class="n">mm0</span> <span class="o">=</span> <span class="n">_mm_sub_pi32</span><span class="p">(</span><span class="n">mm0</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v2si</span><span class="o">*</span><span class="p">)</span><span class="n">_pi32_0x7f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">mm1</span> <span class="o">=</span> <span class="n">_mm_sub_pi32</span><span class="p">(</span><span class="n">mm1</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v2si</span><span class="o">*</span><span class="p">)</span><span class="n">_pi32_0x7f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">v4sf</span> <span class="n">e</span> <span class="o">=</span> <span class="n">_mm_cvtpi32x2_ps</span><span class="p">(</span><span class="n">mm0</span><span class="p">,</span> <span class="n">mm1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">_mm_empty</span><span class="p">();</span> <span class="o">/*</span> <span class="n">bye</span> <span class="n">bye</span> <span class="n">mmx</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl"><span class="c1">#else</span>
</span></span><span class="line"><span class="cl">  <span class="n">emm0</span> <span class="o">=</span> <span class="n">_mm_sub_epi32</span><span class="p">(</span><span class="n">emm0</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v4si</span><span class="o">*</span><span class="p">)</span><span class="n">_pi32_0x7f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">v4sf</span> <span class="n">e</span> <span class="o">=</span> <span class="n">_mm_cvtepi32_ps</span><span class="p">(</span><span class="n">emm0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">#endif</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">e</span> <span class="o">=</span> <span class="n">_mm_add_ps</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">one</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="o">/*</span> <span class="n">part2</span><span class="p">:</span> 
</span></span><span class="line"><span class="cl">     <span class="k">if</span><span class="p">(</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">SQRTHF</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">       <span class="n">e</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">       <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">x</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="o">*/</span>
</span></span><span class="line"><span class="cl">  <span class="n">v4sf</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">_mm_cmplt_ps</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v4sf</span><span class="o">*</span><span class="p">)</span><span class="n">_ps_cephes_SQRTHF</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">v4sf</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">_mm_and_ps</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">x</span> <span class="o">=</span> <span class="n">_mm_sub_ps</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">one</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">e</span> <span class="o">=</span> <span class="n">_mm_sub_ps</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">_mm_and_ps</span><span class="p">(</span><span class="n">one</span><span class="p">,</span> <span class="n">mask</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="n">x</span> <span class="o">=</span> <span class="n">_mm_add_ps</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">v4sf</span> <span class="n">z</span> <span class="o">=</span> <span class="n">_mm_mul_ps</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">x</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">v4sf</span> <span class="n">y</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">v4sf</span><span class="o">*</span><span class="p">)</span><span class="n">_ps_cephes_log_p0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">_mm_mul_ps</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">_mm_add_ps</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v4sf</span><span class="o">*</span><span class="p">)</span><span class="n">_ps_cephes_log_p1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">_mm_mul_ps</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">_mm_add_ps</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v4sf</span><span class="o">*</span><span class="p">)</span><span class="n">_ps_cephes_log_p2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">_mm_mul_ps</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">_mm_add_ps</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v4sf</span><span class="o">*</span><span class="p">)</span><span class="n">_ps_cephes_log_p3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">_mm_mul_ps</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">_mm_add_ps</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v4sf</span><span class="o">*</span><span class="p">)</span><span class="n">_ps_cephes_log_p4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">_mm_mul_ps</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">_mm_add_ps</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v4sf</span><span class="o">*</span><span class="p">)</span><span class="n">_ps_cephes_log_p5</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">_mm_mul_ps</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">_mm_add_ps</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v4sf</span><span class="o">*</span><span class="p">)</span><span class="n">_ps_cephes_log_p6</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">_mm_mul_ps</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">_mm_add_ps</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v4sf</span><span class="o">*</span><span class="p">)</span><span class="n">_ps_cephes_log_p7</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">_mm_mul_ps</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">_mm_add_ps</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v4sf</span><span class="o">*</span><span class="p">)</span><span class="n">_ps_cephes_log_p8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">_mm_mul_ps</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">_mm_mul_ps</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">tmp</span> <span class="o">=</span> <span class="n">_mm_mul_ps</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v4sf</span><span class="o">*</span><span class="p">)</span><span class="n">_ps_cephes_log_q1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">_mm_add_ps</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">tmp</span> <span class="o">=</span> <span class="n">_mm_mul_ps</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v4sf</span><span class="o">*</span><span class="p">)</span><span class="n">_ps_0p5</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">_mm_sub_ps</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">tmp</span> <span class="o">=</span> <span class="n">_mm_mul_ps</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v4sf</span><span class="o">*</span><span class="p">)</span><span class="n">_ps_cephes_log_q2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">x</span> <span class="o">=</span> <span class="n">_mm_add_ps</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">x</span> <span class="o">=</span> <span class="n">_mm_add_ps</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">x</span> <span class="o">=</span> <span class="n">_mm_or_ps</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">invalid_mask</span><span class="p">);</span> <span class="o">//</span> <span class="n">negative</span> <span class="n">arg</span> <span class="n">will</span> <span class="n">be</span> <span class="bp">NAN</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">_PS_CONST</span><span class="p">(</span><span class="n">exp_hi</span><span class="p">,</span>	<span class="mf">88.3762626647949</span><span class="n">f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">_PS_CONST</span><span class="p">(</span><span class="n">exp_lo</span><span class="p">,</span>	<span class="o">-</span><span class="mf">88.3762626647949</span><span class="n">f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">_PS_CONST</span><span class="p">(</span><span class="n">cephes_LOG2EF</span><span class="p">,</span> <span class="mf">1.44269504088896341</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">_PS_CONST</span><span class="p">(</span><span class="n">cephes_exp_C1</span><span class="p">,</span> <span class="mf">0.693359375</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">_PS_CONST</span><span class="p">(</span><span class="n">cephes_exp_C2</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.12194440e-4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">_PS_CONST</span><span class="p">(</span><span class="n">cephes_exp_p0</span><span class="p">,</span> <span class="mf">1.9875691500E-4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">_PS_CONST</span><span class="p">(</span><span class="n">cephes_exp_p1</span><span class="p">,</span> <span class="mf">1.3981999507E-3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">_PS_CONST</span><span class="p">(</span><span class="n">cephes_exp_p2</span><span class="p">,</span> <span class="mf">8.3334519073E-3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">_PS_CONST</span><span class="p">(</span><span class="n">cephes_exp_p3</span><span class="p">,</span> <span class="mf">4.1665795894E-2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">_PS_CONST</span><span class="p">(</span><span class="n">cephes_exp_p4</span><span class="p">,</span> <span class="mf">1.6666665459E-1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">_PS_CONST</span><span class="p">(</span><span class="n">cephes_exp_p5</span><span class="p">,</span> <span class="mf">5.0000001201E-1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">v4sf</span> <span class="n">exp_ps</span><span class="p">(</span><span class="n">v4sf</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">v4sf</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">_mm_setzero_ps</span><span class="p">(),</span> <span class="n">fx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#ifdef USE_SSE2</span>
</span></span><span class="line"><span class="cl">  <span class="n">v4si</span> <span class="n">emm0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#else</span>
</span></span><span class="line"><span class="cl">  <span class="n">v2si</span> <span class="n">mm0</span><span class="p">,</span> <span class="n">mm1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#endif</span>
</span></span><span class="line"><span class="cl">  <span class="n">v4sf</span> <span class="n">one</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">v4sf</span><span class="o">*</span><span class="p">)</span><span class="n">_ps_1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">x</span> <span class="o">=</span> <span class="n">_mm_min_ps</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v4sf</span><span class="o">*</span><span class="p">)</span><span class="n">_ps_exp_hi</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">x</span> <span class="o">=</span> <span class="n">_mm_max_ps</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v4sf</span><span class="o">*</span><span class="p">)</span><span class="n">_ps_exp_lo</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="o">/*</span> <span class="n">express</span> <span class="nb">exp</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="n">as</span> <span class="nb">exp</span><span class="p">(</span><span class="n">g</span> <span class="o">+</span> <span class="n">n</span><span class="o">*</span><span class="nb">log</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">  <span class="n">fx</span> <span class="o">=</span> <span class="n">_mm_mul_ps</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v4sf</span><span class="o">*</span><span class="p">)</span><span class="n">_ps_cephes_LOG2EF</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">fx</span> <span class="o">=</span> <span class="n">_mm_add_ps</span><span class="p">(</span><span class="n">fx</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v4sf</span><span class="o">*</span><span class="p">)</span><span class="n">_ps_0p5</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="o">/*</span> <span class="n">how</span> <span class="n">to</span> <span class="n">perform</span> <span class="n">a</span> <span class="n">floorf</span> <span class="n">with</span> <span class="n">SSE</span><span class="p">:</span> <span class="n">just</span> <span class="n">below</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl"><span class="c1">#ifndef USE_SSE2</span>
</span></span><span class="line"><span class="cl">  <span class="o">/*</span> <span class="n">step</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">cast</span> <span class="n">to</span> <span class="ne">int</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">  <span class="n">tmp</span> <span class="o">=</span> <span class="n">_mm_movehl_ps</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">fx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">mm0</span> <span class="o">=</span> <span class="n">_mm_cvttps_pi32</span><span class="p">(</span><span class="n">fx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">mm1</span> <span class="o">=</span> <span class="n">_mm_cvttps_pi32</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">/*</span> <span class="n">step</span> <span class="mi">2</span> <span class="p">:</span> <span class="n">cast</span> <span class="n">back</span> <span class="n">to</span> <span class="ne">float</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">  <span class="n">tmp</span> <span class="o">=</span> <span class="n">_mm_cvtpi32x2_ps</span><span class="p">(</span><span class="n">mm0</span><span class="p">,</span> <span class="n">mm1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">#else</span>
</span></span><span class="line"><span class="cl">  <span class="n">emm0</span> <span class="o">=</span> <span class="n">_mm_cvttps_epi32</span><span class="p">(</span><span class="n">fx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">tmp</span>  <span class="o">=</span> <span class="n">_mm_cvtepi32_ps</span><span class="p">(</span><span class="n">emm0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">#endif</span>
</span></span><span class="line"><span class="cl">  <span class="o">/*</span> <span class="k">if</span> <span class="n">greater</span><span class="p">,</span> <span class="n">substract</span> <span class="mi">1</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">  <span class="n">v4sf</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">_mm_cmpgt_ps</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">fx</span><span class="p">);</span>    
</span></span><span class="line"><span class="cl">  <span class="n">mask</span> <span class="o">=</span> <span class="n">_mm_and_ps</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">one</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">fx</span> <span class="o">=</span> <span class="n">_mm_sub_ps</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">tmp</span> <span class="o">=</span> <span class="n">_mm_mul_ps</span><span class="p">(</span><span class="n">fx</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v4sf</span><span class="o">*</span><span class="p">)</span><span class="n">_ps_cephes_exp_C1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">v4sf</span> <span class="n">z</span> <span class="o">=</span> <span class="n">_mm_mul_ps</span><span class="p">(</span><span class="n">fx</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v4sf</span><span class="o">*</span><span class="p">)</span><span class="n">_ps_cephes_exp_C2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">x</span> <span class="o">=</span> <span class="n">_mm_sub_ps</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">x</span> <span class="o">=</span> <span class="n">_mm_sub_ps</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">z</span> <span class="o">=</span> <span class="n">_mm_mul_ps</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">x</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="n">v4sf</span> <span class="n">y</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">v4sf</span><span class="o">*</span><span class="p">)</span><span class="n">_ps_cephes_exp_p0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">_mm_mul_ps</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">_mm_add_ps</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v4sf</span><span class="o">*</span><span class="p">)</span><span class="n">_ps_cephes_exp_p1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">_mm_mul_ps</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">_mm_add_ps</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v4sf</span><span class="o">*</span><span class="p">)</span><span class="n">_ps_cephes_exp_p2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">_mm_mul_ps</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">_mm_add_ps</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v4sf</span><span class="o">*</span><span class="p">)</span><span class="n">_ps_cephes_exp_p3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">_mm_mul_ps</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">_mm_add_ps</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v4sf</span><span class="o">*</span><span class="p">)</span><span class="n">_ps_cephes_exp_p4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">_mm_mul_ps</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">_mm_add_ps</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v4sf</span><span class="o">*</span><span class="p">)</span><span class="n">_ps_cephes_exp_p5</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">_mm_mul_ps</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">_mm_add_ps</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">_mm_add_ps</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">one</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="o">/*</span> <span class="n">build</span> <span class="mi">2</span><span class="o">^</span><span class="n">n</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl"><span class="c1">#ifndef USE_SSE2</span>
</span></span><span class="line"><span class="cl">  <span class="n">z</span> <span class="o">=</span> <span class="n">_mm_movehl_ps</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">fx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">mm0</span> <span class="o">=</span> <span class="n">_mm_cvttps_pi32</span><span class="p">(</span><span class="n">fx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">mm1</span> <span class="o">=</span> <span class="n">_mm_cvttps_pi32</span><span class="p">(</span><span class="n">z</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">mm0</span> <span class="o">=</span> <span class="n">_mm_add_pi32</span><span class="p">(</span><span class="n">mm0</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v2si</span><span class="o">*</span><span class="p">)</span><span class="n">_pi32_0x7f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">mm1</span> <span class="o">=</span> <span class="n">_mm_add_pi32</span><span class="p">(</span><span class="n">mm1</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v2si</span><span class="o">*</span><span class="p">)</span><span class="n">_pi32_0x7f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">mm0</span> <span class="o">=</span> <span class="n">_mm_slli_pi32</span><span class="p">(</span><span class="n">mm0</span><span class="p">,</span> <span class="mi">23</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">  <span class="n">mm1</span> <span class="o">=</span> <span class="n">_mm_slli_pi32</span><span class="p">(</span><span class="n">mm1</span><span class="p">,</span> <span class="mi">23</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="n">v4sf</span> <span class="n">pow2n</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">  <span class="n">COPY_MM_TO_XMM</span><span class="p">(</span><span class="n">mm0</span><span class="p">,</span> <span class="n">mm1</span><span class="p">,</span> <span class="n">pow2n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">_mm_empty</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="c1">#else</span>
</span></span><span class="line"><span class="cl">  <span class="n">emm0</span> <span class="o">=</span> <span class="n">_mm_cvttps_epi32</span><span class="p">(</span><span class="n">fx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">emm0</span> <span class="o">=</span> <span class="n">_mm_add_epi32</span><span class="p">(</span><span class="n">emm0</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v4si</span><span class="o">*</span><span class="p">)</span><span class="n">_pi32_0x7f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">emm0</span> <span class="o">=</span> <span class="n">_mm_slli_epi32</span><span class="p">(</span><span class="n">emm0</span><span class="p">,</span> <span class="mi">23</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">v4sf</span> <span class="n">pow2n</span> <span class="o">=</span> <span class="n">_mm_castsi128_ps</span><span class="p">(</span><span class="n">emm0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">#endif</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">_mm_mul_ps</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">pow2n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">y</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">_PS_CONST</span><span class="p">(</span><span class="n">minus_cephes_DP1</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.78515625</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">_PS_CONST</span><span class="p">(</span><span class="n">minus_cephes_DP2</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.4187564849853515625e-4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">_PS_CONST</span><span class="p">(</span><span class="n">minus_cephes_DP3</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.77489497744594108e-8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">_PS_CONST</span><span class="p">(</span><span class="n">sincof_p0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.9515295891E-4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">_PS_CONST</span><span class="p">(</span><span class="n">sincof_p1</span><span class="p">,</span>  <span class="mf">8.3321608736E-3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">_PS_CONST</span><span class="p">(</span><span class="n">sincof_p2</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.6666654611E-1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">_PS_CONST</span><span class="p">(</span><span class="n">coscof_p0</span><span class="p">,</span>  <span class="mf">2.443315711809948E-005</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">_PS_CONST</span><span class="p">(</span><span class="n">coscof_p1</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.388731625493765E-003</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">_PS_CONST</span><span class="p">(</span><span class="n">coscof_p2</span><span class="p">,</span>  <span class="mf">4.166664568298827E-002</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">_PS_CONST</span><span class="p">(</span><span class="n">cephes_FOPI</span><span class="p">,</span> <span class="mf">1.27323954473516</span><span class="p">);</span> <span class="o">//</span> <span class="mi">4</span> <span class="o">/</span> <span class="n">M_PI</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">/*</span> <span class="n">evaluation</span> <span class="n">of</span> <span class="mi">4</span> <span class="n">sines</span> <span class="n">at</span> <span class="n">onces</span><span class="p">,</span> <span class="n">using</span> <span class="n">only</span> <span class="n">SSE1</span><span class="o">+</span><span class="n">MMX</span> <span class="n">intrinsics</span> <span class="n">so</span>
</span></span><span class="line"><span class="cl">   <span class="n">it</span> <span class="n">runs</span> <span class="n">also</span> <span class="n">on</span> <span class="n">old</span> <span class="n">athlons</span> <span class="n">XPs</span> <span class="ow">and</span> <span class="n">the</span> <span class="n">pentium</span> <span class="n">III</span> <span class="n">of</span> <span class="n">your</span> <span class="n">grand</span>
</span></span><span class="line"><span class="cl">   <span class="n">mother</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="n">The</span> <span class="n">code</span> <span class="n">is</span> <span class="n">the</span> <span class="n">exact</span> <span class="n">rewriting</span> <span class="n">of</span> <span class="n">the</span> <span class="n">cephes</span> <span class="n">sinf</span> <span class="n">function</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">   <span class="n">Precision</span> <span class="n">is</span> <span class="n">excellent</span> <span class="n">as</span> <span class="n">long</span> <span class="n">as</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">8192</span> <span class="p">(</span><span class="n">I</span> <span class="n">did</span> <span class="ow">not</span> <span class="n">bother</span> <span class="n">to</span>
</span></span><span class="line"><span class="cl">   <span class="n">take</span> <span class="n">into</span> <span class="n">account</span> <span class="n">the</span> <span class="n">special</span> <span class="n">handling</span> <span class="n">they</span> <span class="n">have</span> <span class="k">for</span> <span class="n">greater</span> <span class="n">values</span>
</span></span><span class="line"><span class="cl">   <span class="o">--</span> <span class="n">it</span> <span class="n">does</span> <span class="ow">not</span> <span class="k">return</span> <span class="n">garbage</span> <span class="k">for</span> <span class="n">arguments</span> <span class="n">over</span> <span class="mi">8192</span><span class="p">,</span> <span class="n">though</span><span class="p">,</span> <span class="n">but</span>
</span></span><span class="line"><span class="cl">   <span class="n">the</span> <span class="n">extra</span> <span class="n">precision</span> <span class="n">is</span> <span class="n">missing</span><span class="p">)</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="n">Note</span> <span class="n">that</span> <span class="n">it</span> <span class="n">is</span> <span class="n">such</span> <span class="n">that</span> <span class="n">sinf</span><span class="p">((</span><span class="ne">float</span><span class="p">)</span><span class="n">M_PI</span><span class="p">)</span> <span class="o">=</span> <span class="mf">8.74e-8</span><span class="p">,</span> <span class="n">which</span> <span class="n">is</span> <span class="n">the</span>
</span></span><span class="line"><span class="cl">   <span class="n">surprising</span> <span class="n">but</span> <span class="n">correct</span> <span class="n">result</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="ne">Performance</span> <span class="n">is</span> <span class="n">also</span> <span class="n">surprisingly</span> <span class="n">good</span><span class="p">,</span> <span class="mf">1.33</span> <span class="n">times</span> <span class="n">faster</span> <span class="n">than</span> <span class="n">the</span>
</span></span><span class="line"><span class="cl">   <span class="n">macos</span> <span class="n">vsinf</span> <span class="n">SSE2</span> <span class="n">function</span><span class="p">,</span> <span class="ow">and</span> <span class="mf">1.5</span> <span class="n">times</span> <span class="n">faster</span> <span class="n">than</span> <span class="n">the</span>
</span></span><span class="line"><span class="cl">   <span class="n">__vrs4_sinf</span> <span class="n">of</span> <span class="n">amd</span><span class="s1">&#39;s ACML (which is only available in 64 bits). Not</span>
</span></span><span class="line"><span class="cl">   <span class="n">too</span> <span class="n">bad</span> <span class="k">for</span> <span class="n">an</span> <span class="n">SSE1</span> <span class="n">function</span> <span class="p">(</span><span class="n">with</span> <span class="n">no</span> <span class="n">special</span> <span class="n">tuning</span><span class="p">)</span> <span class="o">!</span>
</span></span><span class="line"><span class="cl">   <span class="n">However</span> <span class="n">the</span> <span class="n">latter</span> <span class="n">libraries</span> <span class="n">probably</span> <span class="n">have</span> <span class="n">a</span> <span class="n">much</span> <span class="n">better</span> <span class="n">handling</span> <span class="n">of</span> <span class="n">NaN</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="n">Inf</span><span class="p">,</span> <span class="n">denormalized</span> <span class="ow">and</span> <span class="n">other</span> <span class="n">special</span> <span class="n">arguments</span><span class="o">..</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="n">On</span> <span class="n">my</span> <span class="n">core</span> <span class="mi">1</span> <span class="n">duo</span><span class="p">,</span> <span class="n">the</span> <span class="n">execution</span> <span class="n">of</span> <span class="n">this</span> <span class="n">function</span> <span class="n">takes</span> <span class="n">approximately</span> <span class="mi">95</span> <span class="n">cycles</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="n">From</span> <span class="n">what</span> <span class="n">I</span> <span class="n">have</span> <span class="n">observed</span> <span class="n">on</span> <span class="n">the</span> <span class="n">experiments</span> <span class="n">with</span> <span class="n">Intel</span> <span class="n">AMath</span> <span class="n">lib</span><span class="p">,</span> <span class="n">switching</span> <span class="n">to</span> <span class="n">an</span>
</span></span><span class="line"><span class="cl">   <span class="n">SSE2</span> <span class="n">version</span> <span class="n">would</span> <span class="n">improve</span> <span class="n">the</span> <span class="n">perf</span> <span class="n">by</span> <span class="n">only</span> <span class="mi">10</span><span class="o">%.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="n">Since</span> <span class="n">it</span> <span class="n">is</span> <span class="n">based</span> <span class="n">on</span> <span class="n">SSE</span> <span class="n">intrinsics</span><span class="p">,</span> <span class="n">it</span> <span class="n">has</span> <span class="n">to</span> <span class="n">be</span> <span class="n">compiled</span> <span class="n">at</span> <span class="o">-</span><span class="n">O2</span> <span class="n">to</span>
</span></span><span class="line"><span class="cl">   <span class="n">deliver</span> <span class="n">full</span> <span class="n">speed</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"><span class="o">*/</span>
</span></span><span class="line"><span class="cl"><span class="n">v4sf</span> <span class="n">sin_ps</span><span class="p">(</span><span class="n">v4sf</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span> <span class="o">//</span> <span class="n">any</span> <span class="n">x</span>
</span></span><span class="line"><span class="cl">  <span class="n">v4sf</span> <span class="n">xmm1</span><span class="p">,</span> <span class="n">xmm2</span> <span class="o">=</span> <span class="n">_mm_setzero_ps</span><span class="p">(),</span> <span class="n">xmm3</span><span class="p">,</span> <span class="n">sign_bit</span><span class="p">,</span> <span class="n">y</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#ifdef USE_SSE2</span>
</span></span><span class="line"><span class="cl">  <span class="n">v4si</span> <span class="n">emm0</span><span class="p">,</span> <span class="n">emm2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#else</span>
</span></span><span class="line"><span class="cl">  <span class="n">v2si</span> <span class="n">mm0</span><span class="p">,</span> <span class="n">mm1</span><span class="p">,</span> <span class="n">mm2</span><span class="p">,</span> <span class="n">mm3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#endif</span>
</span></span><span class="line"><span class="cl">  <span class="n">sign_bit</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">/*</span> <span class="n">take</span> <span class="n">the</span> <span class="n">absolute</span> <span class="n">value</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">  <span class="n">x</span> <span class="o">=</span> <span class="n">_mm_and_ps</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v4sf</span><span class="o">*</span><span class="p">)</span><span class="n">_ps_inv_sign_mask</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">/*</span> <span class="n">extract</span> <span class="n">the</span> <span class="nb">sign</span> <span class="n">bit</span> <span class="p">(</span><span class="n">upper</span> <span class="n">one</span><span class="p">)</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">  <span class="n">sign_bit</span> <span class="o">=</span> <span class="n">_mm_and_ps</span><span class="p">(</span><span class="n">sign_bit</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v4sf</span><span class="o">*</span><span class="p">)</span><span class="n">_ps_sign_mask</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="o">/*</span> <span class="n">scale</span> <span class="n">by</span> <span class="mi">4</span><span class="o">/</span><span class="n">Pi</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">_mm_mul_ps</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v4sf</span><span class="o">*</span><span class="p">)</span><span class="n">_ps_cephes_FOPI</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#ifdef USE_SSE2</span>
</span></span><span class="line"><span class="cl">  <span class="o">/*</span> <span class="n">store</span> <span class="n">the</span> <span class="n">integer</span> <span class="n">part</span> <span class="n">of</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">mm0</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">  <span class="n">emm2</span> <span class="o">=</span> <span class="n">_mm_cvttps_epi32</span><span class="p">(</span><span class="n">y</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">/*</span> <span class="n">j</span><span class="o">=</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mi">1</span><span class="p">)</span> <span class="p">(</span><span class="n">see</span> <span class="n">the</span> <span class="n">cephes</span> <span class="n">sources</span><span class="p">)</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">  <span class="n">emm2</span> <span class="o">=</span> <span class="n">_mm_add_epi32</span><span class="p">(</span><span class="n">emm2</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v4si</span><span class="o">*</span><span class="p">)</span><span class="n">_pi32_1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">emm2</span> <span class="o">=</span> <span class="n">_mm_and_si128</span><span class="p">(</span><span class="n">emm2</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v4si</span><span class="o">*</span><span class="p">)</span><span class="n">_pi32_inv1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">_mm_cvtepi32_ps</span><span class="p">(</span><span class="n">emm2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="o">/*</span> <span class="n">get</span> <span class="n">the</span> <span class="n">swap</span> <span class="nb">sign</span> <span class="n">flag</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">  <span class="n">emm0</span> <span class="o">=</span> <span class="n">_mm_and_si128</span><span class="p">(</span><span class="n">emm2</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v4si</span><span class="o">*</span><span class="p">)</span><span class="n">_pi32_4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">emm0</span> <span class="o">=</span> <span class="n">_mm_slli_epi32</span><span class="p">(</span><span class="n">emm0</span><span class="p">,</span> <span class="mi">29</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">/*</span> <span class="n">get</span> <span class="n">the</span> <span class="n">polynom</span> <span class="n">selection</span> <span class="n">mask</span> 
</span></span><span class="line"><span class="cl">     <span class="n">there</span> <span class="n">is</span> <span class="n">one</span> <span class="n">polynom</span> <span class="k">for</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="n">Pi</span><span class="o">/</span><span class="mi">4</span>
</span></span><span class="line"><span class="cl">     <span class="ow">and</span> <span class="n">another</span> <span class="n">one</span> <span class="k">for</span> <span class="n">Pi</span><span class="o">/</span><span class="mi">4</span><span class="o">&lt;</span><span class="n">x</span><span class="o">&lt;=</span><span class="n">Pi</span><span class="o">/</span><span class="mi">2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     <span class="n">Both</span> <span class="n">branches</span> <span class="n">will</span> <span class="n">be</span> <span class="n">computed</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">  <span class="o">*/</span>
</span></span><span class="line"><span class="cl">  <span class="n">emm2</span> <span class="o">=</span> <span class="n">_mm_and_si128</span><span class="p">(</span><span class="n">emm2</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v4si</span><span class="o">*</span><span class="p">)</span><span class="n">_pi32_2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">emm2</span> <span class="o">=</span> <span class="n">_mm_cmpeq_epi32</span><span class="p">(</span><span class="n">emm2</span><span class="p">,</span> <span class="n">_mm_setzero_si128</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="n">v4sf</span> <span class="n">swap_sign_bit</span> <span class="o">=</span> <span class="n">_mm_castsi128_ps</span><span class="p">(</span><span class="n">emm0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">v4sf</span> <span class="n">poly_mask</span> <span class="o">=</span> <span class="n">_mm_castsi128_ps</span><span class="p">(</span><span class="n">emm2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">sign_bit</span> <span class="o">=</span> <span class="n">_mm_xor_ps</span><span class="p">(</span><span class="n">sign_bit</span><span class="p">,</span> <span class="n">swap_sign_bit</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="c1">#else</span>
</span></span><span class="line"><span class="cl">  <span class="o">/*</span> <span class="n">store</span> <span class="n">the</span> <span class="n">integer</span> <span class="n">part</span> <span class="n">of</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">mm0</span><span class="p">:</span><span class="n">mm1</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">  <span class="n">xmm2</span> <span class="o">=</span> <span class="n">_mm_movehl_ps</span><span class="p">(</span><span class="n">xmm2</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">mm2</span> <span class="o">=</span> <span class="n">_mm_cvttps_pi32</span><span class="p">(</span><span class="n">y</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">mm3</span> <span class="o">=</span> <span class="n">_mm_cvttps_pi32</span><span class="p">(</span><span class="n">xmm2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">/*</span> <span class="n">j</span><span class="o">=</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mi">1</span><span class="p">)</span> <span class="p">(</span><span class="n">see</span> <span class="n">the</span> <span class="n">cephes</span> <span class="n">sources</span><span class="p">)</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">  <span class="n">mm2</span> <span class="o">=</span> <span class="n">_mm_add_pi32</span><span class="p">(</span><span class="n">mm2</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v2si</span><span class="o">*</span><span class="p">)</span><span class="n">_pi32_1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">mm3</span> <span class="o">=</span> <span class="n">_mm_add_pi32</span><span class="p">(</span><span class="n">mm3</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v2si</span><span class="o">*</span><span class="p">)</span><span class="n">_pi32_1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">mm2</span> <span class="o">=</span> <span class="n">_mm_and_si64</span><span class="p">(</span><span class="n">mm2</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v2si</span><span class="o">*</span><span class="p">)</span><span class="n">_pi32_inv1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">mm3</span> <span class="o">=</span> <span class="n">_mm_and_si64</span><span class="p">(</span><span class="n">mm3</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v2si</span><span class="o">*</span><span class="p">)</span><span class="n">_pi32_inv1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">_mm_cvtpi32x2_ps</span><span class="p">(</span><span class="n">mm2</span><span class="p">,</span> <span class="n">mm3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">/*</span> <span class="n">get</span> <span class="n">the</span> <span class="n">swap</span> <span class="nb">sign</span> <span class="n">flag</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">  <span class="n">mm0</span> <span class="o">=</span> <span class="n">_mm_and_si64</span><span class="p">(</span><span class="n">mm2</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v2si</span><span class="o">*</span><span class="p">)</span><span class="n">_pi32_4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">mm1</span> <span class="o">=</span> <span class="n">_mm_and_si64</span><span class="p">(</span><span class="n">mm3</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v2si</span><span class="o">*</span><span class="p">)</span><span class="n">_pi32_4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">mm0</span> <span class="o">=</span> <span class="n">_mm_slli_pi32</span><span class="p">(</span><span class="n">mm0</span><span class="p">,</span> <span class="mi">29</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">mm1</span> <span class="o">=</span> <span class="n">_mm_slli_pi32</span><span class="p">(</span><span class="n">mm1</span><span class="p">,</span> <span class="mi">29</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">/*</span> <span class="n">get</span> <span class="n">the</span> <span class="n">polynom</span> <span class="n">selection</span> <span class="n">mask</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">  <span class="n">mm2</span> <span class="o">=</span> <span class="n">_mm_and_si64</span><span class="p">(</span><span class="n">mm2</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v2si</span><span class="o">*</span><span class="p">)</span><span class="n">_pi32_2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">mm3</span> <span class="o">=</span> <span class="n">_mm_and_si64</span><span class="p">(</span><span class="n">mm3</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v2si</span><span class="o">*</span><span class="p">)</span><span class="n">_pi32_2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">mm2</span> <span class="o">=</span> <span class="n">_mm_cmpeq_pi32</span><span class="p">(</span><span class="n">mm2</span><span class="p">,</span> <span class="n">_mm_setzero_si64</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">  <span class="n">mm3</span> <span class="o">=</span> <span class="n">_mm_cmpeq_pi32</span><span class="p">(</span><span class="n">mm3</span><span class="p">,</span> <span class="n">_mm_setzero_si64</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">  <span class="n">v4sf</span> <span class="n">swap_sign_bit</span><span class="p">,</span> <span class="n">poly_mask</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">COPY_MM_TO_XMM</span><span class="p">(</span><span class="n">mm0</span><span class="p">,</span> <span class="n">mm1</span><span class="p">,</span> <span class="n">swap_sign_bit</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">COPY_MM_TO_XMM</span><span class="p">(</span><span class="n">mm2</span><span class="p">,</span> <span class="n">mm3</span><span class="p">,</span> <span class="n">poly_mask</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">sign_bit</span> <span class="o">=</span> <span class="n">_mm_xor_ps</span><span class="p">(</span><span class="n">sign_bit</span><span class="p">,</span> <span class="n">swap_sign_bit</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">_mm_empty</span><span class="p">();</span> <span class="o">/*</span> <span class="n">good</span><span class="o">-</span><span class="n">bye</span> <span class="n">mmx</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl"><span class="c1">#endif</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="o">/*</span> <span class="n">The</span> <span class="n">magic</span> <span class="k">pass</span><span class="p">:</span> <span class="s2">&#34;Extended precision modular arithmetic&#34;</span> 
</span></span><span class="line"><span class="cl">     <span class="n">x</span> <span class="o">=</span> <span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">y</span> <span class="o">*</span> <span class="n">DP1</span><span class="p">)</span> <span class="o">-</span> <span class="n">y</span> <span class="o">*</span> <span class="n">DP2</span><span class="p">)</span> <span class="o">-</span> <span class="n">y</span> <span class="o">*</span> <span class="n">DP3</span><span class="p">;</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">  <span class="n">xmm1</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">v4sf</span><span class="o">*</span><span class="p">)</span><span class="n">_ps_minus_cephes_DP1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">xmm2</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">v4sf</span><span class="o">*</span><span class="p">)</span><span class="n">_ps_minus_cephes_DP2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">xmm3</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">v4sf</span><span class="o">*</span><span class="p">)</span><span class="n">_ps_minus_cephes_DP3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">xmm1</span> <span class="o">=</span> <span class="n">_mm_mul_ps</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">xmm1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">xmm2</span> <span class="o">=</span> <span class="n">_mm_mul_ps</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">xmm2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">xmm3</span> <span class="o">=</span> <span class="n">_mm_mul_ps</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">xmm3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">x</span> <span class="o">=</span> <span class="n">_mm_add_ps</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">xmm1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">x</span> <span class="o">=</span> <span class="n">_mm_add_ps</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">xmm2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">x</span> <span class="o">=</span> <span class="n">_mm_add_ps</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">xmm3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="o">/*</span> <span class="n">Evaluate</span> <span class="n">the</span> <span class="n">first</span> <span class="n">polynom</span>  <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="n">Pi</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">v4sf</span><span class="o">*</span><span class="p">)</span><span class="n">_ps_coscof_p0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">v4sf</span> <span class="n">z</span> <span class="o">=</span> <span class="n">_mm_mul_ps</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">x</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">_mm_mul_ps</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">_mm_add_ps</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v4sf</span><span class="o">*</span><span class="p">)</span><span class="n">_ps_coscof_p1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">_mm_mul_ps</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">_mm_add_ps</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v4sf</span><span class="o">*</span><span class="p">)</span><span class="n">_ps_coscof_p2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">_mm_mul_ps</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">_mm_mul_ps</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">v4sf</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">_mm_mul_ps</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v4sf</span><span class="o">*</span><span class="p">)</span><span class="n">_ps_0p5</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">_mm_sub_ps</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">_mm_add_ps</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v4sf</span><span class="o">*</span><span class="p">)</span><span class="n">_ps_1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="o">/*</span> <span class="n">Evaluate</span> <span class="n">the</span> <span class="n">second</span> <span class="n">polynom</span>  <span class="p">(</span><span class="n">Pi</span><span class="o">/</span><span class="mi">4</span> <span class="o">&lt;=</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">v4sf</span> <span class="n">y2</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">v4sf</span><span class="o">*</span><span class="p">)</span><span class="n">_ps_sincof_p0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">y2</span> <span class="o">=</span> <span class="n">_mm_mul_ps</span><span class="p">(</span><span class="n">y2</span><span class="p">,</span> <span class="n">z</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y2</span> <span class="o">=</span> <span class="n">_mm_add_ps</span><span class="p">(</span><span class="n">y2</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v4sf</span><span class="o">*</span><span class="p">)</span><span class="n">_ps_sincof_p1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y2</span> <span class="o">=</span> <span class="n">_mm_mul_ps</span><span class="p">(</span><span class="n">y2</span><span class="p">,</span> <span class="n">z</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y2</span> <span class="o">=</span> <span class="n">_mm_add_ps</span><span class="p">(</span><span class="n">y2</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v4sf</span><span class="o">*</span><span class="p">)</span><span class="n">_ps_sincof_p2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y2</span> <span class="o">=</span> <span class="n">_mm_mul_ps</span><span class="p">(</span><span class="n">y2</span><span class="p">,</span> <span class="n">z</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y2</span> <span class="o">=</span> <span class="n">_mm_mul_ps</span><span class="p">(</span><span class="n">y2</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y2</span> <span class="o">=</span> <span class="n">_mm_add_ps</span><span class="p">(</span><span class="n">y2</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="o">/*</span> <span class="n">select</span> <span class="n">the</span> <span class="n">correct</span> <span class="n">result</span> <span class="n">from</span> <span class="n">the</span> <span class="n">two</span> <span class="n">polynoms</span> <span class="o">*/</span>  
</span></span><span class="line"><span class="cl">  <span class="n">xmm3</span> <span class="o">=</span> <span class="n">poly_mask</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">y2</span> <span class="o">=</span> <span class="n">_mm_and_ps</span><span class="p">(</span><span class="n">xmm3</span><span class="p">,</span> <span class="n">y2</span><span class="p">);</span> <span class="o">//</span><span class="p">,</span> <span class="n">xmm3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">_mm_andnot_ps</span><span class="p">(</span><span class="n">xmm3</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">_mm_add_ps</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">y2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">/*</span> <span class="n">update</span> <span class="n">the</span> <span class="nb">sign</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">_mm_xor_ps</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">sign_bit</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">y</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">/*</span> <span class="n">almost</span> <span class="n">the</span> <span class="n">same</span> <span class="n">as</span> <span class="n">sin_ps</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl"><span class="n">v4sf</span> <span class="n">cos_ps</span><span class="p">(</span><span class="n">v4sf</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span> <span class="o">//</span> <span class="n">any</span> <span class="n">x</span>
</span></span><span class="line"><span class="cl">  <span class="n">v4sf</span> <span class="n">xmm1</span><span class="p">,</span> <span class="n">xmm2</span> <span class="o">=</span> <span class="n">_mm_setzero_ps</span><span class="p">(),</span> <span class="n">xmm3</span><span class="p">,</span> <span class="n">y</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#ifdef USE_SSE2</span>
</span></span><span class="line"><span class="cl">  <span class="n">v4si</span> <span class="n">emm0</span><span class="p">,</span> <span class="n">emm2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#else</span>
</span></span><span class="line"><span class="cl">  <span class="n">v2si</span> <span class="n">mm0</span><span class="p">,</span> <span class="n">mm1</span><span class="p">,</span> <span class="n">mm2</span><span class="p">,</span> <span class="n">mm3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#endif</span>
</span></span><span class="line"><span class="cl">  <span class="o">/*</span> <span class="n">take</span> <span class="n">the</span> <span class="n">absolute</span> <span class="n">value</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">  <span class="n">x</span> <span class="o">=</span> <span class="n">_mm_and_ps</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v4sf</span><span class="o">*</span><span class="p">)</span><span class="n">_ps_inv_sign_mask</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="o">/*</span> <span class="n">scale</span> <span class="n">by</span> <span class="mi">4</span><span class="o">/</span><span class="n">Pi</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">_mm_mul_ps</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v4sf</span><span class="o">*</span><span class="p">)</span><span class="n">_ps_cephes_FOPI</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="c1">#ifdef USE_SSE2</span>
</span></span><span class="line"><span class="cl">  <span class="o">/*</span> <span class="n">store</span> <span class="n">the</span> <span class="n">integer</span> <span class="n">part</span> <span class="n">of</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">mm0</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">  <span class="n">emm2</span> <span class="o">=</span> <span class="n">_mm_cvttps_epi32</span><span class="p">(</span><span class="n">y</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">/*</span> <span class="n">j</span><span class="o">=</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mi">1</span><span class="p">)</span> <span class="p">(</span><span class="n">see</span> <span class="n">the</span> <span class="n">cephes</span> <span class="n">sources</span><span class="p">)</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">  <span class="n">emm2</span> <span class="o">=</span> <span class="n">_mm_add_epi32</span><span class="p">(</span><span class="n">emm2</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v4si</span><span class="o">*</span><span class="p">)</span><span class="n">_pi32_1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">emm2</span> <span class="o">=</span> <span class="n">_mm_and_si128</span><span class="p">(</span><span class="n">emm2</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v4si</span><span class="o">*</span><span class="p">)</span><span class="n">_pi32_inv1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">_mm_cvtepi32_ps</span><span class="p">(</span><span class="n">emm2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">emm2</span> <span class="o">=</span> <span class="n">_mm_sub_epi32</span><span class="p">(</span><span class="n">emm2</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v4si</span><span class="o">*</span><span class="p">)</span><span class="n">_pi32_2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="o">/*</span> <span class="n">get</span> <span class="n">the</span> <span class="n">swap</span> <span class="nb">sign</span> <span class="n">flag</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">  <span class="n">emm0</span> <span class="o">=</span> <span class="n">_mm_andnot_si128</span><span class="p">(</span><span class="n">emm2</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v4si</span><span class="o">*</span><span class="p">)</span><span class="n">_pi32_4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">emm0</span> <span class="o">=</span> <span class="n">_mm_slli_epi32</span><span class="p">(</span><span class="n">emm0</span><span class="p">,</span> <span class="mi">29</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">/*</span> <span class="n">get</span> <span class="n">the</span> <span class="n">polynom</span> <span class="n">selection</span> <span class="n">mask</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">  <span class="n">emm2</span> <span class="o">=</span> <span class="n">_mm_and_si128</span><span class="p">(</span><span class="n">emm2</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v4si</span><span class="o">*</span><span class="p">)</span><span class="n">_pi32_2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">emm2</span> <span class="o">=</span> <span class="n">_mm_cmpeq_epi32</span><span class="p">(</span><span class="n">emm2</span><span class="p">,</span> <span class="n">_mm_setzero_si128</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="n">v4sf</span> <span class="n">sign_bit</span> <span class="o">=</span> <span class="n">_mm_castsi128_ps</span><span class="p">(</span><span class="n">emm0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">v4sf</span> <span class="n">poly_mask</span> <span class="o">=</span> <span class="n">_mm_castsi128_ps</span><span class="p">(</span><span class="n">emm2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">#else</span>
</span></span><span class="line"><span class="cl">  <span class="o">/*</span> <span class="n">store</span> <span class="n">the</span> <span class="n">integer</span> <span class="n">part</span> <span class="n">of</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">mm0</span><span class="p">:</span><span class="n">mm1</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">  <span class="n">xmm2</span> <span class="o">=</span> <span class="n">_mm_movehl_ps</span><span class="p">(</span><span class="n">xmm2</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">mm2</span> <span class="o">=</span> <span class="n">_mm_cvttps_pi32</span><span class="p">(</span><span class="n">y</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">mm3</span> <span class="o">=</span> <span class="n">_mm_cvttps_pi32</span><span class="p">(</span><span class="n">xmm2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="o">/*</span> <span class="n">j</span><span class="o">=</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mi">1</span><span class="p">)</span> <span class="p">(</span><span class="n">see</span> <span class="n">the</span> <span class="n">cephes</span> <span class="n">sources</span><span class="p">)</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">  <span class="n">mm2</span> <span class="o">=</span> <span class="n">_mm_add_pi32</span><span class="p">(</span><span class="n">mm2</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v2si</span><span class="o">*</span><span class="p">)</span><span class="n">_pi32_1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">mm3</span> <span class="o">=</span> <span class="n">_mm_add_pi32</span><span class="p">(</span><span class="n">mm3</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v2si</span><span class="o">*</span><span class="p">)</span><span class="n">_pi32_1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">mm2</span> <span class="o">=</span> <span class="n">_mm_and_si64</span><span class="p">(</span><span class="n">mm2</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v2si</span><span class="o">*</span><span class="p">)</span><span class="n">_pi32_inv1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">mm3</span> <span class="o">=</span> <span class="n">_mm_and_si64</span><span class="p">(</span><span class="n">mm3</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v2si</span><span class="o">*</span><span class="p">)</span><span class="n">_pi32_inv1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">_mm_cvtpi32x2_ps</span><span class="p">(</span><span class="n">mm2</span><span class="p">,</span> <span class="n">mm3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">mm2</span> <span class="o">=</span> <span class="n">_mm_sub_pi32</span><span class="p">(</span><span class="n">mm2</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v2si</span><span class="o">*</span><span class="p">)</span><span class="n">_pi32_2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">mm3</span> <span class="o">=</span> <span class="n">_mm_sub_pi32</span><span class="p">(</span><span class="n">mm3</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v2si</span><span class="o">*</span><span class="p">)</span><span class="n">_pi32_2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="o">/*</span> <span class="n">get</span> <span class="n">the</span> <span class="n">swap</span> <span class="nb">sign</span> <span class="n">flag</span> <span class="ow">in</span> <span class="n">mm0</span><span class="p">:</span><span class="n">mm1</span> <span class="ow">and</span> <span class="n">the</span> 
</span></span><span class="line"><span class="cl">     <span class="n">polynom</span> <span class="n">selection</span> <span class="n">mask</span> <span class="ow">in</span> <span class="n">mm2</span><span class="p">:</span><span class="n">mm3</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">mm0</span> <span class="o">=</span> <span class="n">_mm_andnot_si64</span><span class="p">(</span><span class="n">mm2</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v2si</span><span class="o">*</span><span class="p">)</span><span class="n">_pi32_4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">mm1</span> <span class="o">=</span> <span class="n">_mm_andnot_si64</span><span class="p">(</span><span class="n">mm3</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v2si</span><span class="o">*</span><span class="p">)</span><span class="n">_pi32_4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">mm0</span> <span class="o">=</span> <span class="n">_mm_slli_pi32</span><span class="p">(</span><span class="n">mm0</span><span class="p">,</span> <span class="mi">29</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">mm1</span> <span class="o">=</span> <span class="n">_mm_slli_pi32</span><span class="p">(</span><span class="n">mm1</span><span class="p">,</span> <span class="mi">29</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">mm2</span> <span class="o">=</span> <span class="n">_mm_and_si64</span><span class="p">(</span><span class="n">mm2</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v2si</span><span class="o">*</span><span class="p">)</span><span class="n">_pi32_2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">mm3</span> <span class="o">=</span> <span class="n">_mm_and_si64</span><span class="p">(</span><span class="n">mm3</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v2si</span><span class="o">*</span><span class="p">)</span><span class="n">_pi32_2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">mm2</span> <span class="o">=</span> <span class="n">_mm_cmpeq_pi32</span><span class="p">(</span><span class="n">mm2</span><span class="p">,</span> <span class="n">_mm_setzero_si64</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">  <span class="n">mm3</span> <span class="o">=</span> <span class="n">_mm_cmpeq_pi32</span><span class="p">(</span><span class="n">mm3</span><span class="p">,</span> <span class="n">_mm_setzero_si64</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">v4sf</span> <span class="n">sign_bit</span><span class="p">,</span> <span class="n">poly_mask</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">COPY_MM_TO_XMM</span><span class="p">(</span><span class="n">mm0</span><span class="p">,</span> <span class="n">mm1</span><span class="p">,</span> <span class="n">sign_bit</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">COPY_MM_TO_XMM</span><span class="p">(</span><span class="n">mm2</span><span class="p">,</span> <span class="n">mm3</span><span class="p">,</span> <span class="n">poly_mask</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">_mm_empty</span><span class="p">();</span> <span class="o">/*</span> <span class="n">good</span><span class="o">-</span><span class="n">bye</span> <span class="n">mmx</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl"><span class="c1">#endif</span>
</span></span><span class="line"><span class="cl">  <span class="o">/*</span> <span class="n">The</span> <span class="n">magic</span> <span class="k">pass</span><span class="p">:</span> <span class="s2">&#34;Extended precision modular arithmetic&#34;</span> 
</span></span><span class="line"><span class="cl">     <span class="n">x</span> <span class="o">=</span> <span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">y</span> <span class="o">*</span> <span class="n">DP1</span><span class="p">)</span> <span class="o">-</span> <span class="n">y</span> <span class="o">*</span> <span class="n">DP2</span><span class="p">)</span> <span class="o">-</span> <span class="n">y</span> <span class="o">*</span> <span class="n">DP3</span><span class="p">;</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">  <span class="n">xmm1</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">v4sf</span><span class="o">*</span><span class="p">)</span><span class="n">_ps_minus_cephes_DP1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">xmm2</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">v4sf</span><span class="o">*</span><span class="p">)</span><span class="n">_ps_minus_cephes_DP2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">xmm3</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">v4sf</span><span class="o">*</span><span class="p">)</span><span class="n">_ps_minus_cephes_DP3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">xmm1</span> <span class="o">=</span> <span class="n">_mm_mul_ps</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">xmm1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">xmm2</span> <span class="o">=</span> <span class="n">_mm_mul_ps</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">xmm2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">xmm3</span> <span class="o">=</span> <span class="n">_mm_mul_ps</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">xmm3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">x</span> <span class="o">=</span> <span class="n">_mm_add_ps</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">xmm1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">x</span> <span class="o">=</span> <span class="n">_mm_add_ps</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">xmm2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">x</span> <span class="o">=</span> <span class="n">_mm_add_ps</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">xmm3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="o">/*</span> <span class="n">Evaluate</span> <span class="n">the</span> <span class="n">first</span> <span class="n">polynom</span>  <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="n">Pi</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">v4sf</span><span class="o">*</span><span class="p">)</span><span class="n">_ps_coscof_p0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">v4sf</span> <span class="n">z</span> <span class="o">=</span> <span class="n">_mm_mul_ps</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">x</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">_mm_mul_ps</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">_mm_add_ps</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v4sf</span><span class="o">*</span><span class="p">)</span><span class="n">_ps_coscof_p1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">_mm_mul_ps</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">_mm_add_ps</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v4sf</span><span class="o">*</span><span class="p">)</span><span class="n">_ps_coscof_p2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">_mm_mul_ps</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">_mm_mul_ps</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">v4sf</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">_mm_mul_ps</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v4sf</span><span class="o">*</span><span class="p">)</span><span class="n">_ps_0p5</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">_mm_sub_ps</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">_mm_add_ps</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v4sf</span><span class="o">*</span><span class="p">)</span><span class="n">_ps_1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="o">/*</span> <span class="n">Evaluate</span> <span class="n">the</span> <span class="n">second</span> <span class="n">polynom</span>  <span class="p">(</span><span class="n">Pi</span><span class="o">/</span><span class="mi">4</span> <span class="o">&lt;=</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">v4sf</span> <span class="n">y2</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">v4sf</span><span class="o">*</span><span class="p">)</span><span class="n">_ps_sincof_p0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">y2</span> <span class="o">=</span> <span class="n">_mm_mul_ps</span><span class="p">(</span><span class="n">y2</span><span class="p">,</span> <span class="n">z</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y2</span> <span class="o">=</span> <span class="n">_mm_add_ps</span><span class="p">(</span><span class="n">y2</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v4sf</span><span class="o">*</span><span class="p">)</span><span class="n">_ps_sincof_p1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y2</span> <span class="o">=</span> <span class="n">_mm_mul_ps</span><span class="p">(</span><span class="n">y2</span><span class="p">,</span> <span class="n">z</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y2</span> <span class="o">=</span> <span class="n">_mm_add_ps</span><span class="p">(</span><span class="n">y2</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v4sf</span><span class="o">*</span><span class="p">)</span><span class="n">_ps_sincof_p2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y2</span> <span class="o">=</span> <span class="n">_mm_mul_ps</span><span class="p">(</span><span class="n">y2</span><span class="p">,</span> <span class="n">z</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y2</span> <span class="o">=</span> <span class="n">_mm_mul_ps</span><span class="p">(</span><span class="n">y2</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y2</span> <span class="o">=</span> <span class="n">_mm_add_ps</span><span class="p">(</span><span class="n">y2</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="o">/*</span> <span class="n">select</span> <span class="n">the</span> <span class="n">correct</span> <span class="n">result</span> <span class="n">from</span> <span class="n">the</span> <span class="n">two</span> <span class="n">polynoms</span> <span class="o">*/</span>  
</span></span><span class="line"><span class="cl">  <span class="n">xmm3</span> <span class="o">=</span> <span class="n">poly_mask</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">y2</span> <span class="o">=</span> <span class="n">_mm_and_ps</span><span class="p">(</span><span class="n">xmm3</span><span class="p">,</span> <span class="n">y2</span><span class="p">);</span> <span class="o">//</span><span class="p">,</span> <span class="n">xmm3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">_mm_andnot_ps</span><span class="p">(</span><span class="n">xmm3</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">_mm_add_ps</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">y2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">/*</span> <span class="n">update</span> <span class="n">the</span> <span class="nb">sign</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">_mm_xor_ps</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">sign_bit</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">y</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">/*</span> <span class="n">since</span> <span class="n">sin_ps</span> <span class="ow">and</span> <span class="n">cos_ps</span> <span class="n">are</span> <span class="n">almost</span> <span class="n">identical</span><span class="p">,</span> <span class="n">sincos_ps</span> <span class="n">could</span> <span class="n">replace</span> <span class="n">both</span> <span class="n">of</span> <span class="n">them</span><span class="o">..</span>
</span></span><span class="line"><span class="cl">   <span class="n">it</span> <span class="n">is</span> <span class="n">almost</span> <span class="n">as</span> <span class="n">fast</span><span class="p">,</span> <span class="ow">and</span> <span class="n">gives</span> <span class="n">you</span> <span class="n">a</span> <span class="n">free</span> <span class="n">cosine</span> <span class="n">with</span> <span class="n">your</span> <span class="n">sine</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl"><span class="n">void</span> <span class="n">sincos_ps</span><span class="p">(</span><span class="n">v4sf</span> <span class="n">x</span><span class="p">,</span> <span class="n">v4sf</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="n">v4sf</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">v4sf</span> <span class="n">xmm1</span><span class="p">,</span> <span class="n">xmm2</span><span class="p">,</span> <span class="n">xmm3</span> <span class="o">=</span> <span class="n">_mm_setzero_ps</span><span class="p">(),</span> <span class="n">sign_bit_sin</span><span class="p">,</span> <span class="n">y</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#ifdef USE_SSE2</span>
</span></span><span class="line"><span class="cl">  <span class="n">v4si</span> <span class="n">emm0</span><span class="p">,</span> <span class="n">emm2</span><span class="p">,</span> <span class="n">emm4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#else</span>
</span></span><span class="line"><span class="cl">  <span class="n">v2si</span> <span class="n">mm0</span><span class="p">,</span> <span class="n">mm1</span><span class="p">,</span> <span class="n">mm2</span><span class="p">,</span> <span class="n">mm3</span><span class="p">,</span> <span class="n">mm4</span><span class="p">,</span> <span class="n">mm5</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#endif</span>
</span></span><span class="line"><span class="cl">  <span class="n">sign_bit_sin</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">/*</span> <span class="n">take</span> <span class="n">the</span> <span class="n">absolute</span> <span class="n">value</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">  <span class="n">x</span> <span class="o">=</span> <span class="n">_mm_and_ps</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v4sf</span><span class="o">*</span><span class="p">)</span><span class="n">_ps_inv_sign_mask</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">/*</span> <span class="n">extract</span> <span class="n">the</span> <span class="nb">sign</span> <span class="n">bit</span> <span class="p">(</span><span class="n">upper</span> <span class="n">one</span><span class="p">)</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">  <span class="n">sign_bit_sin</span> <span class="o">=</span> <span class="n">_mm_and_ps</span><span class="p">(</span><span class="n">sign_bit_sin</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v4sf</span><span class="o">*</span><span class="p">)</span><span class="n">_ps_sign_mask</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="o">/*</span> <span class="n">scale</span> <span class="n">by</span> <span class="mi">4</span><span class="o">/</span><span class="n">Pi</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">_mm_mul_ps</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v4sf</span><span class="o">*</span><span class="p">)</span><span class="n">_ps_cephes_FOPI</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="c1">#ifdef USE_SSE2</span>
</span></span><span class="line"><span class="cl">  <span class="o">/*</span> <span class="n">store</span> <span class="n">the</span> <span class="n">integer</span> <span class="n">part</span> <span class="n">of</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">emm2</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">  <span class="n">emm2</span> <span class="o">=</span> <span class="n">_mm_cvttps_epi32</span><span class="p">(</span><span class="n">y</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="o">/*</span> <span class="n">j</span><span class="o">=</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mi">1</span><span class="p">)</span> <span class="p">(</span><span class="n">see</span> <span class="n">the</span> <span class="n">cephes</span> <span class="n">sources</span><span class="p">)</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">  <span class="n">emm2</span> <span class="o">=</span> <span class="n">_mm_add_epi32</span><span class="p">(</span><span class="n">emm2</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v4si</span><span class="o">*</span><span class="p">)</span><span class="n">_pi32_1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">emm2</span> <span class="o">=</span> <span class="n">_mm_and_si128</span><span class="p">(</span><span class="n">emm2</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v4si</span><span class="o">*</span><span class="p">)</span><span class="n">_pi32_inv1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">_mm_cvtepi32_ps</span><span class="p">(</span><span class="n">emm2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">emm4</span> <span class="o">=</span> <span class="n">emm2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="o">/*</span> <span class="n">get</span> <span class="n">the</span> <span class="n">swap</span> <span class="nb">sign</span> <span class="n">flag</span> <span class="k">for</span> <span class="n">the</span> <span class="n">sine</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">  <span class="n">emm0</span> <span class="o">=</span> <span class="n">_mm_and_si128</span><span class="p">(</span><span class="n">emm2</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v4si</span><span class="o">*</span><span class="p">)</span><span class="n">_pi32_4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">emm0</span> <span class="o">=</span> <span class="n">_mm_slli_epi32</span><span class="p">(</span><span class="n">emm0</span><span class="p">,</span> <span class="mi">29</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">v4sf</span> <span class="n">swap_sign_bit_sin</span> <span class="o">=</span> <span class="n">_mm_castsi128_ps</span><span class="p">(</span><span class="n">emm0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="o">/*</span> <span class="n">get</span> <span class="n">the</span> <span class="n">polynom</span> <span class="n">selection</span> <span class="n">mask</span> <span class="k">for</span> <span class="n">the</span> <span class="n">sine</span><span class="o">*/</span>
</span></span><span class="line"><span class="cl">  <span class="n">emm2</span> <span class="o">=</span> <span class="n">_mm_and_si128</span><span class="p">(</span><span class="n">emm2</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v4si</span><span class="o">*</span><span class="p">)</span><span class="n">_pi32_2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">emm2</span> <span class="o">=</span> <span class="n">_mm_cmpeq_epi32</span><span class="p">(</span><span class="n">emm2</span><span class="p">,</span> <span class="n">_mm_setzero_si128</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">  <span class="n">v4sf</span> <span class="n">poly_mask</span> <span class="o">=</span> <span class="n">_mm_castsi128_ps</span><span class="p">(</span><span class="n">emm2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">#else</span>
</span></span><span class="line"><span class="cl">  <span class="o">/*</span> <span class="n">store</span> <span class="n">the</span> <span class="n">integer</span> <span class="n">part</span> <span class="n">of</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">mm2</span><span class="p">:</span><span class="n">mm3</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">  <span class="n">xmm3</span> <span class="o">=</span> <span class="n">_mm_movehl_ps</span><span class="p">(</span><span class="n">xmm3</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">mm2</span> <span class="o">=</span> <span class="n">_mm_cvttps_pi32</span><span class="p">(</span><span class="n">y</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">mm3</span> <span class="o">=</span> <span class="n">_mm_cvttps_pi32</span><span class="p">(</span><span class="n">xmm3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="o">/*</span> <span class="n">j</span><span class="o">=</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mi">1</span><span class="p">)</span> <span class="p">(</span><span class="n">see</span> <span class="n">the</span> <span class="n">cephes</span> <span class="n">sources</span><span class="p">)</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">  <span class="n">mm2</span> <span class="o">=</span> <span class="n">_mm_add_pi32</span><span class="p">(</span><span class="n">mm2</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v2si</span><span class="o">*</span><span class="p">)</span><span class="n">_pi32_1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">mm3</span> <span class="o">=</span> <span class="n">_mm_add_pi32</span><span class="p">(</span><span class="n">mm3</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v2si</span><span class="o">*</span><span class="p">)</span><span class="n">_pi32_1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">mm2</span> <span class="o">=</span> <span class="n">_mm_and_si64</span><span class="p">(</span><span class="n">mm2</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v2si</span><span class="o">*</span><span class="p">)</span><span class="n">_pi32_inv1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">mm3</span> <span class="o">=</span> <span class="n">_mm_and_si64</span><span class="p">(</span><span class="n">mm3</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v2si</span><span class="o">*</span><span class="p">)</span><span class="n">_pi32_inv1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">_mm_cvtpi32x2_ps</span><span class="p">(</span><span class="n">mm2</span><span class="p">,</span> <span class="n">mm3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">mm4</span> <span class="o">=</span> <span class="n">mm2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">mm5</span> <span class="o">=</span> <span class="n">mm3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="o">/*</span> <span class="n">get</span> <span class="n">the</span> <span class="n">swap</span> <span class="nb">sign</span> <span class="n">flag</span> <span class="k">for</span> <span class="n">the</span> <span class="n">sine</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">  <span class="n">mm0</span> <span class="o">=</span> <span class="n">_mm_and_si64</span><span class="p">(</span><span class="n">mm2</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v2si</span><span class="o">*</span><span class="p">)</span><span class="n">_pi32_4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">mm1</span> <span class="o">=</span> <span class="n">_mm_and_si64</span><span class="p">(</span><span class="n">mm3</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v2si</span><span class="o">*</span><span class="p">)</span><span class="n">_pi32_4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">mm0</span> <span class="o">=</span> <span class="n">_mm_slli_pi32</span><span class="p">(</span><span class="n">mm0</span><span class="p">,</span> <span class="mi">29</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">mm1</span> <span class="o">=</span> <span class="n">_mm_slli_pi32</span><span class="p">(</span><span class="n">mm1</span><span class="p">,</span> <span class="mi">29</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">v4sf</span> <span class="n">swap_sign_bit_sin</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">COPY_MM_TO_XMM</span><span class="p">(</span><span class="n">mm0</span><span class="p">,</span> <span class="n">mm1</span><span class="p">,</span> <span class="n">swap_sign_bit_sin</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="o">/*</span> <span class="n">get</span> <span class="n">the</span> <span class="n">polynom</span> <span class="n">selection</span> <span class="n">mask</span> <span class="k">for</span> <span class="n">the</span> <span class="n">sine</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">mm2</span> <span class="o">=</span> <span class="n">_mm_and_si64</span><span class="p">(</span><span class="n">mm2</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v2si</span><span class="o">*</span><span class="p">)</span><span class="n">_pi32_2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">mm3</span> <span class="o">=</span> <span class="n">_mm_and_si64</span><span class="p">(</span><span class="n">mm3</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v2si</span><span class="o">*</span><span class="p">)</span><span class="n">_pi32_2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">mm2</span> <span class="o">=</span> <span class="n">_mm_cmpeq_pi32</span><span class="p">(</span><span class="n">mm2</span><span class="p">,</span> <span class="n">_mm_setzero_si64</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">  <span class="n">mm3</span> <span class="o">=</span> <span class="n">_mm_cmpeq_pi32</span><span class="p">(</span><span class="n">mm3</span><span class="p">,</span> <span class="n">_mm_setzero_si64</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">  <span class="n">v4sf</span> <span class="n">poly_mask</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">COPY_MM_TO_XMM</span><span class="p">(</span><span class="n">mm2</span><span class="p">,</span> <span class="n">mm3</span><span class="p">,</span> <span class="n">poly_mask</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">#endif</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="o">/*</span> <span class="n">The</span> <span class="n">magic</span> <span class="k">pass</span><span class="p">:</span> <span class="s2">&#34;Extended precision modular arithmetic&#34;</span> 
</span></span><span class="line"><span class="cl">     <span class="n">x</span> <span class="o">=</span> <span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">y</span> <span class="o">*</span> <span class="n">DP1</span><span class="p">)</span> <span class="o">-</span> <span class="n">y</span> <span class="o">*</span> <span class="n">DP2</span><span class="p">)</span> <span class="o">-</span> <span class="n">y</span> <span class="o">*</span> <span class="n">DP3</span><span class="p">;</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">  <span class="n">xmm1</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">v4sf</span><span class="o">*</span><span class="p">)</span><span class="n">_ps_minus_cephes_DP1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">xmm2</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">v4sf</span><span class="o">*</span><span class="p">)</span><span class="n">_ps_minus_cephes_DP2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">xmm3</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">v4sf</span><span class="o">*</span><span class="p">)</span><span class="n">_ps_minus_cephes_DP3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">xmm1</span> <span class="o">=</span> <span class="n">_mm_mul_ps</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">xmm1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">xmm2</span> <span class="o">=</span> <span class="n">_mm_mul_ps</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">xmm2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">xmm3</span> <span class="o">=</span> <span class="n">_mm_mul_ps</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">xmm3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">x</span> <span class="o">=</span> <span class="n">_mm_add_ps</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">xmm1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">x</span> <span class="o">=</span> <span class="n">_mm_add_ps</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">xmm2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">x</span> <span class="o">=</span> <span class="n">_mm_add_ps</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">xmm3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#ifdef USE_SSE2</span>
</span></span><span class="line"><span class="cl">  <span class="n">emm4</span> <span class="o">=</span> <span class="n">_mm_sub_epi32</span><span class="p">(</span><span class="n">emm4</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v4si</span><span class="o">*</span><span class="p">)</span><span class="n">_pi32_2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">emm4</span> <span class="o">=</span> <span class="n">_mm_andnot_si128</span><span class="p">(</span><span class="n">emm4</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v4si</span><span class="o">*</span><span class="p">)</span><span class="n">_pi32_4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">emm4</span> <span class="o">=</span> <span class="n">_mm_slli_epi32</span><span class="p">(</span><span class="n">emm4</span><span class="p">,</span> <span class="mi">29</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">v4sf</span> <span class="n">sign_bit_cos</span> <span class="o">=</span> <span class="n">_mm_castsi128_ps</span><span class="p">(</span><span class="n">emm4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">#else</span>
</span></span><span class="line"><span class="cl">  <span class="o">/*</span> <span class="n">get</span> <span class="n">the</span> <span class="nb">sign</span> <span class="n">flag</span> <span class="k">for</span> <span class="n">the</span> <span class="n">cosine</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">  <span class="n">mm4</span> <span class="o">=</span> <span class="n">_mm_sub_pi32</span><span class="p">(</span><span class="n">mm4</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v2si</span><span class="o">*</span><span class="p">)</span><span class="n">_pi32_2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">mm5</span> <span class="o">=</span> <span class="n">_mm_sub_pi32</span><span class="p">(</span><span class="n">mm5</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v2si</span><span class="o">*</span><span class="p">)</span><span class="n">_pi32_2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">mm4</span> <span class="o">=</span> <span class="n">_mm_andnot_si64</span><span class="p">(</span><span class="n">mm4</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v2si</span><span class="o">*</span><span class="p">)</span><span class="n">_pi32_4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">mm5</span> <span class="o">=</span> <span class="n">_mm_andnot_si64</span><span class="p">(</span><span class="n">mm5</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v2si</span><span class="o">*</span><span class="p">)</span><span class="n">_pi32_4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">mm4</span> <span class="o">=</span> <span class="n">_mm_slli_pi32</span><span class="p">(</span><span class="n">mm4</span><span class="p">,</span> <span class="mi">29</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">mm5</span> <span class="o">=</span> <span class="n">_mm_slli_pi32</span><span class="p">(</span><span class="n">mm5</span><span class="p">,</span> <span class="mi">29</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">v4sf</span> <span class="n">sign_bit_cos</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">COPY_MM_TO_XMM</span><span class="p">(</span><span class="n">mm4</span><span class="p">,</span> <span class="n">mm5</span><span class="p">,</span> <span class="n">sign_bit_cos</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">_mm_empty</span><span class="p">();</span> <span class="o">/*</span> <span class="n">good</span><span class="o">-</span><span class="n">bye</span> <span class="n">mmx</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl"><span class="c1">#endif</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">sign_bit_sin</span> <span class="o">=</span> <span class="n">_mm_xor_ps</span><span class="p">(</span><span class="n">sign_bit_sin</span><span class="p">,</span> <span class="n">swap_sign_bit_sin</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="o">/*</span> <span class="n">Evaluate</span> <span class="n">the</span> <span class="n">first</span> <span class="n">polynom</span>  <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="n">Pi</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">  <span class="n">v4sf</span> <span class="n">z</span> <span class="o">=</span> <span class="n">_mm_mul_ps</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">x</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">v4sf</span><span class="o">*</span><span class="p">)</span><span class="n">_ps_coscof_p0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">_mm_mul_ps</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">_mm_add_ps</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v4sf</span><span class="o">*</span><span class="p">)</span><span class="n">_ps_coscof_p1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">_mm_mul_ps</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">_mm_add_ps</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v4sf</span><span class="o">*</span><span class="p">)</span><span class="n">_ps_coscof_p2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">_mm_mul_ps</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">_mm_mul_ps</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">v4sf</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">_mm_mul_ps</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v4sf</span><span class="o">*</span><span class="p">)</span><span class="n">_ps_0p5</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">_mm_sub_ps</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">_mm_add_ps</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v4sf</span><span class="o">*</span><span class="p">)</span><span class="n">_ps_1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="o">/*</span> <span class="n">Evaluate</span> <span class="n">the</span> <span class="n">second</span> <span class="n">polynom</span>  <span class="p">(</span><span class="n">Pi</span><span class="o">/</span><span class="mi">4</span> <span class="o">&lt;=</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">v4sf</span> <span class="n">y2</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">v4sf</span><span class="o">*</span><span class="p">)</span><span class="n">_ps_sincof_p0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">y2</span> <span class="o">=</span> <span class="n">_mm_mul_ps</span><span class="p">(</span><span class="n">y2</span><span class="p">,</span> <span class="n">z</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y2</span> <span class="o">=</span> <span class="n">_mm_add_ps</span><span class="p">(</span><span class="n">y2</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v4sf</span><span class="o">*</span><span class="p">)</span><span class="n">_ps_sincof_p1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y2</span> <span class="o">=</span> <span class="n">_mm_mul_ps</span><span class="p">(</span><span class="n">y2</span><span class="p">,</span> <span class="n">z</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y2</span> <span class="o">=</span> <span class="n">_mm_add_ps</span><span class="p">(</span><span class="n">y2</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">v4sf</span><span class="o">*</span><span class="p">)</span><span class="n">_ps_sincof_p2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y2</span> <span class="o">=</span> <span class="n">_mm_mul_ps</span><span class="p">(</span><span class="n">y2</span><span class="p">,</span> <span class="n">z</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y2</span> <span class="o">=</span> <span class="n">_mm_mul_ps</span><span class="p">(</span><span class="n">y2</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y2</span> <span class="o">=</span> <span class="n">_mm_add_ps</span><span class="p">(</span><span class="n">y2</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="o">/*</span> <span class="n">select</span> <span class="n">the</span> <span class="n">correct</span> <span class="n">result</span> <span class="n">from</span> <span class="n">the</span> <span class="n">two</span> <span class="n">polynoms</span> <span class="o">*/</span>  
</span></span><span class="line"><span class="cl">  <span class="n">xmm3</span> <span class="o">=</span> <span class="n">poly_mask</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">v4sf</span> <span class="n">ysin2</span> <span class="o">=</span> <span class="n">_mm_and_ps</span><span class="p">(</span><span class="n">xmm3</span><span class="p">,</span> <span class="n">y2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">v4sf</span> <span class="n">ysin1</span> <span class="o">=</span> <span class="n">_mm_andnot_ps</span><span class="p">(</span><span class="n">xmm3</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y2</span> <span class="o">=</span> <span class="n">_mm_sub_ps</span><span class="p">(</span><span class="n">y2</span><span class="p">,</span><span class="n">ysin2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">_mm_sub_ps</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">ysin1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">xmm1</span> <span class="o">=</span> <span class="n">_mm_add_ps</span><span class="p">(</span><span class="n">ysin1</span><span class="p">,</span><span class="n">ysin2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">xmm2</span> <span class="o">=</span> <span class="n">_mm_add_ps</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">y2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">  <span class="o">/*</span> <span class="n">update</span> <span class="n">the</span> <span class="nb">sign</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">_mm_xor_ps</span><span class="p">(</span><span class="n">xmm1</span><span class="p">,</span> <span class="n">sign_bit_sin</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">_mm_xor_ps</span><span class="p">(</span><span class="n">xmm2</span><span class="p">,</span> <span class="n">sign_bit_cos</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div></div>
<h2 id="sse-test">sse test</h2>
<p>The test suite</p>
<div class="code-block code-line-numbers" style="counter-reset: code-block 0">
    <div class="code-header language-">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#include &lt;stdio.h&gt;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#include &lt;xmmintrin.h&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">/*</span> <span class="n">useful</span> <span class="n">when</span> <span class="n">debuggin</span><span class="o">..</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl"><span class="n">void</span> <span class="n">print4</span><span class="p">(</span><span class="n">__m128</span> <span class="n">v</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="ne">float</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="ne">float</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">v</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">  <span class="c1">#ifndef USE_SSE2</span>
</span></span><span class="line"><span class="cl">  <span class="n">_mm_empty</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="c1">#endif</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s2">&#34;[</span><span class="si">%13.8g</span><span class="s2">, </span><span class="si">%13.8g</span><span class="s2">, </span><span class="si">%13.8g</span><span class="s2">, </span><span class="si">%13.8g</span><span class="s2">]&#34;</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">void</span> <span class="n">print2i</span><span class="p">(</span><span class="n">__m64</span> <span class="n">v</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">unsigned</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">unsigned</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">v</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s2">&#34;[</span><span class="si">%08x</span><span class="s2"> </span><span class="si">%08x</span><span class="s2">]&#34;</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#ifdef USE_SSE2</span>
</span></span><span class="line"><span class="cl"><span class="c1">#include &lt;emmintrin.h&gt;</span>
</span></span><span class="line"><span class="cl"><span class="n">void</span> <span class="n">print4i</span><span class="p">(</span><span class="n">__m128i</span> <span class="n">v</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">unsigned</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">unsigned</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">v</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s2">&#34;[</span><span class="si">%08x</span><span class="s2"> </span><span class="si">%08x</span><span class="s2"> </span><span class="si">%08x</span><span class="s2"> </span><span class="si">%08x</span><span class="s2">]&#34;</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">#endif</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#include &#34;sse_mathfun.h&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#include &lt;math.h&gt;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#include &lt;stdlib.h&gt;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#include &lt;time.h&gt;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#include &lt;assert.h&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#ifdef HAVE_SYS_TIMES</span>
</span></span><span class="line"><span class="cl"><span class="c1">#include &lt;sys/times.h&gt;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#include &lt;unistd.h&gt;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#endif</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#ifdef HAVE_VECLIB</span>
</span></span><span class="line"><span class="cl"><span class="c1"># include &lt;vecLib/vfp.h&gt;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#endif</span>
</span></span><span class="line"><span class="cl"><span class="c1">#ifdef HAVE_ACML</span>
</span></span><span class="line"><span class="cl"><span class="c1"># include &lt;acml_mv_m128.h&gt;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#endif</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">typedef</span> <span class="n">ALIGN16_BEG</span> <span class="n">union</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="ne">float</span> <span class="n">f</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="ne">int</span> <span class="n">i</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">v4sf</span>  <span class="n">v</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">ALIGN16_END</span> <span class="n">V4SF</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#define MAX(a,b) (((a)&gt;(b))?(a):(b))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">double</span> <span class="n">frand</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">rand</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">double</span><span class="p">)</span><span class="n">RAND_MAX</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#if defined(HAVE_SYS_TIMES)</span>
</span></span><span class="line"><span class="cl">  <span class="n">inline</span> <span class="n">double</span> <span class="n">uclock_sec</span><span class="p">(</span><span class="n">void</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">static</span> <span class="n">double</span> <span class="n">ttclk</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ttclk</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">)</span> <span class="n">ttclk</span> <span class="o">=</span> <span class="n">sysconf</span><span class="p">(</span><span class="n">_SC_CLK_TCK</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">struct</span> <span class="n">tms</span> <span class="n">t</span><span class="p">;</span> <span class="k">return</span> <span class="p">((</span><span class="n">double</span><span class="p">)</span><span class="n">times</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="p">))</span> <span class="o">/</span> <span class="n">ttclk</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1"># else</span>
</span></span><span class="line"><span class="cl">  <span class="n">inline</span> <span class="n">double</span> <span class="n">uclock_sec</span><span class="p">(</span><span class="n">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span> <span class="k">return</span> <span class="p">(</span><span class="n">double</span><span class="p">)</span><span class="n">clock</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">double</span><span class="p">)</span><span class="n">CLOCKS_PER_SEC</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">#endif</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#ifndef M_PI</span>
</span></span><span class="line"><span class="cl"><span class="c1">#define M_PI 3.14159265358979323846</span>
</span></span><span class="line"><span class="cl"><span class="c1">#endif</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#ifndef M_LN2</span>
</span></span><span class="line"><span class="cl"><span class="c1">#define M_LN2 0.69314718055994530942</span>
</span></span><span class="line"><span class="cl"><span class="c1">#endif</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="ne">int</span> <span class="n">bitdiff</span><span class="p">(</span><span class="ne">float</span> <span class="n">a</span><span class="p">,</span> <span class="ne">float</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="n">b</span><span class="p">)</span> <span class="k">return</span> <span class="mi">24</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="ne">int</span> <span class="n">j</span> <span class="o">=</span> <span class="o">-</span><span class="nb">log</span><span class="p">(</span><span class="n">fabs</span><span class="p">(</span><span class="n">b</span><span class="p">))</span><span class="o">/</span><span class="n">M_LN2</span><span class="p">;</span> <span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span> <span class="k">return</span> <span class="n">j</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span> <span class="k">return</span> <span class="nb">log</span><span class="p">(</span><span class="n">fabs</span><span class="p">(</span><span class="n">a</span><span class="p">))</span><span class="o">/</span><span class="n">M_LN2</span> <span class="o">-</span> <span class="nb">log</span><span class="p">(</span><span class="n">fabs</span><span class="p">(</span><span class="n">b</span><span class="o">-</span><span class="n">a</span><span class="p">))</span><span class="o">/</span><span class="n">M_LN2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">/*</span> <span class="n">they</span> <span class="n">are</span> <span class="n">defined</span> <span class="n">at</span> <span class="n">the</span> <span class="n">bottom</span> <span class="n">of</span> <span class="n">the</span> <span class="n">file</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl"><span class="ne">float</span> <span class="n">cephes_sinf</span><span class="p">(</span><span class="ne">float</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="ne">float</span> <span class="n">cephes_cosf</span><span class="p">(</span><span class="ne">float</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="ne">float</span> <span class="n">cephes_logf</span><span class="p">(</span><span class="ne">float</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="ne">float</span> <span class="n">cephes_expf</span><span class="p">(</span><span class="ne">float</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="ne">int</span> <span class="n">check_sincos_precision</span><span class="p">(</span><span class="ne">float</span> <span class="n">xmin</span><span class="p">,</span> <span class="ne">float</span> <span class="n">xmax</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">unsigned</span> <span class="n">nb_trials</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s2">&#34;checking sines on [</span><span class="si">%g</span><span class="s2">*Pi, </span><span class="si">%g</span><span class="s2">*Pi]</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="ne">float</span> <span class="n">max_err_sin_ref</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">max_err_sin_cep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">max_err_sin_x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="ne">float</span> <span class="n">max_err_cos_ref</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">max_err_cos_cep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">max_err_cos_x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="ne">float</span> <span class="n">max_err_sum_sqr_test</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="ne">float</span> <span class="n">max_err_sum_sqr_ref</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">xmin</span> <span class="o">*=</span> <span class="n">M_PI</span><span class="p">;</span> <span class="n">xmax</span> <span class="o">*=</span> <span class="n">M_PI</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">unsigned</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nb_trials</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">V4SF</span> <span class="n">vx</span><span class="p">,</span> <span class="n">sin4</span><span class="p">,</span> <span class="n">cos4</span><span class="p">,</span> <span class="n">sin4_2</span><span class="p">,</span> <span class="n">cos4_2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">vx</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="o">*</span><span class="p">(</span><span class="n">xmax</span><span class="o">-</span><span class="n">xmin</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">nb_trials</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">xmin</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">vx</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span><span class="o">+.</span><span class="mi">5</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">xmax</span><span class="o">-</span><span class="n">xmin</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">nb_trials</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">xmin</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">vx</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">frand</span><span class="p">()</span><span class="o">*</span><span class="p">(</span><span class="n">xmax</span><span class="o">-</span><span class="n">xmin</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">vx</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="mi">32</span><span class="p">)</span><span class="o">*</span><span class="n">M_PI</span><span class="o">/</span><span class="p">((</span><span class="n">i</span><span class="o">%</span><span class="mi">32</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">vx</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">xmin</span> <span class="o">||</span> <span class="n">vx</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">xmax</span><span class="p">)</span> <span class="n">vx</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">frand</span><span class="p">()</span><span class="o">*</span><span class="p">(</span><span class="n">xmax</span><span class="o">-</span><span class="n">xmin</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="o">/*</span>
</span></span><span class="line"><span class="cl">    <span class="n">vx</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">M_PI</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">vx</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">M_PI</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">vx</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">M_PI</span><span class="o">/</span><span class="mi">3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">vx</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">M_PI</span><span class="o">/</span><span class="mi">4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">*/</span>
</span></span><span class="line"><span class="cl">    <span class="n">sin4</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">sin_ps</span><span class="p">(</span><span class="n">vx</span><span class="o">.</span><span class="n">v</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">cos4</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">cos_ps</span><span class="p">(</span><span class="n">vx</span><span class="o">.</span><span class="n">v</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">sincos_ps</span><span class="p">(</span><span class="n">vx</span><span class="o">.</span><span class="n">v</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sin4_2</span><span class="o">.</span><span class="n">v</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cos4_2</span><span class="o">.</span><span class="n">v</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">unsigned</span> <span class="n">j</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="ne">float</span> <span class="n">x</span> <span class="o">=</span> <span class="n">vx</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">      <span class="ne">float</span> <span class="n">sin_test</span> <span class="o">=</span> <span class="n">sin4</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">      <span class="ne">float</span> <span class="n">cos_test</span> <span class="o">=</span> <span class="n">cos4</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">sin_test</span> <span class="o">!=</span> <span class="n">sin4_2</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s2">&#34;sin / sincos mismatch at x=</span><span class="si">%g</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">cos_test</span> <span class="o">!=</span> <span class="n">cos4_2</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s2">&#34;cos / sincos mismatch at x=</span><span class="si">%g</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="ne">float</span> <span class="n">sin_ref</span> <span class="o">=</span> <span class="n">sinf</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="ne">float</span> <span class="n">sin_cep</span> <span class="o">=</span> <span class="n">cephes_sinf</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="ne">float</span> <span class="n">err_sin_ref</span> <span class="o">=</span> <span class="n">fabs</span><span class="p">(</span><span class="n">sin_ref</span> <span class="o">-</span> <span class="n">sin_test</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="ne">float</span> <span class="n">err_sin_cep</span> <span class="o">=</span> <span class="n">fabs</span><span class="p">(</span><span class="n">sin_cep</span> <span class="o">-</span> <span class="n">sin_test</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">err_sin_ref</span> <span class="o">&gt;</span> <span class="n">max_err_sin_ref</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">max_err_sin_ref</span> <span class="o">=</span> <span class="n">err_sin_ref</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">max_err_sin_x</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="n">max_err_sin_cep</span> <span class="o">=</span> <span class="n">MAX</span><span class="p">(</span><span class="n">max_err_sin_cep</span><span class="p">,</span> <span class="n">err_sin_cep</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="ne">float</span> <span class="n">cos_ref</span> <span class="o">=</span> <span class="n">cosf</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="ne">float</span> <span class="n">cos_cep</span> <span class="o">=</span> <span class="n">cephes_cosf</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="ne">float</span> <span class="n">err_cos_ref</span> <span class="o">=</span> <span class="n">fabs</span><span class="p">(</span><span class="n">cos_ref</span> <span class="o">-</span> <span class="n">cos_test</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="ne">float</span> <span class="n">err_cos_cep</span> <span class="o">=</span> <span class="n">fabs</span><span class="p">(</span><span class="n">cos_cep</span> <span class="o">-</span> <span class="n">cos_test</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">err_cos_ref</span> <span class="o">&gt;</span> <span class="n">max_err_cos_ref</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">max_err_cos_ref</span> <span class="o">=</span> <span class="n">err_cos_ref</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">max_err_cos_x</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="n">max_err_cos_cep</span> <span class="o">=</span> <span class="n">MAX</span><span class="p">(</span><span class="n">max_err_cos_cep</span><span class="p">,</span> <span class="n">err_cos_cep</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="ne">float</span> <span class="n">err_sum_sqr_test</span> <span class="o">=</span> <span class="n">fabs</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">cos_test</span><span class="o">*</span><span class="n">cos_test</span> <span class="o">-</span> <span class="n">sin_test</span><span class="o">*</span><span class="n">sin_test</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="ne">float</span> <span class="n">err_sum_sqr_ref</span> <span class="o">=</span> <span class="n">fabs</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">cos_ref</span><span class="o">*</span><span class="n">cos_ref</span> <span class="o">-</span> <span class="n">sin_ref</span><span class="o">*</span><span class="n">sin_ref</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">max_err_sum_sqr_ref</span> <span class="o">=</span> <span class="n">MAX</span><span class="p">(</span><span class="n">max_err_sum_sqr_ref</span><span class="p">,</span> <span class="n">err_sum_sqr_ref</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">max_err_sum_sqr_test</span> <span class="o">=</span> <span class="n">MAX</span><span class="p">(</span><span class="n">max_err_sum_sqr_test</span><span class="p">,</span> <span class="n">err_sum_sqr_test</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="o">//</span><span class="n">printf</span><span class="p">(</span><span class="s2">&#34;sin(</span><span class="si">%g</span><span class="s2">) = </span><span class="si">%g</span><span class="s2"> </span><span class="si">%g</span><span class="s2"> err=</span><span class="si">%g</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">sin_ref</span><span class="p">,</span> <span class="n">sin_test</span><span class="p">,</span> <span class="n">err_sin_ref</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s2">&#34;max deviation from sinf(x): </span><span class="si">%g</span><span class="s2"> at </span><span class="si">%14.12g</span><span class="s2">*Pi, max deviation from cephes_sin(x): </span><span class="si">%g</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="n">max_err_sin_ref</span><span class="p">,</span> <span class="n">max_err_sin_x</span><span class="o">/</span><span class="n">M_PI</span><span class="p">,</span> <span class="n">max_err_sin_cep</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s2">&#34;max deviation from cosf(x): </span><span class="si">%g</span><span class="s2"> at </span><span class="si">%14.12g</span><span class="s2">*Pi, max deviation from cephes_cos(x): </span><span class="si">%g</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="n">max_err_cos_ref</span><span class="p">,</span> <span class="n">max_err_cos_x</span><span class="o">/</span><span class="n">M_PI</span><span class="p">,</span> <span class="n">max_err_cos_cep</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s2">&#34;deviation of sin(x)^2+cos(x)^2-1: </span><span class="si">%g</span><span class="s2"> (ref deviation is </span><span class="si">%g</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="n">max_err_sum_sqr_test</span><span class="p">,</span> <span class="n">max_err_sum_sqr_ref</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">max_err_sum_sqr_ref</span> <span class="o">&lt;</span> <span class="mf">2e-7</span> <span class="o">&amp;&amp;</span> <span class="n">max_err_sin_ref</span> <span class="o">&lt;</span> <span class="mf">2e-7</span> <span class="o">&amp;&amp;</span> <span class="n">max_err_cos_ref</span> <span class="o">&lt;</span> <span class="mf">2e-7</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s2">&#34;   -&gt;&gt; precision OK for the sin_ps / cos_ps / sincos_ps &lt;&lt;-</span><span class="se">\n\n</span><span class="s2">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">   WRONG PRECISION !! there is a problem</span><span class="se">\n\n</span><span class="s2">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">union</span> <span class="n">float_int_union</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="ne">int</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="ne">float</span> <span class="n">f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">QNAN</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0xFFC00000</span> <span class="p">},</span> <span class="n">QNAN2</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x7FC00000</span> <span class="p">},</span> <span class="n">PINF</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x7F800000</span> <span class="p">},</span> <span class="n">MINF</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0xFF800000</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="ne">int</span> <span class="n">check_explog_precision</span><span class="p">(</span><span class="ne">float</span> <span class="n">xmin</span><span class="p">,</span> <span class="ne">float</span> <span class="n">xmax</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">unsigned</span> <span class="n">nb_trials</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s2">&#34;checking exp/log [</span><span class="si">%g</span><span class="s2">, </span><span class="si">%g</span><span class="s2">]</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="ne">float</span> <span class="n">max_err_exp_ref</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">max_err_exp_cep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">max_err_exp_x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="ne">float</span> <span class="n">max_err_log_ref</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">max_err_log_cep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">max_err_log_x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="ne">float</span> <span class="n">max_err_logexp_test</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="ne">float</span> <span class="n">max_err_logexp_ref</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">unsigned</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nb_trials</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">V4SF</span> <span class="n">vx</span><span class="p">,</span> <span class="n">exp4</span><span class="p">,</span> <span class="n">log4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">vx</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">frand</span><span class="p">()</span><span class="o">*</span><span class="p">(</span><span class="n">xmax</span><span class="o">-</span><span class="n">xmin</span><span class="p">)</span><span class="o">+</span><span class="n">xmin</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">vx</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">frand</span><span class="p">()</span><span class="o">*</span><span class="p">(</span><span class="n">xmax</span><span class="o">-</span><span class="n">xmin</span><span class="p">)</span><span class="o">+</span><span class="n">xmin</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">vx</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">frand</span><span class="p">()</span><span class="o">*</span><span class="p">(</span><span class="n">xmax</span><span class="o">-</span><span class="n">xmin</span><span class="p">)</span><span class="o">+</span><span class="n">xmin</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">vx</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">frand</span><span class="p">()</span><span class="o">*</span><span class="p">(</span><span class="n">xmax</span><span class="o">-</span><span class="n">xmin</span><span class="p">)</span><span class="o">+</span><span class="n">xmin</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">exp4</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">exp_ps</span><span class="p">(</span><span class="n">vx</span><span class="o">.</span><span class="n">v</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">log4</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">log_ps</span><span class="p">(</span><span class="n">exp4</span><span class="o">.</span><span class="n">v</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">unsigned</span> <span class="n">j</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="ne">float</span> <span class="n">x</span> <span class="o">=</span> <span class="n">vx</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">      <span class="ne">float</span> <span class="n">exp_test</span> <span class="o">=</span> <span class="n">exp4</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">      <span class="ne">float</span> <span class="n">log_test</span> <span class="o">=</span> <span class="n">log4</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">      <span class="ne">float</span> <span class="n">exp_ref</span> <span class="o">=</span> <span class="n">expf</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="ne">float</span> <span class="n">exp_cep</span> <span class="o">=</span> <span class="n">cephes_expf</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="ne">float</span> <span class="n">err_exp_ref</span> <span class="o">=</span> <span class="n">fabs</span><span class="p">(</span><span class="n">exp_ref</span> <span class="o">-</span> <span class="n">exp_test</span><span class="p">)</span><span class="o">/</span><span class="n">exp_ref</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="ne">float</span> <span class="n">err_exp_cep</span> <span class="o">=</span> <span class="n">fabs</span><span class="p">(</span><span class="n">exp_cep</span> <span class="o">-</span> <span class="n">exp_test</span><span class="p">)</span><span class="o">/</span><span class="n">exp_ref</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">err_exp_ref</span> <span class="o">&gt;</span> <span class="n">max_err_exp_ref</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">max_err_exp_ref</span> <span class="o">=</span> <span class="n">err_exp_ref</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">max_err_exp_x</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="n">max_err_exp_cep</span> <span class="o">=</span> <span class="n">MAX</span><span class="p">(</span><span class="n">max_err_exp_cep</span><span class="p">,</span> <span class="n">err_exp_cep</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="ne">float</span> <span class="n">log_ref</span> <span class="o">=</span> <span class="n">logf</span><span class="p">(</span><span class="n">exp_test</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="ne">float</span> <span class="n">log_cep</span> <span class="o">=</span> <span class="n">cephes_logf</span><span class="p">(</span><span class="n">exp_test</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="ne">float</span> <span class="n">err_log_ref</span> <span class="o">=</span> <span class="n">fabs</span><span class="p">(</span><span class="n">log_ref</span> <span class="o">-</span> <span class="n">log_test</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="ne">float</span> <span class="n">err_log_cep</span> <span class="o">=</span> <span class="n">fabs</span><span class="p">(</span><span class="n">log_cep</span> <span class="o">-</span> <span class="n">log_test</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">err_log_ref</span> <span class="o">&gt;</span> <span class="n">max_err_log_ref</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">max_err_log_ref</span> <span class="o">=</span> <span class="n">err_log_ref</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">max_err_log_x</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="n">max_err_log_cep</span> <span class="o">=</span> <span class="n">MAX</span><span class="p">(</span><span class="n">max_err_log_cep</span><span class="p">,</span> <span class="n">err_log_cep</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="ne">float</span> <span class="n">err_logexp_test</span> <span class="o">=</span> <span class="n">fabs</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">log_test</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="ne">float</span> <span class="n">err_logexp_ref</span> <span class="o">=</span> <span class="n">fabs</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">logf</span><span class="p">(</span><span class="n">expf</span><span class="p">(</span><span class="n">x</span><span class="p">)));</span>
</span></span><span class="line"><span class="cl">      <span class="n">max_err_logexp_ref</span> <span class="o">=</span> <span class="n">MAX</span><span class="p">(</span><span class="n">max_err_logexp_ref</span><span class="p">,</span> <span class="n">err_logexp_ref</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">max_err_logexp_test</span> <span class="o">=</span> <span class="n">MAX</span><span class="p">(</span><span class="n">max_err_logexp_test</span><span class="p">,</span> <span class="n">err_logexp_test</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s2">&#34;max (relative) deviation from expf(x): </span><span class="si">%g</span><span class="s2"> at </span><span class="si">%14.12g</span><span class="s2">, max deviation from cephes_expf(x): </span><span class="si">%g</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="n">max_err_exp_ref</span><span class="p">,</span> <span class="n">max_err_exp_x</span><span class="p">,</span> <span class="n">max_err_exp_cep</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s2">&#34;max (absolute) deviation from logf(x): </span><span class="si">%g</span><span class="s2"> at </span><span class="si">%14.12g</span><span class="s2">, max deviation from cephes_logf(x): </span><span class="si">%g</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="n">max_err_log_ref</span><span class="p">,</span> <span class="n">max_err_log_x</span><span class="p">,</span> <span class="n">max_err_log_cep</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s2">&#34;deviation of x - log(exp(x)): </span><span class="si">%g</span><span class="s2"> (ref deviation is </span><span class="si">%g</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="n">max_err_logexp_test</span><span class="p">,</span> <span class="n">max_err_logexp_ref</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">max_err_logexp_test</span> <span class="o">&lt;</span> <span class="mf">2e-7</span> <span class="o">&amp;&amp;</span> <span class="n">max_err_exp_ref</span> <span class="o">&lt;</span> <span class="mf">2e-7</span> <span class="o">&amp;&amp;</span> <span class="n">max_err_log_ref</span> <span class="o">&lt;</span> <span class="mf">2e-7</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s2">&#34;   -&gt;&gt; precision OK for the exp_ps / log_ps &lt;&lt;-</span><span class="se">\n\n</span><span class="s2">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">   WRONG PRECISION !! there is a problem</span><span class="se">\n\n</span><span class="s2">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">void</span> <span class="n">dumb</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">V4SF</span> <span class="n">x</span> <span class="o">=</span> <span class="p">{{</span> <span class="mf">0.0903333798051</span><span class="p">,</span> <span class="mf">0.0903333798051</span><span class="p">,</span> <span class="mf">0.0903333798051</span><span class="p">,</span> <span class="mf">0.0903333798051</span> <span class="p">}};</span>
</span></span><span class="line"><span class="cl">  <span class="n">V4SF</span> <span class="n">w</span><span class="p">;</span> <span class="n">w</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">log_ps</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">v</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="ne">float</span> <span class="n">z</span> <span class="o">=</span> <span class="n">cephes_logf</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s2">&#34;log_ps returned &#34;</span><span class="p">);</span> <span class="n">print4</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">v</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">cephes returned: </span><span class="si">%14.12g</span><span class="s2"> and logf(</span><span class="si">%g</span><span class="s2">)=</span><span class="si">%14.12g</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">logf</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">print4</span><span class="p">(</span><span class="n">_mm_cmpeq_ps</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">v</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">v</span><span class="p">));</span> <span class="n">printf</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">void</span> <span class="n">check_special_values</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">V4SF</span> <span class="n">vx</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">  <span class="n">vx</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">vx</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">100</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">vx</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">vx</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s2">&#34;exp(&#34;</span><span class="p">);</span> <span class="n">print4</span><span class="p">(</span><span class="n">vx</span><span class="o">.</span><span class="n">v</span><span class="p">);</span> <span class="n">printf</span><span class="p">(</span><span class="s2">&#34;) = &#34;</span><span class="p">);</span> <span class="n">print4</span><span class="p">(</span><span class="n">exp_ps</span><span class="p">(</span><span class="n">vx</span><span class="o">.</span><span class="n">v</span><span class="p">));</span> <span class="n">printf</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">vx</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">QNAN</span><span class="o">.</span><span class="n">f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">vx</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">PINF</span><span class="o">.</span><span class="n">f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">vx</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">MINF</span><span class="o">.</span><span class="n">f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">vx</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">QNAN2</span><span class="o">.</span><span class="n">f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s2">&#34;exp(&#34;</span><span class="p">);</span> <span class="n">print4</span><span class="p">(</span><span class="n">vx</span><span class="o">.</span><span class="n">v</span><span class="p">);</span> <span class="n">printf</span><span class="p">(</span><span class="s2">&#34;) = &#34;</span><span class="p">);</span> <span class="n">print4</span><span class="p">(</span><span class="n">exp_ps</span><span class="p">(</span><span class="n">vx</span><span class="o">.</span><span class="n">v</span><span class="p">));</span> <span class="n">printf</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">vx</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">vx</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">vx</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e30</span><span class="n">f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">vx</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-42</span><span class="n">f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s2">&#34;log(&#34;</span><span class="p">);</span> <span class="n">print4</span><span class="p">(</span><span class="n">vx</span><span class="o">.</span><span class="n">v</span><span class="p">);</span> <span class="n">printf</span><span class="p">(</span><span class="s2">&#34;) = &#34;</span><span class="p">);</span> <span class="n">print4</span><span class="p">(</span><span class="n">log_ps</span><span class="p">(</span><span class="n">vx</span><span class="o">.</span><span class="n">v</span><span class="p">));</span> <span class="n">printf</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">vx</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">QNAN</span><span class="o">.</span><span class="n">f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">vx</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">PINF</span><span class="o">.</span><span class="n">f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">vx</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">MINF</span><span class="o">.</span><span class="n">f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">vx</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">QNAN2</span><span class="o">.</span><span class="n">f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s2">&#34;log(&#34;</span><span class="p">);</span> <span class="n">print4</span><span class="p">(</span><span class="n">vx</span><span class="o">.</span><span class="n">v</span><span class="p">);</span> <span class="n">printf</span><span class="p">(</span><span class="s2">&#34;) = &#34;</span><span class="p">);</span> <span class="n">print4</span><span class="p">(</span><span class="n">log_ps</span><span class="p">(</span><span class="n">vx</span><span class="o">.</span><span class="n">v</span><span class="p">));</span> <span class="n">printf</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s2">&#34;sin(&#34;</span><span class="p">);</span> <span class="n">print4</span><span class="p">(</span><span class="n">vx</span><span class="o">.</span><span class="n">v</span><span class="p">);</span> <span class="n">printf</span><span class="p">(</span><span class="s2">&#34;) = &#34;</span><span class="p">);</span> <span class="n">print4</span><span class="p">(</span><span class="n">sin_ps</span><span class="p">(</span><span class="n">vx</span><span class="o">.</span><span class="n">v</span><span class="p">));</span> <span class="n">printf</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s2">&#34;cos(&#34;</span><span class="p">);</span> <span class="n">print4</span><span class="p">(</span><span class="n">vx</span><span class="o">.</span><span class="n">v</span><span class="p">);</span> <span class="n">printf</span><span class="p">(</span><span class="s2">&#34;) = &#34;</span><span class="p">);</span> <span class="n">print4</span><span class="p">(</span><span class="n">cos_ps</span><span class="p">(</span><span class="n">vx</span><span class="o">.</span><span class="n">v</span><span class="p">));</span> <span class="n">printf</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">vx</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1e30</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">vx</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">100000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">vx</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e30</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">vx</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s2">&#34;sin(&#34;</span><span class="p">);</span> <span class="n">print4</span><span class="p">(</span><span class="n">vx</span><span class="o">.</span><span class="n">v</span><span class="p">);</span> <span class="n">printf</span><span class="p">(</span><span class="s2">&#34;) = &#34;</span><span class="p">);</span> <span class="n">print4</span><span class="p">(</span><span class="n">sin_ps</span><span class="p">(</span><span class="n">vx</span><span class="o">.</span><span class="n">v</span><span class="p">));</span> <span class="n">printf</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s2">&#34;cos(&#34;</span><span class="p">);</span> <span class="n">print4</span><span class="p">(</span><span class="n">vx</span><span class="o">.</span><span class="n">v</span><span class="p">);</span> <span class="n">printf</span><span class="p">(</span><span class="s2">&#34;) = &#34;</span><span class="p">);</span> <span class="n">print4</span><span class="p">(</span><span class="n">cos_ps</span><span class="p">(</span><span class="n">vx</span><span class="o">.</span><span class="n">v</span><span class="p">));</span> <span class="n">printf</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#define DECL_SCALAR_FN_BENCH(fn)                     \</span>
</span></span><span class="line"><span class="cl">  <span class="ne">int</span> <span class="n">bench_</span><span class="c1">##fn() {                                 \</span>
</span></span><span class="line"><span class="cl">    <span class="ne">int</span> <span class="n">niter</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">;</span>                           \
</span></span><span class="line"><span class="cl">    <span class="ne">float</span> <span class="n">x</span> <span class="o">=</span> <span class="mf">0.5</span><span class="n">f</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>                             \
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">niter</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>                      \
</span></span><span class="line"><span class="cl">      <span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>                        \
</span></span><span class="line"><span class="cl">        <span class="n">x</span> <span class="o">+=</span> <span class="mf">1e-6</span><span class="n">f</span><span class="p">;</span>                                  \
</span></span><span class="line"><span class="cl">        <span class="n">y</span> <span class="o">+=</span> <span class="n">fn</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="mi">5</span><span class="o">*</span><span class="p">(</span><span class="n">j</span><span class="o">&amp;</span><span class="mi">1</span><span class="p">));</span>                                  \
</span></span><span class="line"><span class="cl">      <span class="p">}</span>                                              \
</span></span><span class="line"><span class="cl">    <span class="p">}</span>                                                \
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">y</span> <span class="o">==</span> <span class="mf">2.32132323232</span><span class="n">f</span><span class="p">)</span> <span class="n">niter</span><span class="o">--</span><span class="p">;</span>                \
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">niter</span><span class="p">;</span>                                    \
</span></span><span class="line"><span class="cl">  <span class="p">}</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#define DECL_VECTOR_FN_BENCH(fn)                                        \</span>
</span></span><span class="line"><span class="cl">  <span class="ne">int</span> <span class="n">bench_</span><span class="c1">##fn() {                                                    \</span>
</span></span><span class="line"><span class="cl">    <span class="ne">int</span> <span class="n">niter</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span><span class="n">i</span><span class="p">;</span>                                                \
</span></span><span class="line"><span class="cl">    <span class="n">v4sf</span> <span class="n">bmin</span> <span class="o">=</span> <span class="n">_mm_set_ps1</span><span class="p">(</span><span class="mf">0.5</span><span class="p">),</span> <span class="n">bmax</span> <span class="o">=</span> <span class="n">_mm_set_ps1</span><span class="p">(</span><span class="mf">1.0</span><span class="p">);</span>              \
</span></span><span class="line"><span class="cl">    <span class="n">v4sf</span> <span class="n">x</span> <span class="o">=</span> <span class="n">_mm_set_ps1</span><span class="p">(</span><span class="mf">0.75</span><span class="p">);</span>                                         \
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">niter</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>                                         \
</span></span><span class="line"><span class="cl">      <span class="n">x</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="n">x</span><span class="p">);</span> <span class="n">x</span> <span class="o">=</span> <span class="n">_mm_min_ps</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">bmax</span><span class="p">);</span> <span class="n">x</span> <span class="o">=</span> <span class="n">_mm_max_ps</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">bmin</span><span class="p">);</span>      \
</span></span><span class="line"><span class="cl">    <span class="p">}</span>                                                                   \
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(((</span><span class="ne">float</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">x</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mf">2.32132323232</span><span class="n">f</span><span class="p">)</span> <span class="n">niter</span><span class="o">--</span><span class="p">;</span>                     \
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">niter</span><span class="p">;</span>                                                       \
</span></span><span class="line"><span class="cl">  <span class="p">}</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#ifdef __GNUC__</span>
</span></span><span class="line"><span class="cl"><span class="c1">#define HAVE_SINCOS_X86_FPU</span>
</span></span><span class="line"><span class="cl"><span class="n">void</span> <span class="n">sincos_x86_fpu</span><span class="p">(</span><span class="n">double</span> <span class="n">t</span><span class="p">,</span> <span class="n">double</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="n">double</span> <span class="o">*</span><span class="n">ct</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">asm</span> <span class="p">(</span><span class="s2">&#34;fsincos;&#34;</span> <span class="p">:</span> <span class="s2">&#34;=t&#34;</span> <span class="p">(</span><span class="o">*</span><span class="n">ct</span><span class="p">),</span> <span class="s2">&#34;=u&#34;</span> <span class="p">(</span><span class="o">*</span><span class="n">st</span><span class="p">)</span> <span class="p">:</span> <span class="s2">&#34;0&#34;</span> <span class="p">(</span><span class="n">t</span><span class="p">));</span> 
</span></span><span class="line"><span class="cl">  <span class="o">//*</span><span class="n">st</span> <span class="o">=</span> <span class="nb">sin</span><span class="p">(</span><span class="n">t</span><span class="p">);</span> <span class="o">*</span><span class="n">ct</span> <span class="o">=</span> <span class="nb">cos</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">#elif defined(_MSC_VER) &amp;&amp; !defined(_WIN64)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#define HAVE_SINCOS_X86_FPU</span>
</span></span><span class="line"><span class="cl"><span class="n">void</span> <span class="n">sincos_x86_fpu</span><span class="p">(</span><span class="n">double</span> <span class="n">t</span><span class="p">,</span> <span class="n">double</span> <span class="o">*</span><span class="n">st_</span><span class="p">,</span> <span class="n">double</span> <span class="o">*</span><span class="n">ct_</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">_asm</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">fld</span> <span class="n">QWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">t</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">fsincos</span>
</span></span><span class="line"><span class="cl">    <span class="n">mov</span> <span class="n">ebx</span><span class="p">,[</span><span class="n">ct_</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">fstp</span> <span class="n">QWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">ebx</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">mov</span> <span class="n">ebx</span><span class="p">,[</span><span class="n">st_</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">fstp</span> <span class="n">QWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">ebx</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">#endif</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#ifdef HAVE_SINCOS_X86_FPU</span>
</span></span><span class="line"><span class="cl"><span class="ne">float</span> <span class="n">stupid_sincos_x86_fpu</span><span class="p">(</span><span class="ne">float</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">double</span> <span class="n">s</span><span class="p">,</span> <span class="n">c</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">sincos_x86_fpu</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">s</span><span class="o">+</span><span class="n">c</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">#endif</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">v4sf</span> <span class="n">stupid_sincos_ps</span><span class="p">(</span><span class="n">v4sf</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">v4sf</span> <span class="n">s</span><span class="p">,</span> <span class="n">c</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">sincos_ps</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">s</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">DECL_SCALAR_FN_BENCH</span><span class="p">(</span><span class="n">sinf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">DECL_SCALAR_FN_BENCH</span><span class="p">(</span><span class="n">cosf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">#ifdef HAVE_SINCOS_X86_FPU</span>
</span></span><span class="line"><span class="cl"><span class="n">DECL_SCALAR_FN_BENCH</span><span class="p">(</span><span class="n">stupid_sincos_x86_fpu</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">#endif</span>
</span></span><span class="line"><span class="cl"><span class="n">DECL_SCALAR_FN_BENCH</span><span class="p">(</span><span class="n">logf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">DECL_SCALAR_FN_BENCH</span><span class="p">(</span><span class="n">expf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">DECL_SCALAR_FN_BENCH</span><span class="p">(</span><span class="n">cephes_sinf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">DECL_SCALAR_FN_BENCH</span><span class="p">(</span><span class="n">cephes_cosf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">DECL_SCALAR_FN_BENCH</span><span class="p">(</span><span class="n">cephes_expf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">DECL_SCALAR_FN_BENCH</span><span class="p">(</span><span class="n">cephes_logf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">DECL_VECTOR_FN_BENCH</span><span class="p">(</span><span class="n">sin_ps</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">DECL_VECTOR_FN_BENCH</span><span class="p">(</span><span class="n">cos_ps</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">DECL_VECTOR_FN_BENCH</span><span class="p">(</span><span class="n">stupid_sincos_ps</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">DECL_VECTOR_FN_BENCH</span><span class="p">(</span><span class="n">exp_ps</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">DECL_VECTOR_FN_BENCH</span><span class="p">(</span><span class="n">log_ps</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">#ifdef HAVE_VECLIB</span>
</span></span><span class="line"><span class="cl"><span class="n">DECL_VECTOR_FN_BENCH</span><span class="p">(</span><span class="n">vsinf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">DECL_VECTOR_FN_BENCH</span><span class="p">(</span><span class="n">vcosf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">DECL_VECTOR_FN_BENCH</span><span class="p">(</span><span class="n">vlogf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">DECL_VECTOR_FN_BENCH</span><span class="p">(</span><span class="n">vexpf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">#endif</span>
</span></span><span class="line"><span class="cl"><span class="c1">#ifdef HAVE_ACML</span>
</span></span><span class="line"><span class="cl"><span class="n">DECL_VECTOR_FN_BENCH</span><span class="p">(</span><span class="n">__vrs4_sinf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">DECL_VECTOR_FN_BENCH</span><span class="p">(</span><span class="n">__vrs4_cosf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">DECL_VECTOR_FN_BENCH</span><span class="p">(</span><span class="n">__vrs4_expf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">DECL_VECTOR_FN_BENCH</span><span class="p">(</span><span class="n">__vrs4_logf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">#endif</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">void</span> <span class="n">run_bench</span><span class="p">(</span><span class="k">const</span> <span class="n">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="ne">int</span> <span class="p">(</span><span class="o">*</span><span class="n">fn</span><span class="p">)())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s2">&#34;benching </span><span class="si">%20s</span><span class="s2"> ..&#34;</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span> <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">double</span> <span class="n">t0</span> <span class="o">=</span> <span class="n">uclock_sec</span><span class="p">(),</span> <span class="n">t1</span><span class="p">,</span> <span class="n">tmax</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">double</span> <span class="n">niter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">do</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">niter</span> <span class="o">+=</span> <span class="n">fn</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">t1</span> <span class="o">=</span> <span class="n">uclock_sec</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">t1</span> <span class="o">-</span> <span class="n">t0</span> <span class="o">&lt;</span> <span class="n">tmax</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">#define REF_FREQ_MHZ 2600.0</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s2">&#34; -&gt; </span><span class="si">%6.1f</span><span class="s2"> millions of vector evaluations/second -&gt; </span><span class="si">%3.0f</span><span class="s2"> cycles/value on a </span><span class="si">%g</span><span class="s2">MHz computer</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="nb">floor</span><span class="p">(</span><span class="n">niter</span><span class="o">/</span><span class="p">(</span><span class="n">t1</span><span class="o">-</span><span class="n">t0</span><span class="p">)</span><span class="o">/</span><span class="mf">1e5</span><span class="p">)</span><span class="o">/</span><span class="mi">10</span><span class="p">,</span> <span class="p">(</span><span class="n">t1</span><span class="o">-</span><span class="n">t0</span><span class="p">)</span><span class="o">*</span><span class="n">REF_FREQ_MHZ</span><span class="o">*</span><span class="mf">1e6</span><span class="o">/</span><span class="n">niter</span><span class="o">/</span><span class="mi">4</span><span class="p">,</span> <span class="n">REF_FREQ_MHZ</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">void</span> <span class="n">sanity_check</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s2">&#34;doing some sanity checks...</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">#ifndef USE_SSE2</span>
</span></span><span class="line"><span class="cl">  <span class="n">V4SF</span> <span class="n">v</span> <span class="o">=</span> <span class="p">{{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">}},</span> <span class="n">z</span> <span class="o">=</span> <span class="p">{{</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">}};</span>
</span></span><span class="line"><span class="cl">  <span class="n">v2si</span> <span class="n">mm0</span><span class="p">,</span> <span class="n">mm1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">COPY_XMM_TO_MM</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">v</span><span class="p">,</span> <span class="n">mm0</span><span class="p">,</span> <span class="n">mm1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">COPY_MM_TO_XMM</span><span class="p">(</span><span class="n">mm0</span><span class="p">,</span> <span class="n">mm1</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">v</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s2">&#34;truncation to int: &#34;</span><span class="p">);</span> <span class="n">print2i</span><span class="p">(</span><span class="n">mm0</span><span class="p">);</span> <span class="n">print2i</span><span class="p">(</span><span class="n">mm1</span><span class="p">);</span> <span class="n">printf</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">_mm_empty</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s2">&#34;float vector: &#34;</span><span class="p">);</span> <span class="n">print4</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">v</span><span class="p">);</span> <span class="n">printf</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">);</span> <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nb">assert</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nb">assert</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nb">assert</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nb">assert</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="n">V4SF</span> <span class="n">w</span><span class="p">;</span> <span class="n">w</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">v</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">//</span><span class="n">printf</span><span class="p">(</span><span class="s2">&#34;float vector: &#34;</span><span class="p">);</span> <span class="n">print4</span><span class="p">(</span><span class="n">w</span><span class="p">);</span> <span class="n">printf</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">mm0</span> <span class="o">=</span> <span class="n">_mm_cvttps_pi32</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">v</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">w</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">_mm_movehl_ps</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">v</span><span class="p">,</span><span class="n">w</span><span class="o">.</span><span class="n">v</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">mm1</span> <span class="o">=</span> <span class="n">_mm_cvttps_pi32</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">v</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">/*</span><span class="n">_mm_empty</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s2">&#34;truncation to int: &#34;</span><span class="p">);</span> <span class="n">print2i</span><span class="p">(</span><span class="n">mm0</span><span class="p">);</span> <span class="n">print2i</span><span class="p">(</span><span class="n">mm1</span><span class="p">);</span> <span class="n">printf</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*/</span>
</span></span><span class="line"><span class="cl">  <span class="n">w</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">_mm_cvtpi32x2_ps</span><span class="p">(</span><span class="n">mm0</span><span class="p">,</span> <span class="n">mm1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">print2i</span><span class="p">(((</span><span class="n">v2si</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">w</span><span class="o">.</span><span class="n">v</span><span class="p">)[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">  <span class="n">print2i</span><span class="p">(((</span><span class="n">v2si</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">w</span><span class="o">.</span><span class="n">v</span><span class="p">)[</span><span class="mi">1</span><span class="p">]);</span> <span class="n">_mm_empty</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">v</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">v</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nb">assert</span><span class="p">((((</span><span class="n">long</span> <span class="n">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">v</span><span class="o">.</span><span class="n">v</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0xf</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s2">&#34;converted back to float: &#34;</span><span class="p">);</span> <span class="n">print4</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">v</span><span class="p">);</span> <span class="n">printf</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">);</span> <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nb">assert</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nb">assert</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nb">assert</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nb">assert</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">w</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">_mm_movehl_ps</span><span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">v</span><span class="p">,</span> <span class="n">w</span><span class="o">.</span><span class="n">v</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s2">&#34;test for _mm_movehl_ps bug..</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">);</span> <span class="n">print4</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">v</span><span class="p">);</span> <span class="n">printf</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">);</span> <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">3</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">      <span class="n">w</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">4</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">      <span class="n">w</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">7</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">      <span class="n">w</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s2">&#34;your compiler has the nasty bug on _mm_movehl_ps: IT IS BROKEN</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s2">&#34;test for _mm_cmpxx_ps bug..</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">  <span class="n">V4SF</span> <span class="n">r</span><span class="p">;</span> <span class="n">r</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">_mm_cmplt_ps</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">v</span><span class="p">,</span> <span class="n">w</span><span class="o">.</span><span class="n">v</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">r</span><span class="o">.</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">r</span><span class="o">.</span><span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">r</span><span class="o">.</span><span class="n">i</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s2">&#34;your compiler has the nasty bug on all _mm_cmp*_ps functions: IT IS BROKEN</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">r</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">_mm_cmpeq_ps</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">v</span><span class="p">,</span> <span class="n">w</span><span class="o">.</span><span class="n">v</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="n">r</span><span class="o">.</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="n">r</span><span class="o">.</span><span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="n">r</span><span class="o">.</span><span class="n">i</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s2">&#34;your compiler has the nasty bug on all _mm_cmp*_ps functions: IT IS BROKEN</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">#endif // USE_SSE2</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="ne">int</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="o">//</span><span class="n">dumb</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="o">//</span><span class="n">sanity_check</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="ne">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">err</span> <span class="o">+=</span> <span class="n">check_sincos_precision</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">err</span> <span class="o">+=</span> <span class="n">check_sincos_precision</span><span class="p">(</span><span class="o">-</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">err</span> <span class="o">+=</span> <span class="n">check_explog_precision</span><span class="p">(</span><span class="o">-</span><span class="mi">60</span><span class="p">,</span> <span class="mi">60</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s2">&#34;some precision tests have failed</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">check_special_values</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">run_bench</span><span class="p">(</span><span class="s2">&#34;sinf&#34;</span><span class="p">,</span> <span class="n">bench_sinf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">run_bench</span><span class="p">(</span><span class="s2">&#34;cosf&#34;</span><span class="p">,</span> <span class="n">bench_cosf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">#ifdef HAVE_SINCOS_X86_FPU</span>
</span></span><span class="line"><span class="cl">  <span class="n">run_bench</span><span class="p">(</span><span class="s2">&#34;sincos (x87)&#34;</span><span class="p">,</span> <span class="n">bench_stupid_sincos_x86_fpu</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">#endif</span>
</span></span><span class="line"><span class="cl">  <span class="n">run_bench</span><span class="p">(</span><span class="s2">&#34;expf&#34;</span><span class="p">,</span> <span class="n">bench_expf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">run_bench</span><span class="p">(</span><span class="s2">&#34;logf&#34;</span><span class="p">,</span> <span class="n">bench_logf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">run_bench</span><span class="p">(</span><span class="s2">&#34;cephes_sinf&#34;</span><span class="p">,</span> <span class="n">bench_cephes_sinf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">run_bench</span><span class="p">(</span><span class="s2">&#34;cephes_cosf&#34;</span><span class="p">,</span> <span class="n">bench_cephes_cosf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">run_bench</span><span class="p">(</span><span class="s2">&#34;cephes_expf&#34;</span><span class="p">,</span> <span class="n">bench_cephes_expf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">run_bench</span><span class="p">(</span><span class="s2">&#34;cephes_logf&#34;</span><span class="p">,</span> <span class="n">bench_cephes_logf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">run_bench</span><span class="p">(</span><span class="s2">&#34;sin_ps&#34;</span><span class="p">,</span> <span class="n">bench_sin_ps</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">run_bench</span><span class="p">(</span><span class="s2">&#34;cos_ps&#34;</span><span class="p">,</span> <span class="n">bench_cos_ps</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">run_bench</span><span class="p">(</span><span class="s2">&#34;sincos_ps&#34;</span><span class="p">,</span> <span class="n">bench_stupid_sincos_ps</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">run_bench</span><span class="p">(</span><span class="s2">&#34;exp_ps&#34;</span><span class="p">,</span> <span class="n">bench_exp_ps</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">run_bench</span><span class="p">(</span><span class="s2">&#34;log_ps&#34;</span><span class="p">,</span> <span class="n">bench_log_ps</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#ifdef HAVE_VECLIB</span>
</span></span><span class="line"><span class="cl">  <span class="n">run_bench</span><span class="p">(</span><span class="s2">&#34;vsinf&#34;</span><span class="p">,</span> <span class="n">bench_vsinf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">run_bench</span><span class="p">(</span><span class="s2">&#34;vcosf&#34;</span><span class="p">,</span> <span class="n">bench_vcosf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">run_bench</span><span class="p">(</span><span class="s2">&#34;vexpf&#34;</span><span class="p">,</span> <span class="n">bench_vexpf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">run_bench</span><span class="p">(</span><span class="s2">&#34;vlogf&#34;</span><span class="p">,</span> <span class="n">bench_vlogf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">#endif</span>
</span></span><span class="line"><span class="cl"><span class="c1">#ifdef HAVE_ACML</span>
</span></span><span class="line"><span class="cl">  <span class="n">run_bench</span><span class="p">(</span><span class="s2">&#34;acml vrs4_sinf&#34;</span><span class="p">,</span> <span class="n">bench___vrs4_sinf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">run_bench</span><span class="p">(</span><span class="s2">&#34;acml vrs4_cosf&#34;</span><span class="p">,</span> <span class="n">bench___vrs4_cosf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">run_bench</span><span class="p">(</span><span class="s2">&#34;acml vrs4_expf&#34;</span><span class="p">,</span> <span class="n">bench___vrs4_expf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">run_bench</span><span class="p">(</span><span class="s2">&#34;acml vrs4_logf&#34;</span><span class="p">,</span> <span class="n">bench___vrs4_logf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">#endif</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">/*</span> <span class="n">cephes</span> <span class="n">functions</span><span class="p">,</span> <span class="n">copied</span> <span class="n">here</span> <span class="n">to</span> <span class="n">serve</span> <span class="n">as</span> <span class="n">a</span> <span class="n">reference</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">/*</span>							<span class="n">sinf</span><span class="o">.</span><span class="n">c</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>	<span class="n">Circular</span> <span class="n">sine</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">SYNOPSIS</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="ne">float</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sinf</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">y</span> <span class="o">=</span> <span class="n">sinf</span><span class="p">(</span> <span class="n">x</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">DESCRIPTION</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="ne">Range</span> <span class="n">reduction</span> <span class="n">is</span> <span class="n">into</span> <span class="n">intervals</span> <span class="n">of</span> <span class="n">pi</span><span class="o">/</span><span class="mf">4.</span>  <span class="n">The</span> <span class="n">reduction</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">error</span> <span class="n">is</span> <span class="n">nearly</span> <span class="n">eliminated</span> <span class="n">by</span> <span class="n">contriving</span> <span class="n">an</span> <span class="n">extended</span> <span class="n">precision</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">modular</span> <span class="n">arithmetic</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">Two</span> <span class="n">polynomial</span> <span class="n">approximating</span> <span class="n">functions</span> <span class="n">are</span> <span class="n">employed</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">Between</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">pi</span><span class="o">/</span><span class="mi">4</span> <span class="n">the</span> <span class="n">sine</span> <span class="n">is</span> <span class="n">approximated</span> <span class="n">by</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>      <span class="n">x</span>  <span class="o">+</span>  <span class="n">x</span><span class="o">**</span><span class="mi">3</span> <span class="n">P</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">Between</span> <span class="n">pi</span><span class="o">/</span><span class="mi">4</span> <span class="ow">and</span> <span class="n">pi</span><span class="o">/</span><span class="mi">2</span> <span class="n">the</span> <span class="n">cosine</span> <span class="n">is</span> <span class="n">represented</span> <span class="n">as</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>      <span class="mi">1</span>  <span class="o">-</span>  <span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="n">Q</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">ACCURACY</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>                      <span class="n">Relative</span> <span class="n">error</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">arithmetic</span>   <span class="n">domain</span>      <span class="c1"># trials      peak       rms</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>    <span class="n">IEEE</span>    <span class="o">-</span><span class="mi">4096</span><span class="p">,</span><span class="o">+</span><span class="mi">4096</span>   <span class="mi">100</span><span class="p">,</span><span class="mi">000</span>      <span class="mf">1.2e-7</span>     <span class="mf">3.0e-8</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>    <span class="n">IEEE</span>    <span class="o">-</span><span class="mi">8192</span><span class="p">,</span><span class="o">+</span><span class="mi">8192</span>   <span class="mi">100</span><span class="p">,</span><span class="mi">000</span>      <span class="mf">3.0e-7</span>     <span class="mf">3.0e-8</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> 
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">ERROR</span> <span class="n">MESSAGES</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>   <span class="n">message</span>           <span class="n">condition</span>        <span class="n">value</span> <span class="n">returned</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="nb">sin</span> <span class="n">total</span> <span class="n">loss</span>      <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="o">^</span><span class="mi">24</span>              <span class="mf">0.0</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">Partial</span> <span class="n">loss</span> <span class="n">of</span> <span class="n">accuracy</span> <span class="n">begins</span> <span class="n">to</span> <span class="n">occur</span> <span class="n">at</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">2</span><span class="o">^</span><span class="mi">13</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="o">=</span> <span class="mf">8192.</span> <span class="n">Results</span> <span class="n">may</span> <span class="n">be</span> <span class="n">meaningless</span> <span class="k">for</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="o">^</span><span class="mi">24</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">The</span> <span class="n">routine</span> <span class="n">as</span> <span class="n">implemented</span> <span class="n">flags</span> <span class="n">a</span> <span class="n">TLOSS</span> <span class="n">error</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="k">for</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="o">^</span><span class="mi">24</span> <span class="ow">and</span> <span class="n">returns</span> <span class="mf">0.0</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">/*</span>							<span class="n">cosf</span><span class="o">.</span><span class="n">c</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>	<span class="n">Circular</span> <span class="n">cosine</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">SYNOPSIS</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="ne">float</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">cosf</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">y</span> <span class="o">=</span> <span class="n">cosf</span><span class="p">(</span> <span class="n">x</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">DESCRIPTION</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="ne">Range</span> <span class="n">reduction</span> <span class="n">is</span> <span class="n">into</span> <span class="n">intervals</span> <span class="n">of</span> <span class="n">pi</span><span class="o">/</span><span class="mf">4.</span>  <span class="n">The</span> <span class="n">reduction</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">error</span> <span class="n">is</span> <span class="n">nearly</span> <span class="n">eliminated</span> <span class="n">by</span> <span class="n">contriving</span> <span class="n">an</span> <span class="n">extended</span> <span class="n">precision</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">modular</span> <span class="n">arithmetic</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">Two</span> <span class="n">polynomial</span> <span class="n">approximating</span> <span class="n">functions</span> <span class="n">are</span> <span class="n">employed</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">Between</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">pi</span><span class="o">/</span><span class="mi">4</span> <span class="n">the</span> <span class="n">cosine</span> <span class="n">is</span> <span class="n">approximated</span> <span class="n">by</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>      <span class="mi">1</span>  <span class="o">-</span>  <span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="n">Q</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">Between</span> <span class="n">pi</span><span class="o">/</span><span class="mi">4</span> <span class="ow">and</span> <span class="n">pi</span><span class="o">/</span><span class="mi">2</span> <span class="n">the</span> <span class="n">sine</span> <span class="n">is</span> <span class="n">represented</span> <span class="n">as</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>      <span class="n">x</span>  <span class="o">+</span>  <span class="n">x</span><span class="o">**</span><span class="mi">3</span> <span class="n">P</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">ACCURACY</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>                      <span class="n">Relative</span> <span class="n">error</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">arithmetic</span>   <span class="n">domain</span>      <span class="c1"># trials      peak         rms</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>    <span class="n">IEEE</span>    <span class="o">-</span><span class="mi">8192</span><span class="p">,</span><span class="o">+</span><span class="mi">8192</span>   <span class="mi">100</span><span class="p">,</span><span class="mi">000</span>      <span class="mf">3.0e-7</span>     <span class="mf">3.0e-8</span>
</span></span><span class="line"><span class="cl"> <span class="o">*/</span>
</span></span><span class="line"><span class="cl"><span class="o">/*</span>
</span></span><span class="line"><span class="cl"><span class="n">Cephes</span> <span class="n">Math</span> <span class="n">Library</span> <span class="n">Release</span> <span class="mf">2.2</span><span class="p">:</span>  <span class="n">June</span><span class="p">,</span> <span class="mi">1992</span>
</span></span><span class="line"><span class="cl"><span class="n">Copyright</span> <span class="mi">1985</span><span class="p">,</span> <span class="mi">1987</span><span class="p">,</span> <span class="mi">1988</span><span class="p">,</span> <span class="mi">1992</span> <span class="n">by</span> <span class="n">Stephen</span> <span class="n">L</span><span class="o">.</span> <span class="n">Moshier</span>
</span></span><span class="line"><span class="cl"><span class="n">Direct</span> <span class="n">inquiries</span> <span class="n">to</span> <span class="mi">30</span> <span class="n">Frost</span> <span class="n">Street</span><span class="p">,</span> <span class="n">Cambridge</span><span class="p">,</span> <span class="n">MA</span> <span class="mi">02140</span>
</span></span><span class="line"><span class="cl"><span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">/*</span> <span class="n">Single</span> <span class="n">precision</span> <span class="n">circular</span> <span class="n">sine</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">test</span> <span class="n">interval</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="n">pi</span><span class="o">/</span><span class="mi">4</span><span class="p">,</span> <span class="o">+</span><span class="n">pi</span><span class="o">/</span><span class="mi">4</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">trials</span><span class="p">:</span> <span class="mi">10000</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">peak</span> <span class="n">relative</span> <span class="n">error</span><span class="p">:</span> <span class="mf">6.8e-8</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">rms</span> <span class="n">relative</span> <span class="n">error</span><span class="p">:</span> <span class="mf">2.6e-8</span>
</span></span><span class="line"><span class="cl"> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="ne">float</span> <span class="n">FOPI</span> <span class="o">=</span> <span class="mf">1.27323954473516</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="ne">float</span> <span class="n">PIO4F</span> <span class="o">=</span> <span class="mf">0.7853981633974483096</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">/*</span> <span class="n">Note</span><span class="p">,</span> <span class="n">these</span> <span class="n">constants</span> <span class="n">are</span> <span class="k">for</span> <span class="n">a</span> <span class="mi">32</span><span class="o">-</span><span class="n">bit</span> <span class="n">significand</span><span class="p">:</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl"><span class="o">/*</span>
</span></span><span class="line"><span class="cl">  <span class="k">static</span> <span class="ne">float</span> <span class="n">DP1</span> <span class="o">=</span>  <span class="mf">0.7853851318359375</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">static</span> <span class="ne">float</span> <span class="n">DP2</span> <span class="o">=</span>  <span class="mf">1.30315311253070831298828125e-5</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">static</span> <span class="ne">float</span> <span class="n">DP3</span> <span class="o">=</span>  <span class="mf">3.03855025325309630e-11</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">static</span> <span class="ne">float</span> <span class="n">lossth</span> <span class="o">=</span> <span class="mf">65536.</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">/*</span> <span class="n">These</span> <span class="n">are</span> <span class="k">for</span> <span class="n">a</span> <span class="mi">24</span><span class="o">-</span><span class="n">bit</span> <span class="n">significand</span><span class="p">:</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="ne">float</span> <span class="n">DP1</span> <span class="o">=</span> <span class="mf">0.78515625</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="ne">float</span> <span class="n">DP2</span> <span class="o">=</span> <span class="mf">2.4187564849853515625e-4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="ne">float</span> <span class="n">DP3</span> <span class="o">=</span> <span class="mf">3.77489497744594108e-8</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="ne">float</span> <span class="n">lossth</span> <span class="o">=</span> <span class="mf">8192.</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="ne">float</span> <span class="n">T24M1</span> <span class="o">=</span> <span class="mf">16777215.</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="ne">float</span> <span class="n">sincof</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="o">-</span><span class="mf">1.9515295891E-4</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="mf">8.3321608736E-3</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="o">-</span><span class="mf">1.6666654611E-1</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="ne">float</span> <span class="n">coscof</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="mf">2.443315711809948E-005</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="o">-</span><span class="mf">1.388731625493765E-003</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="mf">4.166664568298827E-002</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="ne">float</span> <span class="n">cephes_sinf</span><span class="p">(</span> <span class="ne">float</span> <span class="n">xx</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="ne">float</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="ne">float</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">register</span> <span class="n">unsigned</span> <span class="n">long</span> <span class="n">j</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">register</span> <span class="ne">int</span> <span class="nb">sign</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nb">sign</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">x</span> <span class="o">=</span> <span class="n">xx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">xx</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nb">sign</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">x</span> <span class="o">=</span> <span class="o">-</span><span class="n">xx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">T24M1</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="o">//</span><span class="n">mtherr</span><span class="p">(</span> <span class="s2">&#34;sinf&#34;</span><span class="p">,</span> <span class="n">TLOSS</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">j</span> <span class="o">=</span> <span class="n">FOPI</span> <span class="o">*</span> <span class="n">x</span><span class="p">;</span> <span class="o">/*</span> <span class="n">integer</span> <span class="n">part</span> <span class="n">of</span> <span class="n">x</span><span class="o">/</span><span class="p">(</span><span class="bp">PI</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">/*</span> <span class="n">map</span> <span class="n">zeros</span> <span class="n">to</span> <span class="n">origin</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">j</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">y</span> <span class="o">+=</span> <span class="mf">1.0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">j</span> <span class="o">&amp;=</span> <span class="mi">7</span><span class="p">;</span> <span class="o">/*</span> <span class="n">octant</span> <span class="n">modulo</span> <span class="mi">360</span> <span class="n">degrees</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">  <span class="o">/*</span> <span class="n">reflect</span> <span class="ow">in</span> <span class="n">x</span> <span class="n">axis</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">j</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nb">sign</span> <span class="o">=</span> <span class="o">-</span><span class="nb">sign</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">j</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">lossth</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="o">//</span><span class="n">mtherr</span><span class="p">(</span> <span class="s2">&#34;sinf&#34;</span><span class="p">,</span> <span class="n">PLOSS</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">y</span> <span class="o">*</span> <span class="n">PIO4F</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="o">/*</span> <span class="n">Extended</span> <span class="n">precision</span> <span class="n">modular</span> <span class="n">arithmetic</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">      <span class="n">x</span> <span class="o">=</span> <span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">y</span> <span class="o">*</span> <span class="n">DP1</span><span class="p">)</span> <span class="o">-</span> <span class="n">y</span> <span class="o">*</span> <span class="n">DP2</span><span class="p">)</span> <span class="o">-</span> <span class="n">y</span> <span class="o">*</span> <span class="n">DP3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="o">/*</span><span class="n">einits</span><span class="p">();</span><span class="o">*/</span>
</span></span><span class="line"><span class="cl">  <span class="n">z</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">//</span><span class="n">printf</span><span class="p">(</span><span class="s2">&#34;my_sinf: corrected oldx, x, y = </span><span class="si">%14.10g</span><span class="s2">, </span><span class="si">%14.10g</span><span class="s2">, </span><span class="si">%14.10g</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">oldx</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">j</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">j</span><span class="o">==</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="o">/*</span> <span class="n">measured</span> <span class="n">relative</span> <span class="n">error</span> <span class="ow">in</span> <span class="o">+/-</span> <span class="n">pi</span><span class="o">/</span><span class="mi">4</span> <span class="n">is</span> <span class="mf">7.8e-8</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">      <span class="o">/*</span>
</span></span><span class="line"><span class="cl">        <span class="n">y</span> <span class="o">=</span> <span class="p">((</span>  <span class="mf">2.443315711809948E-005</span> <span class="o">*</span> <span class="n">z</span>
</span></span><span class="line"><span class="cl">        <span class="o">-</span> <span class="mf">1.388731625493765E-003</span><span class="p">)</span> <span class="o">*</span> <span class="n">z</span>
</span></span><span class="line"><span class="cl">        <span class="o">+</span> <span class="mf">4.166664568298827E-002</span><span class="p">)</span> <span class="o">*</span> <span class="n">z</span> <span class="o">*</span> <span class="n">z</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="o">*/</span>
</span></span><span class="line"><span class="cl">      <span class="n">p</span> <span class="o">=</span> <span class="n">coscof</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">y</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">*</span> <span class="n">z</span> <span class="o">+</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">*</span> <span class="n">z</span> <span class="o">+</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">y</span> <span class="o">*=</span> <span class="n">z</span><span class="p">;</span> <span class="n">y</span> <span class="o">*=</span> <span class="n">z</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">y</span> <span class="o">-=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">z</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">y</span> <span class="o">+=</span> <span class="mf">1.0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="o">/*</span> <span class="n">Theoretical</span> <span class="n">relative</span> <span class="n">error</span> <span class="o">=</span> <span class="mf">3.8e-9</span> <span class="ow">in</span> <span class="p">[</span><span class="o">-</span><span class="n">pi</span><span class="o">/</span><span class="mi">4</span><span class="p">,</span> <span class="o">+</span><span class="n">pi</span><span class="o">/</span><span class="mi">4</span><span class="p">]</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">      <span class="o">/*</span>
</span></span><span class="line"><span class="cl">        <span class="n">y</span> <span class="o">=</span> <span class="p">((</span><span class="o">-</span><span class="mf">1.9515295891E-4</span> <span class="o">*</span> <span class="n">z</span>
</span></span><span class="line"><span class="cl">        <span class="o">+</span> <span class="mf">8.3321608736E-3</span><span class="p">)</span> <span class="o">*</span> <span class="n">z</span>
</span></span><span class="line"><span class="cl">        <span class="o">-</span> <span class="mf">1.6666654611E-1</span><span class="p">)</span> <span class="o">*</span> <span class="n">z</span> <span class="o">*</span> <span class="n">x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">y</span> <span class="o">+=</span> <span class="n">x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="o">*/</span>
</span></span><span class="line"><span class="cl">      <span class="n">p</span> <span class="o">=</span> <span class="n">sincof</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">y</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">*</span> <span class="n">z</span> <span class="o">+</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">*</span> <span class="n">z</span> <span class="o">+</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">y</span> <span class="o">*=</span> <span class="n">z</span><span class="p">;</span> <span class="n">y</span> <span class="o">*=</span> <span class="n">x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">y</span> <span class="o">+=</span> <span class="n">x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="o">/*</span><span class="n">einitd</span><span class="p">();</span><span class="o">*/</span>
</span></span><span class="line"><span class="cl">  <span class="o">//</span><span class="n">printf</span><span class="p">(</span><span class="s2">&#34;my_sinf: j=</span><span class="si">%d</span><span class="s2"> result = </span><span class="si">%14.10g</span><span class="s2"> * </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="nb">sign</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span><span class="nb">sign</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">y</span> <span class="o">=</span> <span class="o">-</span><span class="n">y</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span><span class="p">(</span> <span class="n">y</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">/*</span> <span class="n">Single</span> <span class="n">precision</span> <span class="n">circular</span> <span class="n">cosine</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">test</span> <span class="n">interval</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="n">pi</span><span class="o">/</span><span class="mi">4</span><span class="p">,</span> <span class="o">+</span><span class="n">pi</span><span class="o">/</span><span class="mi">4</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">trials</span><span class="p">:</span> <span class="mi">10000</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">peak</span> <span class="n">relative</span> <span class="n">error</span><span class="p">:</span> <span class="mf">8.3e-8</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">rms</span> <span class="n">relative</span> <span class="n">error</span><span class="p">:</span> <span class="mf">2.2e-8</span>
</span></span><span class="line"><span class="cl"> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="ne">float</span> <span class="n">cephes_cosf</span><span class="p">(</span> <span class="ne">float</span> <span class="n">xx</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="ne">float</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="ne">int</span> <span class="n">j</span><span class="p">,</span> <span class="nb">sign</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="o">/*</span> <span class="n">make</span> <span class="n">argument</span> <span class="n">positive</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">  <span class="nb">sign</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">x</span> <span class="o">=</span> <span class="n">xx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">x</span> <span class="o">=</span> <span class="o">-</span><span class="n">x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">T24M1</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="o">//</span><span class="n">mtherr</span><span class="p">(</span> <span class="s2">&#34;cosf&#34;</span><span class="p">,</span> <span class="n">TLOSS</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">j</span> <span class="o">=</span> <span class="n">FOPI</span> <span class="o">*</span> <span class="n">x</span><span class="p">;</span> <span class="o">/*</span> <span class="n">integer</span> <span class="n">part</span> <span class="n">of</span> <span class="n">x</span><span class="o">/</span><span class="n">PIO4</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">/*</span> <span class="n">integer</span> <span class="ow">and</span> <span class="n">fractional</span> <span class="n">part</span> <span class="n">modulo</span> <span class="n">one</span> <span class="n">octant</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">j</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="p">)</span>	<span class="o">/*</span> <span class="n">map</span> <span class="n">zeros</span> <span class="n">to</span> <span class="n">origin</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">y</span> <span class="o">+=</span> <span class="mf">1.0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">j</span> <span class="o">&amp;=</span> <span class="mi">7</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">j</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">j</span> <span class="o">-=</span><span class="mi">4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="nb">sign</span> <span class="o">=</span> <span class="o">-</span><span class="nb">sign</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">j</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">sign</span> <span class="o">=</span> <span class="o">-</span><span class="nb">sign</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">lossth</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="o">//</span><span class="n">mtherr</span><span class="p">(</span> <span class="s2">&#34;cosf&#34;</span><span class="p">,</span> <span class="n">PLOSS</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">y</span> <span class="o">*</span> <span class="n">PIO4F</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="o">/*</span> <span class="n">Extended</span> <span class="n">precision</span> <span class="n">modular</span> <span class="n">arithmetic</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">    <span class="n">x</span> <span class="o">=</span> <span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">y</span> <span class="o">*</span> <span class="n">DP1</span><span class="p">)</span> <span class="o">-</span> <span class="n">y</span> <span class="o">*</span> <span class="n">DP2</span><span class="p">)</span> <span class="o">-</span> <span class="n">y</span> <span class="o">*</span> <span class="n">DP3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="o">//</span><span class="n">printf</span><span class="p">(</span><span class="s2">&#34;xx = </span><span class="si">%g</span><span class="s2"> -&gt; x corrected = </span><span class="si">%g</span><span class="s2"> sign=</span><span class="si">%d</span><span class="s2"> j=</span><span class="si">%d</span><span class="s2"> y=</span><span class="si">%g</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="nb">sign</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">z</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">j</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">j</span><span class="o">==</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">y</span> <span class="o">=</span> <span class="p">(((</span><span class="o">-</span><span class="mf">1.9515295891E-4</span><span class="n">f</span> <span class="o">*</span> <span class="n">z</span>
</span></span><span class="line"><span class="cl">             <span class="o">+</span> <span class="mf">8.3321608736E-3</span><span class="n">f</span><span class="p">)</span> <span class="o">*</span> <span class="n">z</span>
</span></span><span class="line"><span class="cl">            <span class="o">-</span> <span class="mf">1.6666654611E-1</span><span class="n">f</span><span class="p">)</span> <span class="o">*</span> <span class="n">z</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">+</span> <span class="n">x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">y</span> <span class="o">=</span> <span class="p">((</span>  <span class="mf">2.443315711809948E-005</span><span class="n">f</span> <span class="o">*</span> <span class="n">z</span>
</span></span><span class="line"><span class="cl">              <span class="o">-</span> <span class="mf">1.388731625493765E-003</span><span class="n">f</span><span class="p">)</span> <span class="o">*</span> <span class="n">z</span>
</span></span><span class="line"><span class="cl">           <span class="o">+</span> <span class="mf">4.166664568298827E-002</span><span class="n">f</span><span class="p">)</span> <span class="o">*</span> <span class="n">z</span> <span class="o">*</span> <span class="n">z</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">y</span> <span class="o">-=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">z</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">y</span> <span class="o">+=</span> <span class="mf">1.0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span><span class="nb">sign</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">y</span> <span class="o">=</span> <span class="o">-</span><span class="n">y</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span><span class="p">(</span> <span class="n">y</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">/*</span>							<span class="n">expf</span><span class="o">.</span><span class="n">c</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>	<span class="n">Exponential</span> <span class="n">function</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">SYNOPSIS</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="ne">float</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">expf</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">y</span> <span class="o">=</span> <span class="n">expf</span><span class="p">(</span> <span class="n">x</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">DESCRIPTION</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">Returns</span> <span class="n">e</span> <span class="p">(</span><span class="mf">2.71828</span><span class="o">...</span><span class="p">)</span> <span class="n">raised</span> <span class="n">to</span> <span class="n">the</span> <span class="n">x</span> <span class="n">power</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="ne">Range</span> <span class="n">reduction</span> <span class="n">is</span> <span class="n">accomplished</span> <span class="n">by</span> <span class="n">separating</span> <span class="n">the</span> <span class="n">argument</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">into</span> <span class="n">an</span> <span class="n">integer</span> <span class="n">k</span> <span class="ow">and</span> <span class="n">fraction</span> <span class="n">f</span> <span class="n">such</span> <span class="n">that</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>     <span class="n">x</span>    <span class="n">k</span>  <span class="n">f</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>    <span class="n">e</span>  <span class="o">=</span> <span class="mi">2</span>  <span class="n">e</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">A</span> <span class="n">polynomial</span> <span class="n">is</span> <span class="n">used</span> <span class="n">to</span> <span class="n">approximate</span> <span class="nb">exp</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">basic</span> <span class="nb">range</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">ACCURACY</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>                      <span class="n">Relative</span> <span class="n">error</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">arithmetic</span>   <span class="n">domain</span>     <span class="c1"># trials      peak         rms</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>    <span class="n">IEEE</span>      <span class="o">+-</span> <span class="n">MAXLOG</span>   <span class="mi">100000</span>      <span class="mf">1.7e-7</span>      <span class="mf">2.8e-8</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">Error</span> <span class="n">amplification</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">exponential</span> <span class="n">function</span> <span class="n">can</span> <span class="n">be</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">a</span> <span class="n">serious</span> <span class="n">matter</span><span class="o">.</span>  <span class="n">The</span> <span class="n">error</span> <span class="n">propagation</span> <span class="n">involves</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="nb">exp</span><span class="p">(</span> <span class="n">X</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">delta</span><span class="p">)</span> <span class="p">)</span> <span class="o">=</span> <span class="nb">exp</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="p">(</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">X</span><span class="o">*</span><span class="n">delta</span> <span class="o">+</span> <span class="o">...</span> <span class="p">),</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">which</span> <span class="n">shows</span> <span class="n">that</span> <span class="n">a</span> <span class="mi">1</span> <span class="n">lsb</span> <span class="n">error</span> <span class="ow">in</span> <span class="n">representing</span> <span class="n">X</span> <span class="n">produces</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">a</span> <span class="n">relative</span> <span class="n">error</span> <span class="n">of</span> <span class="n">X</span> <span class="n">times</span> <span class="mi">1</span> <span class="n">lsb</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">function</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">While</span> <span class="n">the</span> <span class="n">routine</span> <span class="n">gives</span> <span class="n">an</span> <span class="n">accurate</span> <span class="n">result</span> <span class="k">for</span> <span class="n">arguments</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">that</span> <span class="n">are</span> <span class="n">exactly</span> <span class="n">represented</span> <span class="n">by</span> <span class="n">a</span> <span class="n">double</span> <span class="n">precision</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">computer</span> <span class="n">number</span><span class="p">,</span> <span class="n">the</span> <span class="n">result</span> <span class="n">contains</span> <span class="n">amplified</span> <span class="n">roundoff</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">error</span> <span class="k">for</span> <span class="n">large</span> <span class="n">arguments</span> <span class="ow">not</span> <span class="n">exactly</span> <span class="n">represented</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">ERROR</span> <span class="n">MESSAGES</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>   <span class="n">message</span>         <span class="n">condition</span>      <span class="n">value</span> <span class="n">returned</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">expf</span> <span class="n">underflow</span>    <span class="n">x</span> <span class="o">&lt;</span> <span class="n">MINLOGF</span>         <span class="mf">0.0</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">expf</span> <span class="n">overflow</span>     <span class="n">x</span> <span class="o">&gt;</span> <span class="n">MAXLOGF</span>         <span class="n">MAXNUMF</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">/*</span>
</span></span><span class="line"><span class="cl"><span class="n">Cephes</span> <span class="n">Math</span> <span class="n">Library</span> <span class="n">Release</span> <span class="mf">2.2</span><span class="p">:</span>  <span class="n">June</span><span class="p">,</span> <span class="mi">1992</span>
</span></span><span class="line"><span class="cl"><span class="n">Copyright</span> <span class="mi">1984</span><span class="p">,</span> <span class="mi">1987</span><span class="p">,</span> <span class="mi">1989</span> <span class="n">by</span> <span class="n">Stephen</span> <span class="n">L</span><span class="o">.</span> <span class="n">Moshier</span>
</span></span><span class="line"><span class="cl"><span class="n">Direct</span> <span class="n">inquiries</span> <span class="n">to</span> <span class="mi">30</span> <span class="n">Frost</span> <span class="n">Street</span><span class="p">,</span> <span class="n">Cambridge</span><span class="p">,</span> <span class="n">MA</span> <span class="mi">02140</span>
</span></span><span class="line"><span class="cl"><span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">/*</span> <span class="n">Single</span> <span class="n">precision</span> <span class="n">exponential</span> <span class="n">function</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">test</span> <span class="n">interval</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">+</span><span class="mf">0.5</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">trials</span><span class="p">:</span> <span class="mi">80000</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">peak</span> <span class="n">relative</span> <span class="n">error</span><span class="p">:</span> <span class="mf">7.6e-8</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">rms</span> <span class="n">relative</span> <span class="n">error</span><span class="p">:</span> <span class="mf">2.8e-8</span>
</span></span><span class="line"><span class="cl"> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="ne">float</span> <span class="n">MAXNUMF</span> <span class="o">=</span> <span class="mf">3.4028234663852885981170418348451692544e38</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="ne">float</span> <span class="n">MAXLOGF</span> <span class="o">=</span> <span class="mf">88.72283905206835</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="ne">float</span> <span class="n">MINLOGF</span> <span class="o">=</span> <span class="o">-</span><span class="mf">103.278929903431851103</span><span class="p">;</span> <span class="o">/*</span> <span class="nb">log</span><span class="p">(</span><span class="mi">2</span><span class="o">^-</span><span class="mi">149</span><span class="p">)</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="ne">float</span> <span class="n">LOG2EF</span> <span class="o">=</span> <span class="mf">1.44269504088896341</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="ne">float</span> <span class="n">C1</span> <span class="o">=</span>   <span class="mf">0.693359375</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="ne">float</span> <span class="n">C2</span> <span class="o">=</span>  <span class="o">-</span><span class="mf">2.12194440e-4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="ne">float</span> <span class="n">cephes_expf</span><span class="p">(</span><span class="ne">float</span> <span class="n">xx</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="ne">float</span> <span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="ne">int</span> <span class="n">n</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">x</span> <span class="o">=</span> <span class="n">xx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span><span class="p">(</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">MAXLOGF</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span><span class="n">mtherr</span><span class="p">(</span> <span class="s2">&#34;expf&#34;</span><span class="p">,</span> <span class="n">OVERFLOW</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span><span class="p">(</span> <span class="n">MAXNUMF</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span><span class="p">(</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">MINLOGF</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span><span class="n">mtherr</span><span class="p">(</span> <span class="s2">&#34;expf&#34;</span><span class="p">,</span> <span class="n">UNDERFLOW</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">/*</span> <span class="n">Express</span> <span class="n">e</span><span class="o">**</span><span class="n">x</span> <span class="o">=</span> <span class="n">e</span><span class="o">**</span><span class="n">g</span> <span class="mi">2</span><span class="o">**</span><span class="n">n</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>   <span class="o">=</span> <span class="n">e</span><span class="o">**</span><span class="n">g</span> <span class="n">e</span><span class="o">**</span><span class="p">(</span> <span class="n">n</span> <span class="n">loge</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>   <span class="o">=</span> <span class="n">e</span><span class="o">**</span><span class="p">(</span> <span class="n">g</span> <span class="o">+</span> <span class="n">n</span> <span class="n">loge</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="o">*/</span>
</span></span><span class="line"><span class="cl"><span class="n">z</span> <span class="o">=</span> <span class="n">floorf</span><span class="p">(</span> <span class="n">LOG2EF</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="p">);</span> <span class="o">/*</span> <span class="nb">floor</span><span class="p">()</span> <span class="n">truncates</span> <span class="n">toward</span> <span class="o">-</span><span class="n">infinity</span><span class="o">.</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">x</span> <span class="o">-=</span> <span class="n">z</span> <span class="o">*</span> <span class="n">C1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">x</span> <span class="o">-=</span> <span class="n">z</span> <span class="o">*</span> <span class="n">C2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">n</span> <span class="o">=</span> <span class="n">z</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">z</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">/*</span> <span class="n">Theoretical</span> <span class="n">peak</span> <span class="n">relative</span> <span class="n">error</span> <span class="ow">in</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">+</span><span class="mf">0.5</span><span class="p">]</span> <span class="n">is</span> <span class="mf">4.2e-9</span><span class="o">.</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl"><span class="n">z</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl"><span class="p">(((((</span> <span class="mf">1.9875691500E-4</span><span class="n">f</span>  <span class="o">*</span> <span class="n">x</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span> <span class="mf">1.3981999507E-3</span><span class="n">f</span><span class="p">)</span> <span class="o">*</span> <span class="n">x</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span> <span class="mf">8.3334519073E-3</span><span class="n">f</span><span class="p">)</span> <span class="o">*</span> <span class="n">x</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span> <span class="mf">4.1665795894E-2</span><span class="n">f</span><span class="p">)</span> <span class="o">*</span> <span class="n">x</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span> <span class="mf">1.6666665459E-1</span><span class="n">f</span><span class="p">)</span> <span class="o">*</span> <span class="n">x</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span> <span class="mf">5.0000001201E-1</span><span class="n">f</span><span class="p">)</span> <span class="o">*</span> <span class="n">z</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span> <span class="n">x</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span> <span class="mf">1.0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">/*</span> <span class="n">multiply</span> <span class="n">by</span> <span class="n">power</span> <span class="n">of</span> <span class="mi">2</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl"><span class="n">x</span> <span class="o">=</span> <span class="n">ldexpf</span><span class="p">(</span> <span class="n">z</span><span class="p">,</span> <span class="n">n</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">return</span><span class="p">(</span> <span class="n">x</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">/*</span>							<span class="n">logf</span><span class="o">.</span><span class="n">c</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>	<span class="n">Natural</span> <span class="n">logarithm</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">SYNOPSIS</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="ne">float</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">logf</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">y</span> <span class="o">=</span> <span class="n">logf</span><span class="p">(</span> <span class="n">x</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">DESCRIPTION</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">Returns</span> <span class="n">the</span> <span class="n">base</span> <span class="n">e</span> <span class="p">(</span><span class="mf">2.718</span><span class="o">...</span><span class="p">)</span> <span class="n">logarithm</span> <span class="n">of</span> <span class="n">x</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">The</span> <span class="n">argument</span> <span class="n">is</span> <span class="n">separated</span> <span class="n">into</span> <span class="n">its</span> <span class="n">exponent</span> <span class="ow">and</span> <span class="n">fractional</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">parts</span><span class="o">.</span>  <span class="n">If</span> <span class="n">the</span> <span class="n">exponent</span> <span class="n">is</span> <span class="n">between</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">the</span> <span class="n">logarithm</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">of</span> <span class="n">the</span> <span class="n">fraction</span> <span class="n">is</span> <span class="n">approximated</span> <span class="n">by</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>     <span class="nb">log</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">x</span><span class="p">)</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">x</span><span class="o">**</span><span class="mi">3</span> <span class="n">P</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">ACCURACY</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>                      <span class="n">Relative</span> <span class="n">error</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">arithmetic</span>   <span class="n">domain</span>     <span class="c1"># trials      peak         rms</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>    <span class="n">IEEE</span>      <span class="mf">0.5</span><span class="p">,</span> <span class="mf">2.0</span>    <span class="mi">100000</span>       <span class="mf">7.6e-8</span>     <span class="mf">2.7e-8</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>    <span class="n">IEEE</span>      <span class="mi">1</span><span class="p">,</span> <span class="n">MAXNUMF</span>  <span class="mi">100000</span>                  <span class="mf">2.6e-8</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">In</span> <span class="n">the</span> <span class="n">tests</span> <span class="n">over</span> <span class="n">the</span> <span class="n">interval</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">MAXNUM</span><span class="p">],</span> <span class="n">the</span> <span class="n">logarithms</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">of</span> <span class="n">the</span> <span class="n">random</span> <span class="n">arguments</span> <span class="n">were</span> <span class="n">uniformly</span> <span class="n">distributed</span> <span class="n">over</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">MAXLOGF</span><span class="p">]</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">ERROR</span> <span class="n">MESSAGES</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">logf</span> <span class="n">singularity</span><span class="p">:</span>  <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">returns</span> <span class="n">MINLOG</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">logf</span> <span class="n">domain</span><span class="p">:</span>       <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">returns</span> <span class="n">MINLOG</span>
</span></span><span class="line"><span class="cl"> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">/*</span>
</span></span><span class="line"><span class="cl"><span class="n">Cephes</span> <span class="n">Math</span> <span class="n">Library</span> <span class="n">Release</span> <span class="mf">2.2</span><span class="p">:</span>  <span class="n">June</span><span class="p">,</span> <span class="mi">1992</span>
</span></span><span class="line"><span class="cl"><span class="n">Copyright</span> <span class="mi">1984</span><span class="p">,</span> <span class="mi">1987</span><span class="p">,</span> <span class="mi">1988</span><span class="p">,</span> <span class="mi">1992</span> <span class="n">by</span> <span class="n">Stephen</span> <span class="n">L</span><span class="o">.</span> <span class="n">Moshier</span>
</span></span><span class="line"><span class="cl"><span class="n">Direct</span> <span class="n">inquiries</span> <span class="n">to</span> <span class="mi">30</span> <span class="n">Frost</span> <span class="n">Street</span><span class="p">,</span> <span class="n">Cambridge</span><span class="p">,</span> <span class="n">MA</span> <span class="mi">02140</span>
</span></span><span class="line"><span class="cl"><span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">/*</span> <span class="n">Single</span> <span class="n">precision</span> <span class="n">natural</span> <span class="n">logarithm</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">test</span> <span class="n">interval</span><span class="p">:</span> <span class="p">[</span><span class="nb">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="nb">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">trials</span><span class="p">:</span> <span class="mi">10000</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">peak</span> <span class="n">relative</span> <span class="n">error</span><span class="p">:</span> <span class="mf">7.1e-8</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">rms</span> <span class="n">relative</span> <span class="n">error</span><span class="p">:</span> <span class="mf">2.7e-8</span>
</span></span><span class="line"><span class="cl"> <span class="o">*/</span>
</span></span><span class="line"><span class="cl"><span class="ne">float</span> <span class="n">LOGE2F</span> <span class="o">=</span> <span class="mf">0.693147180559945309</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="ne">float</span> <span class="n">SQRTHF</span> <span class="o">=</span> <span class="mf">0.707106781186547524</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="ne">float</span> <span class="n">PIF</span> <span class="o">=</span> <span class="mf">3.141592653589793238</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="ne">float</span> <span class="n">PIO2F</span> <span class="o">=</span> <span class="mf">1.5707963267948966192</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="ne">float</span> <span class="n">MACHEPF</span> <span class="o">=</span> <span class="mf">5.9604644775390625E-8</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="ne">float</span> <span class="n">cephes_logf</span><span class="p">(</span> <span class="ne">float</span> <span class="n">xx</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="n">register</span> <span class="ne">float</span> <span class="n">y</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="ne">float</span> <span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">fe</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="ne">int</span> <span class="n">e</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">x</span> <span class="o">=</span> <span class="n">xx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">fe</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">/*</span> <span class="n">Test</span> <span class="k">for</span> <span class="n">domain</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span><span class="p">(</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="mf">0.0</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span> <span class="n">ERROR</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">(</span> <span class="n">MINLOGF</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">x</span> <span class="o">=</span> <span class="n">frexpf</span><span class="p">(</span> <span class="n">x</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="n">printf</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">my_logf: frexp -&gt; e = </span><span class="si">%d</span><span class="s2"> x = </span><span class="si">%g</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span><span class="p">(</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">SQRTHF</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">e</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">x</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">;</span> <span class="o">/*</span>  <span class="mi">2</span><span class="n">x</span> <span class="o">-</span> <span class="mi">1</span>  <span class="o">*/</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>	
</span></span><span class="line"><span class="cl"><span class="k">else</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">z</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">/*</span> <span class="mf">3.4e-9</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl"><span class="o">/*</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span> <span class="o">=</span> <span class="n">logfcof</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">y</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">*</span> <span class="n">x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span><span class="p">(</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">y</span> <span class="o">+=</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">y</span> <span class="o">*=</span> <span class="n">x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">y</span> <span class="o">*=</span> <span class="n">z</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">y</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl"><span class="p">((((((((</span> <span class="mf">7.0376836292E-2</span><span class="n">f</span> <span class="o">*</span> <span class="n">x</span>
</span></span><span class="line"><span class="cl"><span class="o">-</span> <span class="mf">1.1514610310E-1</span><span class="n">f</span><span class="p">)</span> <span class="o">*</span> <span class="n">x</span>
</span></span><span class="line"><span class="cl"><span class="o">+</span> <span class="mf">1.1676998740E-1</span><span class="n">f</span><span class="p">)</span> <span class="o">*</span> <span class="n">x</span>
</span></span><span class="line"><span class="cl"><span class="o">-</span> <span class="mf">1.2420140846E-1</span><span class="n">f</span><span class="p">)</span> <span class="o">*</span> <span class="n">x</span>
</span></span><span class="line"><span class="cl"><span class="o">+</span> <span class="mf">1.4249322787E-1</span><span class="n">f</span><span class="p">)</span> <span class="o">*</span> <span class="n">x</span>
</span></span><span class="line"><span class="cl"><span class="o">-</span> <span class="mf">1.6668057665E-1</span><span class="n">f</span><span class="p">)</span> <span class="o">*</span> <span class="n">x</span>
</span></span><span class="line"><span class="cl"><span class="o">+</span> <span class="mf">2.0000714765E-1</span><span class="n">f</span><span class="p">)</span> <span class="o">*</span> <span class="n">x</span>
</span></span><span class="line"><span class="cl"><span class="o">-</span> <span class="mf">2.4999993993E-1</span><span class="n">f</span><span class="p">)</span> <span class="o">*</span> <span class="n">x</span>
</span></span><span class="line"><span class="cl"><span class="o">+</span> <span class="mf">3.3333331174E-1</span><span class="n">f</span><span class="p">)</span> <span class="o">*</span> <span class="n">x</span> <span class="o">*</span> <span class="n">z</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="n">printf</span><span class="p">(</span><span class="s2">&#34;my_logf: poly = </span><span class="si">%g</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span><span class="p">(</span> <span class="n">e</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">fe</span> <span class="o">=</span> <span class="n">e</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">y</span> <span class="o">+=</span> <span class="o">-</span><span class="mf">2.12194440e-4</span><span class="n">f</span> <span class="o">*</span> <span class="n">fe</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">y</span> <span class="o">+=</span>  <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">z</span><span class="p">;</span>  <span class="o">/*</span> <span class="n">y</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="n">x</span><span class="o">^</span><span class="mi">2</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="n">printf</span><span class="p">(</span><span class="s2">&#34;my_logf: x = </span><span class="si">%g</span><span class="s2"> y = </span><span class="si">%g</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">z</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">;</span>   <span class="o">/*</span> <span class="o">...</span> <span class="o">+</span> <span class="n">x</span>  <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span><span class="p">(</span> <span class="n">e</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">z</span> <span class="o">+=</span> <span class="mf">0.693359375</span><span class="n">f</span> <span class="o">*</span> <span class="n">fe</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">return</span><span class="p">(</span> <span class="n">z</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div></div></div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2013-10-13</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Share on X" data-sharer="x" data-url="https://lucaji.github.io/theremin/" data-title="Theremin" data-hashtags="Arduino,Audio"><i class="fab fa-x-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Threads" data-sharer="threads" data-url="https://lucaji.github.io/theremin/" data-title="Theremin"><i class="fab fa-threads fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="https://lucaji.github.io/theremin/" data-hashtag="Arduino"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Linkedin" data-sharer="linkedin" data-url="https://lucaji.github.io/theremin/"><i class="fab fa-linkedin fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Reddit" data-sharer="reddit" data-url="https://lucaji.github.io/theremin/"><i class="fab fa-reddit fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Line" data-sharer="line" data-url="https://lucaji.github.io/theremin/" data-title="Theremin"><i data-svg-src="https://cdn.jsdelivr.net/npm/simple-icons@14.9.0/icons/line.svg" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on 微博" data-sharer="weibo" data-url="https://lucaji.github.io/theremin/" data-title="Theremin"><i class="fab fa-weibo fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Diaspora" data-sharer="diaspora" data-url="https://lucaji.github.io/theremin/" data-title="Theremin" data-description=""><i class="fab fa-diaspora fa-fw" aria-hidden="true"></i></a><a href="https://t.me/share/url?url=https%3a%2f%2flucaji.github.io%2ftheremin%2f&amp;text=Theremin" target="_blank" title="Share on Telegram"><i class="fab fa-telegram fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i><a href="/tags/arduino/">Arduino</a>, <a href="/tags/audio/">Audio</a></section>
        <section class="post-back">
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/lorena-fontana-a-vision/" class="prev" rel="prev" title="Lorena Fontana - A Vision - Making of"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>Lorena Fontana - A Vision - Making of</a>
            <a href="/back-to-the-future-clock-replica/" class="next" rel="next" title="DeLorean Time Circuits">DeLorean Time Circuits<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</div><div id="comments"><div id="utterances" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://utteranc.es/">utterances</a>.
            </noscript></div></article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2013 - 2025</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://lucaji.github.io" target="_blank">Luca Cipressi</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a>
        </div>

        <div id="fixed-buttons-hidden"><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@2.7.0/css/lightgallery-bundle.min.css"><script src="https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js"></script><script src="https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js"></script><script src="https://cdn.jsdelivr.net/npm/lightgallery@2.7.0/lightgallery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/lightgallery@2.7.0/plugins/thumbnail/lg-thumbnail.min.js"></script><script src="https://cdn.jsdelivr.net/npm/lightgallery@2.7.0/plugins/zoom/lg-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js"></script><script src="https://cdn.jsdelivr.net/npm/sharer.js@0.5.2/sharer.min.js"></script><script>window.config={"comment":{"utterances":{"darkTheme":"github-dark","issueTerm":"pathname","label":"","lightTheme":"github-light","repo":"lucaji/lucaji.github.io"}},"lightgallery":true,"search":{"highlightTag":"em","lunrIndexURL":"/index.json","maxResultLength":10,"noResultsFound":"No results found","snippetLength":30,"type":"lunr"}};</script><script src="/js/theme.min.js"></script></body>
</html>
